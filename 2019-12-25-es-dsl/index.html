<!DOCTYPE html><html lang="en"><head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="前记由于公司内部的研发团队越来越多的接触到复杂的查询需求，也越来越多的依赖大数据部门提供的es搜索引擎提供查询服务 特此整理一些es常用的查询语句用于培训 数据初始化和准备工作es和kibana安装可以从 https://github.com/leriou/docker-env/tree/master/elasticsearch 直接使用docker编排文件构建基于docker的es本地服务 do">
<meta name="keywords" content="Elasticsearch">
<meta property="og:type" content="article">
<meta property="og:title" content="Elasticsearch中的常用查询语句示例">
<meta property="og:url" content="https://leriou.github.io/2019-12-25-es-dsl/index.html">
<meta property="og:site_name" content="Leriou's Tavern">
<meta property="og:description" content="前记由于公司内部的研发团队越来越多的接触到复杂的查询需求，也越来越多的依赖大数据部门提供的es搜索引擎提供查询服务 特此整理一些es常用的查询语句用于培训 数据初始化和准备工作es和kibana安装可以从 https://github.com/leriou/docker-env/tree/master/elasticsearch 直接使用docker编排文件构建基于docker的es本地服务 do">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-04-10T15:33:23.847Z">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Elasticsearch中的常用查询语句示例</title>
    <!-- styles -->
    
    <!-- persian styles -->
    
      
    
    <!-- rss -->
    
    
<script>function loadCss(l){var d=document,h=d.head,s=d.createElement('link');s.rel='stylesheet';s.href=l;!function e(f){if (d.body)return f();setTimeout(function(){e(f)})}(function(){h.appendChild(s);});}loadCss('/style.css');</script></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020-01-01-record/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019-06-01-recommended-system-ranking-system-md/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://leriou.github.io/2019-12-25-es-dsl/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;text=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;title=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;is_video=false&amp;description=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Elasticsearch中的常用查询语句示例&amp;body=Check out this article: https://leriou.github.io/2019-12-25-es-dsl/" target="_blank" rel="noopener"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;title=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;title=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;title=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;title=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;name=Elasticsearch中的常用查询语句示例&amp;description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://leriou.github.io/2019-12-25-es-dsl/&amp;t=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前记"><span class="toc-number">1.</span> <span class="toc-text">前记</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#数据初始化和准备工作"><span class="toc-number">2.</span> <span class="toc-text">数据初始化和准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#es和kibana安装"><span class="toc-number">2.1.</span> <span class="toc-text">es和kibana安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#准备测试数据"><span class="toc-number">2.2.</span> <span class="toc-text">准备测试数据</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#简单查询示范"><span class="toc-number">3.</span> <span class="toc-text">简单查询示范</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#n对n查询"><span class="toc-number">3.1.</span> <span class="toc-text">n对n查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#万能匹配-match"><span class="toc-number">3.2.</span> <span class="toc-text">万能匹配-match</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他常用查询（range-exist-a-and-b等）"><span class="toc-number">3.3.</span> <span class="toc-text">其他常用查询（range, exist, a and b等）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询原理解析"><span class="toc-number">3.4.</span> <span class="toc-text">查询原理解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#es文档字段的存储逻辑"><span class="toc-number">3.4.1.</span> <span class="toc-text">es文档字段的存储逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#match为什么可以做到万能查询"><span class="toc-number">3.4.2.</span> <span class="toc-text">match为什么可以做到万能查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#分值相关查询"><span class="toc-number">4.</span> <span class="toc-text">分值相关查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#filter过滤"><span class="toc-number">4.1.</span> <span class="toc-text">filter过滤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#constant-score和boost提权"><span class="toc-number">4.2.</span> <span class="toc-text">constant_score和boost提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#function-score"><span class="toc-number">4.3.</span> <span class="toc-text">function_score</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询示例：根据用户关注的标签匹配数量计算得分"><span class="toc-number">4.4.</span> <span class="toc-text">查询示例：根据用户关注的标签匹配数量计算得分</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#聚合查询"><span class="toc-number">5.</span> <span class="toc-text">聚合查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#terms求count值"><span class="toc-number">5.1.</span> <span class="toc-text">terms求count值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#avg求平均值"><span class="toc-number">5.2.</span> <span class="toc-text">avg求平均值</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#其他查询和dsl"><span class="toc-number">6.</span> <span class="toc-text">其他查询和dsl</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#原子更新文档"><span class="toc-number">6.1.</span> <span class="toc-text">原子更新文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#explain"><span class="toc-number">6.2.</span> <span class="toc-text">explain</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Elasticsearch中的常用查询语句示例
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">Leriou's Tavern</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-12-24T16:00:00.000Z" itemprop="datePublished">2019-12-25</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E7%BC%96%E7%A8%8B%E5%B7%A5%E5%85%B7/">编程工具</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Elasticsearch/" rel="tag">Elasticsearch</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="前记"><a href="#前记" class="headerlink" title="前记"></a>前记</h1><p>由于公司内部的研发团队越来越多的接触到复杂的查询需求，也越来越多的依赖大数据部门提供的es搜索引擎提供查询服务</p>
<p>特此整理一些es常用的查询语句用于培训</p>
<h1 id="数据初始化和准备工作"><a href="#数据初始化和准备工作" class="headerlink" title="数据初始化和准备工作"></a>数据初始化和准备工作</h1><h2 id="es和kibana安装"><a href="#es和kibana安装" class="headerlink" title="es和kibana安装"></a>es和kibana安装</h2><p>可以从 <a href="https://github.com/leriou/docker-env/tree/master/elasticsearch" target="_blank" rel="noopener">https://github.com/leriou/docker-env/tree/master/elasticsearch</a></p>
<p>直接使用docker编排文件构建基于docker的es本地服务</p>
<p><code>docker-compose up -d</code> 启动服务,启动成功访问kibana命令控制台</p>
<p>es: elasticsearch 实例，主要存储和搜索引擎<br>kibana： elasticsearch的一个web层GUI客户端，可以方便的查询es里面的数据，这些年用了一大堆各种各样的第三方GUI，用来用去还是kibana最方便</p>
<h2 id="准备测试数据"><a href="#准备测试数据" class="headerlink" title="准备测试数据"></a>准备测试数据</h2><p>先准备一部分数据用于演示</p>
<p>创建测试用的索引<code>put test_idx</code></p>
<p>创建测试文档</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">put test_idx/_doc/1</span><br><span class="line">{</span><br><span class="line">	"name":"111",</span><br><span class="line">	"tags":["a","c","d"]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>以下是用于示范的数据文档</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">      {</span><br><span class="line">        "_index": "test_idx",</span><br><span class="line">        "_type": "_doc",</span><br><span class="line">        "_id": "8",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": {</span><br><span class="line">          "name": "a888",</span><br><span class="line">          "tags": [</span><br><span class="line">            "ab"</span><br><span class="line">          ],</span><br><span class="line">          "age": 7,</span><br><span class="line">          "content": "明天"</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index": "test_idx",</span><br><span class="line">        "_type": "_doc",</span><br><span class="line">        "_id": "2",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": {</span><br><span class="line">          "name": "222",</span><br><span class="line">          "tags": [</span><br><span class="line">            "a"</span><br><span class="line">          ],</span><br><span class="line">          "age": 18</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index": "test_idx",</span><br><span class="line">        "_type": "_doc",</span><br><span class="line">        "_id": "4",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": {</span><br><span class="line">          "name": "444",</span><br><span class="line">          "tags": [</span><br><span class="line">            "d",</span><br><span class="line">            "i"</span><br><span class="line">          ],</span><br><span class="line">          "age": 0,</span><br><span class="line">          "content": "明天北京的天气很好，是个大晴天 "</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index": "test_idx",</span><br><span class="line">        "_type": "_doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": {</span><br><span class="line">          "name": "111",</span><br><span class="line">          "tags": [</span><br><span class="line">            "a",</span><br><span class="line">            "c",</span><br><span class="line">            "d"</span><br><span class="line">          ]</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      {</span><br><span class="line">        "_index": "test_idx",</span><br><span class="line">        "_type": "_doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": {</span><br><span class="line">          "name": "333",</span><br><span class="line">          "tags": [</span><br><span class="line">            "e",</span><br><span class="line">            "f"</span><br><span class="line">          ],</span><br><span class="line">          "age": 18,</span><br><span class="line">          "content": "明天上海的天气不好，有小雨"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    ]</span><br></pre></td></tr></tbody></table></figure>

<h1 id="简单查询示范"><a href="#简单查询示范" class="headerlink" title="简单查询示范"></a>简单查询示范</h1><h2 id="n对n查询"><a href="#n对n查询" class="headerlink" title="n对n查询"></a>n对n查询</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1对1匹配查询：适用于 查询条件为1个值，被查询对象字段也为1个值的情况</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">where</span> name = 111</span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "term": {</span><br><span class="line">      "name": {</span><br><span class="line">        "value": 111</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1对多查询：适用于 查询条件为一个，查询值为[]的情况</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">where</span> find_in_set(tags, <span class="string">"a"</span>)</span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "terms": {</span><br><span class="line">      "tags.keyword": ["a"]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 多对1查询：适用于查询条件为[]，被查询字段为1个值的情况</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">where</span> age <span class="keyword">in</span> (0,18)</span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "terms": {</span><br><span class="line">      "age": [</span><br><span class="line">        0,</span><br><span class="line">        18</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 多对多查询：适用于查询条件为 [], 查询值也为[] 的情况</span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "terms": {</span><br><span class="line">      "tags.keyword": ["a","e"]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="万能匹配-match"><a href="#万能匹配-match" class="headerlink" title="万能匹配-match"></a>万能匹配-match</h2><p><code>match</code>查询可以用于多种查询用途，常见的全文检索，关键词匹配等都使用该方法，是es中最常用的查询</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">where</span> tags.contains(<span class="string">"a"</span>)</span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "tags": "a"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">where</span> age = 18 </span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "age": 18</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">where</span> content like <span class="string">"%天气%"</span></span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "content": "天气"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="其他常用查询（range-exist-a-and-b等）"><a href="#其他常用查询（range-exist-a-and-b等）" class="headerlink" title="其他常用查询（range, exist, a and b等）"></a>其他常用查询（range, exist, a and b等）</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 范围查询  <span class="built_in">where</span> a between 10 and 20</span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "range": {</span><br><span class="line">      "age": {</span><br><span class="line">        "gte": 10,</span><br><span class="line">        "lte": 20</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="meta">#</span><span class="bash"> 字段是否存在 <span class="built_in">where</span> content not null</span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "exists":{</span><br><span class="line">      "field":"content"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="meta">#</span><span class="bash"> 多条件查询 <span class="built_in">where</span> (age between 10 and 20) and content like <span class="string">"上海"</span></span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "must": [</span><br><span class="line">        {</span><br><span class="line">          "range": {</span><br><span class="line">            "age": {</span><br><span class="line">              "gte": 10,</span><br><span class="line">              "lte": 20</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "match": {</span><br><span class="line">            "content": "上海"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ]</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="查询原理解析"><a href="#查询原理解析" class="headerlink" title="查询原理解析"></a>查询原理解析</h2><h3 id="es文档字段的存储逻辑"><a href="#es文档字段的存储逻辑" class="headerlink" title="es文档字段的存储逻辑"></a>es文档字段的存储逻辑</h3><p>es中的字段看起来有多种数据结构，实际抽象出来只有一种数据结构就是 <code>k-v</code></p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">类似</span><br><span class="line">`tags:["a","b","c"]`</span><br><span class="line">的数组数据结构在es中实际上是</span><br><span class="line">{</span><br><span class="line">	tags.a : a </span><br><span class="line">	tags.b : b</span><br><span class="line">	tags.c : c </span><br><span class="line">}</span><br><span class="line">这样的分解成多个字段进行存储的</span><br></pre></td></tr></tbody></table></figure>

<h3 id="match为什么可以做到万能查询"><a href="#match为什么可以做到万能查询" class="headerlink" title="match为什么可以做到万能查询"></a><code>match</code>为什么可以做到万能查询</h3><p>是因为match在查询时候会对查询条件进行分词</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 不分词的查询查不到 tags:[<span class="string">"a"</span>,<span class="string">"b"</span>]的值， 只能查询到 tags:[<span class="string">"ab"</span>]的值</span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "tags.keyword": "ab"</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>ps： es自带了一部分内容格式转换规则，类似 type = “VIDEO” 这种字段如果要使用term查询的话需要用 term:{type.keyword:”VIDEO”}, 因为大写的字段值会被默认分词， 如果是type =”video”这种小写 就可以用 term:{type:”video”}来进行匹配</p>
</blockquote>
<h1 id="分值相关查询"><a href="#分值相关查询" class="headerlink" title="分值相关查询"></a>分值相关查询</h1><p>有时候我们希望按照某种特殊的顺序对es的文档进行排序，这个时候往往需要自定义文档查询得分</p>
<h2 id="filter过滤"><a href="#filter过滤" class="headerlink" title="filter过滤"></a>filter过滤</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> filter使用布隆过滤器进行过滤所以没有分值，性能较好</span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "filter": {</span><br><span class="line">        "range": {</span><br><span class="line">          "age": {</span><br><span class="line">            "gte": 10</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="constant-score和boost提权"><a href="#constant-score和boost提权" class="headerlink" title="constant_score和boost提权"></a>constant_score和boost提权</h2><p><code>constant_score</code>用于指定查询命中的单位得分值，每个查询价值一个分值单位</p>
<p><code>boost</code> 用于提升权重</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 该查询命中则价值 1.2分 且忽略tf/idf得分</span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">    "query": {</span><br><span class="line">        "constant_score" : {</span><br><span class="line">          "filter": {</span><br><span class="line">            "terms": {</span><br><span class="line">              "tags": [</span><br><span class="line">                "a",</span><br><span class="line">                "d"</span><br><span class="line">              ]</span><br><span class="line">            }</span><br><span class="line">          },</span><br><span class="line">          "boost": 1.2</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> boost进行提权</span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "terms": {</span><br><span class="line">      "tags": ["a"],</span><br><span class="line">      "boost":3</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="function-score"><a href="#function-score" class="headerlink" title="function_score"></a>function_score</h2><p><code>function_score</code>自定义分值，可以根据文档内容进行得分定制</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 该查询根据文档的age字段 * 5 作为最终分值</span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "function_score": {</span><br><span class="line">      "query": {</span><br><span class="line">        "match_all": {</span><br><span class="line">        }</span><br><span class="line">      },</span><br><span class="line">      "script_score" : {</span><br><span class="line">        "script" : {</span><br><span class="line">          "source": "5*doc['age'].value"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="查询示例：根据用户关注的标签匹配数量计算得分"><a href="#查询示例：根据用户关注的标签匹配数量计算得分" class="headerlink" title="查询示例：根据用户关注的标签匹配数量计算得分"></a>查询示例：根据用户关注的标签匹配数量计算得分</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 假设用户关注了[<span class="string">"a"</span>,<span class="string">"b"</span>] 标签，根据用户的关注标签匹配数量进行分数计算，a标签价值1.3分，b标签1.1</span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "should": [</span><br><span class="line">        {</span><br><span class="line">         "constant_score": {</span><br><span class="line">           "filter": {</span><br><span class="line">             "terms": {</span><br><span class="line">               "tags": [</span><br><span class="line">                 "a"</span><br><span class="line">               ]</span><br><span class="line">             }</span><br><span class="line">           },</span><br><span class="line">           "boost": 1.3</span><br><span class="line">         }</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">          "constant_score": {</span><br><span class="line">            "filter": {</span><br><span class="line">              "terms": {</span><br><span class="line">                "tags": [</span><br><span class="line">                  "d"</span><br><span class="line">                ]</span><br><span class="line">              }</span><br><span class="line">            },</span><br><span class="line">            "boost": 1.1</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      "minimum_should_match": 1</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h1><h2 id="terms求count值"><a href="#terms求count值" class="headerlink" title="terms求count值"></a>terms求count值</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 等价于 group by tags</span></span><br><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": {</span><br><span class="line">    "t": {</span><br><span class="line">      "terms": {</span><br><span class="line">        "field": "tags.keyword",</span><br><span class="line">        "size": 10</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="avg求平均值"><a href="#avg求平均值" class="headerlink" title="avg求平均值"></a>avg求平均值</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": {</span><br><span class="line">    "t": {</span><br><span class="line">      "avg": {</span><br><span class="line">        "field": "age"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="其他查询和dsl"><a href="#其他查询和dsl" class="headerlink" title="其他查询和dsl"></a>其他查询和dsl</h1><h2 id="原子更新文档"><a href="#原子更新文档" class="headerlink" title="原子更新文档"></a>原子更新文档</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 由于es本身不支持源字形的更新文档，我们需要借助内置脚本的帮助来操作</span></span><br><span class="line">POST test_idx/_update/1</span><br><span class="line">{</span><br><span class="line"> "script" : {</span><br><span class="line">    "source": "ctx._source.age += params.count",</span><br><span class="line">      "lang": "painless",</span><br><span class="line">      "params" : {</span><br><span class="line">          "count" : 4</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="explain"><a href="#explain" class="headerlink" title="explain"></a>explain</h2><p>explain 用于查看查询的执行过程和各部分的具体得分，一般用于排查问题</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">GET test_idx/_search</span><br><span class="line">{</span><br><span class="line">  "explain": true, </span><br><span class="line">  "query": {</span><br><span class="line">    "bool": {</span><br><span class="line">      "must": [</span><br><span class="line">        {</span><br><span class="line">          "range": {</span><br><span class="line">            "age": {</span><br><span class="line">              "gte": 10,</span><br><span class="line">              "lte": 20</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      "should": [</span><br><span class="line">        {</span><br><span class="line">          "match": {</span><br><span class="line">            "content": "上海"</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      ],</span><br><span class="line">      "minimum_should_match": 1</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">explain 结果示例</span></span><br><span class="line">{</span><br><span class="line">        "_explanation": {</span><br><span class="line">          "value": 1.5753641,</span><br><span class="line">          "description": "sum of:",</span><br><span class="line">          "details": [</span><br><span class="line">            {</span><br><span class="line">              "value": 1,</span><br><span class="line">              "description": "age:[10 TO 20]",</span><br><span class="line">              "details": []</span><br><span class="line">            },</span><br><span class="line">            {</span><br><span class="line">              "value": 0.5753642,</span><br><span class="line">              "description": "sum of:",</span><br><span class="line">              "details": [</span><br><span class="line">                {</span><br><span class="line">                  "value": 0.2876821,</span><br><span class="line">                  "description": "weight(content:上 in 0) [PerFieldSimilarity], result of:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    {</span><br><span class="line">                      "value": 0.2876821,</span><br><span class="line">                      "description": "score(doc=0,freq=1.0 = termFreq=1.0\n), product of:",</span><br><span class="line">                      "details": [</span><br><span class="line">                        {</span><br><span class="line">                          "value": 0.2876821,</span><br><span class="line">                          "description": "idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:",</span><br><span class="line">                          "details": [</span><br><span class="line">                            {</span><br><span class="line">                              "value": 1,</span><br><span class="line">                              "description": "docFreq",</span><br><span class="line">                              "details": []</span><br><span class="line">                            },</span><br><span class="line">                            {</span><br><span class="line">                              "value": 1,</span><br><span class="line">                              "description": "docCount",</span><br><span class="line">                              "details": []</span><br><span class="line">                            }</span><br><span class="line">                          ]</span><br><span class="line">                        },</span><br><span class="line">                        {</span><br><span class="line">                          "value": 1,</span><br><span class="line">                          "description": "tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:",</span><br><span class="line">                          "details": [</span><br><span class="line">                            {</span><br><span class="line">                              "value": 1,</span><br><span class="line">                              "description": "termFreq=1.0",</span><br><span class="line">                              "details": []</span><br><span class="line">                            },</span><br><span class="line">                            {</span><br><span class="line">                              "value": 1.2,</span><br><span class="line">                              "description": "parameter k1",</span><br><span class="line">                              "details": []</span><br><span class="line">                            },</span><br><span class="line">                            {</span><br><span class="line">                              "value": 0.75,</span><br><span class="line">                              "description": "parameter b",</span><br><span class="line">                              "details": []</span><br><span class="line">                            },</span><br><span class="line">                            {</span><br><span class="line">                              "value": 12,</span><br><span class="line">                              "description": "avgFieldLength",</span><br><span class="line">                              "details": []</span><br><span class="line">                            },</span><br><span class="line">                            {</span><br><span class="line">                              "value": 12,</span><br><span class="line">                              "description": "fieldLength",</span><br><span class="line">                              "details": []</span><br><span class="line">                            }</span><br><span class="line">                          ]</span><br><span class="line">                        }</span><br><span class="line">                      ]</span><br><span class="line">                    }</span><br><span class="line">                  ]</span><br><span class="line">                },</span><br><span class="line">                {</span><br><span class="line">                  "value": 0.2876821,</span><br><span class="line">                  "description": "weight(content:海 in 0) [PerFieldSimilarity], result of:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    {</span><br><span class="line">                      "value": 0.2876821,</span><br><span class="line">                      "description": "score(doc=0,freq=1.0 = termFreq=1.0\n), product of:",</span><br><span class="line">                      "details": [</span><br><span class="line">                        {</span><br><span class="line">                          "value": 0.2876821,</span><br><span class="line">                          "description": "idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:",</span><br><span class="line">                          "details": [</span><br><span class="line">                            {</span><br><span class="line">                              "value": 1,</span><br><span class="line">                              "description": "docFreq",</span><br><span class="line">                              "details": []</span><br><span class="line">                            },</span><br><span class="line">                            {</span><br><span class="line">                              "value": 1,</span><br><span class="line">                              "description": "docCount",</span><br><span class="line">                              "details": []</span><br><span class="line">                            }</span><br><span class="line">                          ]</span><br><span class="line">                        },</span><br><span class="line">                        {</span><br><span class="line">                          "value": 1,</span><br><span class="line">                          "description": "tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:",</span><br><span class="line">                          "details": [</span><br><span class="line">                            {</span><br><span class="line">                              "value": 1,</span><br><span class="line">                              "description": "termFreq=1.0",</span><br><span class="line">                              "details": []</span><br><span class="line">                            },</span><br><span class="line">                            {</span><br><span class="line">                              "value": 1.2,</span><br><span class="line">                              "description": "parameter k1",</span><br><span class="line">                              "details": []</span><br><span class="line">                            },</span><br><span class="line">                            {</span><br><span class="line">                              "value": 0.75,</span><br><span class="line">                              "description": "parameter b",</span><br><span class="line">                              "details": []</span><br><span class="line">                            },</span><br><span class="line">                            {</span><br><span class="line">                              "value": 12,</span><br><span class="line">                              "description": "avgFieldLength",</span><br><span class="line">                              "details": []</span><br><span class="line">                            },</span><br><span class="line">                            {</span><br><span class="line">                              "value": 12,</span><br><span class="line">                              "description": "fieldLength",</span><br><span class="line">                              "details": []</span><br><span class="line">                            }</span><br><span class="line">                          ]</span><br><span class="line">                        }</span><br><span class="line">                      ]</span><br><span class="line">                    }</span><br><span class="line">                  ]</span><br><span class="line">                }</span><br><span class="line">              ]</span><br><span class="line">            }</span><br><span class="line">          ]</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<hr>
<p>参考资料</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前记"><span class="toc-number">1.</span> <span class="toc-text">前记</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#数据初始化和准备工作"><span class="toc-number">2.</span> <span class="toc-text">数据初始化和准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#es和kibana安装"><span class="toc-number">2.1.</span> <span class="toc-text">es和kibana安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#准备测试数据"><span class="toc-number">2.2.</span> <span class="toc-text">准备测试数据</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#简单查询示范"><span class="toc-number">3.</span> <span class="toc-text">简单查询示范</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#n对n查询"><span class="toc-number">3.1.</span> <span class="toc-text">n对n查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#万能匹配-match"><span class="toc-number">3.2.</span> <span class="toc-text">万能匹配-match</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他常用查询（range-exist-a-and-b等）"><span class="toc-number">3.3.</span> <span class="toc-text">其他常用查询（range, exist, a and b等）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询原理解析"><span class="toc-number">3.4.</span> <span class="toc-text">查询原理解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#es文档字段的存储逻辑"><span class="toc-number">3.4.1.</span> <span class="toc-text">es文档字段的存储逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#match为什么可以做到万能查询"><span class="toc-number">3.4.2.</span> <span class="toc-text">match为什么可以做到万能查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#分值相关查询"><span class="toc-number">4.</span> <span class="toc-text">分值相关查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#filter过滤"><span class="toc-number">4.1.</span> <span class="toc-text">filter过滤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#constant-score和boost提权"><span class="toc-number">4.2.</span> <span class="toc-text">constant_score和boost提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#function-score"><span class="toc-number">4.3.</span> <span class="toc-text">function_score</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询示例：根据用户关注的标签匹配数量计算得分"><span class="toc-number">4.4.</span> <span class="toc-text">查询示例：根据用户关注的标签匹配数量计算得分</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#聚合查询"><span class="toc-number">5.</span> <span class="toc-text">聚合查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#terms求count值"><span class="toc-number">5.1.</span> <span class="toc-text">terms求count值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#avg求平均值"><span class="toc-number">5.2.</span> <span class="toc-text">avg求平均值</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#其他查询和dsl"><span class="toc-number">6.</span> <span class="toc-text">其他查询和dsl</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#原子更新文档"><span class="toc-number">6.1.</span> <span class="toc-text">原子更新文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#explain"><span class="toc-number">6.2.</span> <span class="toc-text">explain</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://leriou.github.io/2019-12-25-es-dsl/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;text=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;title=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;is_video=false&amp;description=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Elasticsearch中的常用查询语句示例&amp;body=Check out this article: https://leriou.github.io/2019-12-25-es-dsl/" target="_blank" rel="noopener"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;title=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;title=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;title=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;title=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://leriou.github.io/2019-12-25-es-dsl/&amp;name=Elasticsearch中的常用查询语句示例&amp;description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://leriou.github.io/2019-12-25-es-dsl/&amp;t=Elasticsearch中的常用查询语句示例" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright ©
    
    
    2015-2020
    哎呀是太阳嘛
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



    <!-- jquery -->


<!-- clipboard -->

  
  


<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->




<script src="/bundle.js"></script><script>
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script></body></html>