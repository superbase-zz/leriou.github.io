<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.1">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.1" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.1">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.4.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"b2t":true,"scrollpercent":true},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: true,
    pangu: true,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":3,"unescape":false,"preload":true},
    path: 'search.json',
    motion: {"enable":true,"async":false,"transition":{"post_block":"perspectiveLeftIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"perspectiveRightIn","sidebar":"perspectiveRightIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="kafka分享听闻kafka已经是很早之前的事情了在我刚刚工作第一年的时候, 就在一次我们公司的数据团队的内部分享中听过他们基于kafka做的一套数据处理系统不过当时我对他的认知还仅仅知道是一个能处理海量数据的消息队列服务">
<meta name="keywords" content="Kafka">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka使用经验总结">
<meta property="og:url" content="https:&#x2F;&#x2F;leriou.github.io&#x2F;2017-11-01-kafka-share-in-group&#x2F;index.html">
<meta property="og:site_name" content="Leriou&#39;s Tavern">
<meta property="og:description" content="kafka分享听闻kafka已经是很早之前的事情了在我刚刚工作第一年的时候, 就在一次我们公司的数据团队的内部分享中听过他们基于kafka做的一套数据处理系统不过当时我对他的认知还仅仅知道是一个能处理海量数据的消息队列服务">
<meta property="og:locale" content="en">
<meta property="og:image" content="https:&#x2F;&#x2F;leriou.github.io&#x2F;2017-11-01-kafka-share-in-group&#x2F;kafka1.png">
<meta property="og:image" content="https:&#x2F;&#x2F;leriou.github.io&#x2F;2017-11-01-kafka-share-in-group&#x2F;kafka_zk.jpeg">
<meta property="og:image" content="https:&#x2F;&#x2F;leriou.github.io&#x2F;2017-11-01-kafka-share-in-group&#x2F;kafka_zk2.jpeg">
<meta property="og:image" content="https:&#x2F;&#x2F;leriou.github.io&#x2F;2017-11-01-kafka-share-in-group&#x2F;kafka_store.jpeg">
<meta property="og:image" content="https:&#x2F;&#x2F;leriou.github.io&#x2F;2017-11-01-kafka-share-in-group&#x2F;kafka_segment.jpeg">
<meta property="og:updated_time" content="2019-10-19T12:36:48.924Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;leriou.github.io&#x2F;2017-11-01-kafka-share-in-group&#x2F;kafka1.png">

<link rel="canonical" href="https://leriou.github.io/2017-11-01-kafka-share-in-group/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Kafka使用经验总结 | Leriou's Tavern</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Leriou's Tavern</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">我可能就是在扯淡 ^_^!</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="https://leriou.github.io/2017-11-01-kafka-share-in-group/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="哎呀是太阳嘛">
      <meta itemprop="description" content="君子生非异也, 善假于物也">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leriou's Tavern">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          Kafka使用经验总结
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-11-01 11:07:31" itemprop="dateCreated datePublished" datetime="2017-11-01T11:07:31+08:00">2017-11-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" itemprop="url" rel="index">
                    <span itemprop="name">工具使用</span>
                  </a>
                </span>
            </span>

          
            <span id="/2017-11-01-kafka-share-in-group/" class="post-meta-item leancloud_visitors" data-flag-title="Kafka使用经验总结" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2017-11-01-kafka-share-in-group/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2017-11-01-kafka-share-in-group/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="kafka分享"><a href="#kafka分享" class="headerlink" title="kafka分享"></a>kafka分享</h1><p>听闻kafka已经是很早之前的事情了</p><p>在我刚刚工作第一年的时候, 就在一次我们公司的数据团队的内部分享中听过他们基于kafka做的一套数据处理系统</p><p>不过当时我对他的认知还仅仅知道是一个能处理海量数据的消息队列服务</p><a id="more"></a>


<p>后来随着深入使用才发现kafka其实不是纯粹的消息队列, 而是一种分布式消息系统(基于scala开发)</p>
<h2 id="消息传递在现代业务中的地位"><a href="#消息传递在现代业务中的地位" class="headerlink" title="消息传递在现代业务中的地位"></a>消息传递在现代业务中的地位</h2><p><strong>面向对象的程序 = 对象 + 消息传递</strong></p>
<p>消息系统在我们业务中的重要性由此可见, 消息系统可以作为系统与系统进行交互,或者对业务进行解耦的一个利器</p>
<p>我们通常会把许多实时性要求不那么高的任务处理通过消息系统进行解耦,以平衡数据处理的性能和功能</p>
<p>例如: 用户下了一个订单,我们需要马上告诉用户下单成功, 但是之后的物流发货, 订单入账和商品信息更新等消息都可以通过一个消息系统进行拆分,这样不仅不会影响用户体验,也可以对之后触发的多个属于不同系统的业务进行并行处理,提升系统处理的性能</p>
<h2 id="Kafka基础介绍"><a href="#Kafka基础介绍" class="headerlink" title="Kafka基础介绍"></a>Kafka基础介绍</h2><p>kafka作为一个消息平台, 其中有一些基础概念跟传统的消息队列服务对应</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">broker(instance)    承载服务的实例</span><br><span class="line">topic (queue)  		逻辑上的消息通道</span><br><span class="line">paitition(sharding) 一个消息通道进行存储的区域(物理上的,本质是对应着一个文件序列)</span><br><span class="line">consumer       		消费者 (通常指客户端的使用者)</span><br><span class="line">producer       		生产者 (也是客户端的使用者)</span><br><span class="line">consumer group   	消费者组 (虚拟概念, 消费者的逻辑分组)</span><br></pre></td></tr></table></figure>

<h3 id="broker"><a href="#broker" class="headerlink" title="broker"></a>broker</h3><p>broker就相当于我们的kafka实例, 每个集群由多个broker组成, 每个broker具有完整的存储消息的功能, 多个broker可以组成broker集群, 但是这些实例不一定要分布在不同的机器上(虽然我们建议不要在同一个机器上部署多个broker)</p>
<p>broker是链接<code>producer</code>和<code>consumer</code>的中间桥梁, 是消息真正的存储者, producer将消息发送给broker, broker对消息进行存储, 等待consumer消费和使用消息</p>
<p>kafka的性能, 很大程度上取决于broker参数配置</p>
<h3 id="topic"><a href="#topic" class="headerlink" title="topic"></a>topic</h3><p>topic就相当于其他消息队列中的queue, 我们发送消息需要指定topic, 读取消息也需要指定topic, 同一个topic可以有多个生产者和多个消费者</p>
<p>topic是一个逻辑上的概念, 每个topic由至少一个或多个partition组成, 每个partition保存topic内的<code>一部分</code>消息</p>
<p>topic内的消息无法保证有序, 除非只有一个partition</p>
<h3 id="partition"><a href="#partition" class="headerlink" title="partition"></a>partition</h3><p>partition相当于是topic内部的一个分片 </p>
<p>假如说我们有个topic其中有5个patition, 一个消息在每个topic中只会存储在一个patition中, 整个topic的消息等于该topic下所有partition的总和 </p>
<p>每个partition至多只能有一个消费者, topic下的总消费者数量也受限于partition, 比如你topic有10个分片, 如果使用12个消费者就会有两个消费者永远获取不到数据  </p>
<p>每个partition是一个文件集合, 单个partition里面的数据因为这个关系可以保持有序  </p>
<p>partition还可以有自己的replication   </p>
<p>replication只有一个功能, 就是提供数据冗余, 防止partition出问题时造成数据丢失  </p>
<p>不过同一个partition的多个replication中同一时间只能有一个primary replication(通过选举得出)     </p>
<p>由这个primary  replication来执行整个partition的数据操作</p>
<h3 id="consumer"><a href="#consumer" class="headerlink" title="consumer"></a>consumer</h3><p>每个消费者可以消费一个topic的一个partition, 可以同时消费多个topic</p>
<p>consumer数量如果超过一个topic的分片数量, 会造成某些consumer永远消费不到数据</p>
<p>消费者消费数据需要提交offset告诉broker自己已经消费过某条数据</p>
<p>当topic新增一个consumer的时候会触发其他消费此topic的consumer group内consumer的<code>Rebalance</code>, 重新在consumer之间重新进行分区分配</p>
<h3 id="consumer-group"><a href="#consumer-group" class="headerlink" title="consumer group"></a>consumer group</h3><p>消费者组也是一个逻辑上的概念, 每个消费者组内的消费者只能消费同一个topic内的某一条消息一次, 除非进行手动offset调整重新消费</p>
<p>如果某个topic中的数据希望同时给多个业务方使用, 每个业务方应该使用一个单独的consumer group</p>
<h3 id="producer"><a href="#producer" class="headerlink" title="producer"></a>producer</h3><p>每个生产者可以为一个或多个topic生产数据, producer只负责将数据发送给broker, 后续操作通通由broker来负责</p>
<h2 id="kafka的主要应用"><a href="#kafka的主要应用" class="headerlink" title="kafka的主要应用"></a>kafka的主要应用</h2><ol>
<li><p>消息队列</p>
<p> kafka通常被用作消息队列, 这也是kafka的主要用途之一, 因为他可以一定程度上保证消息的可靠和有序</p>
</li>
<li><p>日志/消息存储</p>
<p> kafka由于基于文件存储, 所以很适合用来存储日志信息, 通知消息等有序且数据巨大的信息</p>
</li>
<li><p>数据总线</p>
<p> kafka还适合在不同的存储系统和业务之间做数据总线, 这样可以方便的把一份数据传递给多方公用</p>
</li>
</ol>
<h3 id="kafka的特性"><a href="#kafka的特性" class="headerlink" title="kafka的特性"></a>kafka的特性</h3><h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><pre><code>1. 增加了partition层, 高度解耦, 支持分布式, 支持副本, 扩展方便
2. 基于文件存储消息, 采用文件指针的读方式, 速度快, 且可重复读
3. 保证多消费者情况下消息的有序性
4. 在producer, broker, consumer三者做了大量性能优化,例如:`cache buff`和`sendfile()`等</code></pre><p>kafka的大部分特性都得益于partition的设计,由于采用了文件集合来存储每一个partition,使得kafka在性能和有序性方面获得了巨大的优势</p>
<h4 id="kafka作为消息队列的缺点"><a href="#kafka作为消息队列的缺点" class="headerlink" title="kafka作为消息队列的缺点"></a>kafka作为消息队列的缺点</h4><pre><code>1. 只有topic一个逻辑隔离级别
2. 高并发依赖于partition数量限制, 扩展不是特别的方便
3. 没有消息优先级机制
4. 数据中心级别的数据同步不成熟
5. 功能和数据存储系统没有隔离开</code></pre><p>同时也由于kafka的部分设计不可避免的有一些缺点</p>
<p>由于partition的限制, 应对高并发场景, 如果需要加快一个topic的处理速度只能通过增加消费者的方式, 这个增加过程又不像其他内存式的消息队列来的方便</p>
<p>相比于很多传统消息队列服务, kafka也没有消息优先级的机制</p>
<p>kafka的竞争对手Apache Pulsar在后两点比kafka要更加优秀, 且在很多基础功能上提供了更多的选择性</p>
<h2 id="kafka大概工作流程示意图"><a href="#kafka大概工作流程示意图" class="headerlink" title="kafka大概工作流程示意图"></a>kafka大概工作流程示意图</h2><p><img alt="大概示意图" data-src="kafka1.png"></p>
<p>kafka中的一个完整的消息流程如上图所示</p>
<p>Producer将消息发给broker中的topic,存储到topic下的某一个partition</p>
<p>Consumer从partition中消费数据,将该消费者在该topic中的数据偏移标记为最新</p>
<h2 id="kafka为什么这么快"><a href="#kafka为什么这么快" class="headerlink" title="kafka为什么这么快"></a>kafka为什么这么快</h2><ol>
<li>吞吐量和延迟</li>
</ol>
<p>吞吐量和延迟是一个kafka的平衡选择</p>
<p>吞吐量大, 延迟就高, 延迟高, 吞吐量就小</p>
<p>这个需要自己做抉择, kafka一定程度上选择了用牺牲延迟换吞吐量</p>
<p>kafka在producer和broker中都使用了<code>cache buff</code>的方式来增加吞吐量</p>
<ol start="2">
<li>零拷贝</li>
</ol>
<p>kafka的broker发送数据时采用零拷贝技术, 减少了一次内部的从用户态到内核态的状态切换过程, 使用<code>sendfile</code>将文件直接通过内存地址发送给网卡</p>
<ol start="3">
<li>基于文件的追加方式</li>
</ol>
<p>kafka采用追加文件记录的形式来处理数据, 这种方式要比随机读写快上很多  </p>
<ol start="4">
<li>buff发送</li>
</ol>
<p>对发送的文件进行了了缓冲区处理, 缓冲区满了以后或者到了一定时间才会发送数据</p>
<p>相当于对发送信息做了批处理</p>
<h3 id="kafka和ZooKeeper"><a href="#kafka和ZooKeeper" class="headerlink" title="kafka和ZooKeeper"></a>kafka和ZooKeeper</h3><p>kafka 使用zk存储一些关键配置信息</p>
<p>如: 某个topic的消息总量, 每个partition的消费数据等信息,消费者消费的记录offset等都存储于zk</p>
<p>许多的kafka监控应用也都是通过读取zk中的kafka数据来进行监控的</p>
<blockquote>
<p>ps: kafka新版本中已经允许客户端提交offset到kafka的topic中</p>
</blockquote>
<p>具体保存消息的节点路径如下图: </p>
<p><img alt="kafka信息在zk中的保存方式1" data-src="kafka_zk.jpeg"></p>
<p><img alt="kafka信息在zk中的保存方式2" data-src="kafka_zk2.jpeg"></p>
<h2 id="kafka数据存储"><a href="#kafka数据存储" class="headerlink" title="kafka数据存储"></a>kafka数据存储</h2><p>kafka的数据存储大致分为三层, broker, partition, segment</p>
<p>kafka配置文件中的 server.properties中的以下属性指明了kafka的数据存储位置</p>
<p><code>log.dirs=/usr/local/var/lib/kafka-logs</code></p>
<p>具体如下图:</p>
<p><img alt="kafka存储" data-src="kafka_store.jpeg"></p>
<p>一个broker中虽然可以随处多个topic数据, 但是真正的存储还是要落实到 segment上<br>topic和partition只能决定存放segment的上层文件夹的名字</p>
<h3 id="segment内的存储细节"><a href="#segment内的存储细节" class="headerlink" title="segment内的存储细节"></a>segment内的存储细节</h3><p><img alt="kafka文件" data-src="kafka_segment.jpeg"></p>
<p>一个topic的一个partition拥有多个segment file, 每个segment file拥有多个部分 </p>
<p>一般由以下四个类型文件组成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xxx.index  						//segment的索引文件</span><br><span class="line">xxx.log    						//segment的数据文件</span><br><span class="line">xxx.timeindex            		//segment的时间索引</span><br><span class="line">leader-epoch-checkpoint   		//检查点文件</span><br></pre></td></tr></table></figure>

<h2 id="kafka遇到的问题"><a href="#kafka遇到的问题" class="headerlink" title="kafka遇到的问题"></a>kafka遇到的问题</h2><h3 id="kafka的topic不消费"><a href="#kafka的topic不消费" class="headerlink" title="kafka的topic不消费"></a>kafka的topic不消费</h3><p><strong>产生原因</strong> </p>
<p>topic中的消息容量是有限制的,假如短时间内某topic中进入了大量的消息<br>消费者来不及消费可能导致消费者的消费offset小于当前topic的最小消息便宜</p>
<p>举例:<br>假如我们topic最大可以存储200万消息,消费者每分钟消费30万的消息<br>现在有个入消息的接口每分钟入100万的消息,那topic, consumer就会产生如下问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"topic"</span>:&#123;</span><br><span class="line">		<span class="string">"start"</span>: <span class="number">211450</span>, <span class="comment">// 当前topic消息最小值</span></span><br><span class="line">		<span class="string">"end"</span>: <span class="number">2211450</span>, <span class="comment">// 当前topic的消息最大值</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"consumer"</span>:&#123;</span><br><span class="line">		<span class="string">"topic1"</span>: <span class="number">311450</span>, <span class="comment">// 消费者在topic中的消费位置</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 然后等了一分钟</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"topic"</span>:&#123;</span><br><span class="line">		<span class="string">"start"</span>:<span class="number">2211450</span>,<span class="comment">// 当前最小的消息值</span></span><br><span class="line">		<span class="string">"end"</span>:<span class="number">4211450</span>,<span class="comment">// 当前最大的消息值</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">"consumer"</span>:&#123;</span><br><span class="line">		<span class="string">"topic1"</span>: <span class="number">461450</span>, <span class="comment">// 消费者当前的消费消息位置</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说消费者的消费值在内存中的topic中找不到了.因为消息入得太快,消费者跟不上,当前消费消息,被”顶”出去了</p>
<p>解决方案:</p>
<ol>
<li>可以手动设置消费者的消费位置,将其置为 当前topic中可以找到的消息偏移位置</li>
<li>可以重新设置消费方式,这种方式也是变相将该消费者在该topic的消费位置重置</li>
</ol>
<h4 id="kafka的topic不能删除"><a href="#kafka的topic不能删除" class="headerlink" title="kafka的topic不能删除"></a>kafka的topic不能删除</h4><p>原因: 因为要删除一个topic必须符合两个条件</p>
<ol>
<li>无消费者消费  </li>
<li>文件中无消息记录,普通的删除只能删除文件中的消息记录,无法删除消费者得消费信息</li>
</ol>
<p>方案: 将该topic的所有消费者消费偏移置为0 ,然后执行删除</p>
<h4 id="kafka的分片数据分布不均匀"><a href="#kafka的分片数据分布不均匀" class="headerlink" title="kafka的分片数据分布不均匀"></a>kafka的分片数据分布不均匀</h4><p>原因: kafka早期的算法会根据key的hash值来对消息进行分配<br>如果没有key可能会被分配至随机的一个固定的partition中<br>这样会导致topic中的消息分布不均匀,</p>
<p>方案: 1. 可以更改分配算法 2. 使用时间戳作为key的结尾 </p>
<h4 id="kafka的消费者分组的使用"><a href="#kafka的消费者分组的使用" class="headerlink" title="kafka的消费者分组的使用"></a>kafka的消费者分组的使用</h4><p>描述: 由于每个消费者分组中的topic只能被消费一次<br>kafka可以通过消费者分组来对某一topic中的数据进行重复消费<br>我们可以通过给不同部门设置消费者分组来实现类似订阅的机制</p>
<p>举例: 我们有一个订单消息队列, topic为 <code>order-topic</code><br>我们可以通过给 订单部门和 物流部门 分配不同的消费者分组<br>来对同一个topic中的消息进行重复消费</p>
<h4 id="我们kafka的使用"><a href="#我们kafka的使用" class="headerlink" title="我们kafka的使用"></a>我们kafka的使用</h4><p>kafka在我们组的项目中我知道的主要用于以下项目</p>
<ol>
<li>产品池(待更新的产品的存储)</li>
<li>部分表数据同步(价格实时同步,可售状态同步等)</li>
<li>实时更新</li>
</ol>
<h2 id="Kafka的其他特性"><a href="#Kafka的其他特性" class="headerlink" title="Kafka的其他特性"></a>Kafka的其他特性</h2><h3 id="kafka事务"><a href="#kafka事务" class="headerlink" title="kafka事务"></a>kafka事务</h3><p>kafka现在已经支持事务, 这个是kafka一致性保证的重大进步</p>
<p>kafka的事务目前还有一定的限制, 实现方式是使用 事务ID和客户端id做幂等处理</p>
<h3 id="kafka事务流程"><a href="#kafka事务流程" class="headerlink" title="kafka事务流程"></a>kafka事务流程</h3><ol>
<li><p>生产者发起事务请求</p>
</li>
<li><p>发送消息</p>
</li>
<li><p>服务器接受数据,进行追加写入</p>
</li>
<li><p>生产者结束事务</p>
</li>
</ol>
<p>如果客户端没有结束事务, kafka虽然将数据写入到了broker,但是不会让其他消费者客户端读到这部分数据</p>
<p>这部分数据在kafka上会被标记为abort掉的数据</p>
<h3 id="kafka多版本混布"><a href="#kafka多版本混布" class="headerlink" title="kafka多版本混布"></a>kafka多版本混布</h3><p>kafka现在支持多个kafka版本混合部署, 可以同时使用1.0 和2.0 版本组建一个kafka集群</p>
<h2 id="高级应用-kafka-streams-kafka的流处理"><a href="#高级应用-kafka-streams-kafka的流处理" class="headerlink" title="高级应用(kafka streams):kafka的流处理"></a>高级应用(kafka streams):kafka的流处理</h2><h3 id="流处理"><a href="#流处理" class="headerlink" title="流处理"></a>流处理</h3><p>什么是流?</p>
<p>一个无限持续的数据集</p>
<p>流处理框架 spark,storm, flink等</p>
<p>流处理更像业务逻辑的一部分,而不是业务的分拆,是一个独立的微服务,而不是MapReduce任务</p>
<ol>
<li>TopicA + TpoicB = stream</li>
</ol>
<h4 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h4><p>流处理常用的方法有 <code>filter /map /join /aggregate</code></p>
<p>其中 <code>map/filter</code> 属于对单个数据进行的无状态操作</p>
<p><code>join/aggregate</code> 属于数据统计需求, 有一定的状态要求</p>
<p>此外还有<code>window函数</code>等</p>
<p>kafka stream作为一个库的形式像我们提供了以上各种方法, 使得我们使用起来非常容易</p>
<h3 id="使用kafka-streaming的一个场景"><a href="#使用kafka-streaming的一个场景" class="headerlink" title="使用kafka streaming的一个场景"></a>使用kafka streaming的一个场景</h3><p>例如在产品池项目中, 我们用 kafka stream 从canal的事件消息topic中接收数据  </p>
<p>从中根据不同的消息内容将事件按照<code>库和表</code>发送给不同的后续topic, 达到了消息路由的功能  </p>
<p>kafka stream将三个不同来源的topic中的待更新产品信息融合到同一个 待更新的产品信息Topic中  </p>
<h4 id="Kstream和Ktable"><a href="#Kstream和Ktable" class="headerlink" title="Kstream和Ktable"></a>Kstream和Ktable</h4><p>kafka向我们提供了以下两个概念方便我们进行流处理</p>
<ol>
<li>KStream</li>
</ol>
<p>一个纯粹的流就是所有的更新都被解释成INSERT语句(因为没有记录会替换已有的记录)的表。</p>
<p>在一个流中(KStream)，每个key-value是一个独立的信息片断，比如，用户购买流是：alice-&gt;黄油，bob-&gt;面包，alice-&gt;奶酪面包，我们知道alice既买了黄油，又买了奶酪面包。</p>
<blockquote>
<p>ps: 表中每条记录的变动就是一个流</p>
</blockquote>
<ol start="2">
<li>KTable(changelog流)</li>
</ol>
<p>KTable 一张表就是一个所有的改变都被解释成UPDATE的流(因为所有使用同样的key的已存在的行都会被覆盖)。</p>
<p>对于一个表table( KTable)，是代表一个变化日志，如果表包含两对同样key的key-value值，后者会覆盖前面的记录，因为key值一样的，比如用户地址表：alice -&gt; 纽约, bob -&gt; 旧金山, alice -&gt; 芝加哥，意味着Alice从纽约迁移到芝加哥，而不是同时居住在两个地方。</p>
<blockquote>
<p>ps: 对某一时刻的流数据进行切面,按时间对数据进行覆盖,那个切面数据就是表</p>
</blockquote>
<p>这两个概念之间有一个二元性，一个流能被看成表，而一个表也可以看成流。</p>
<p>KTable 还提供了通过key查找数据值的功能，该查找功能可以用在Join等功能上。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kafka/" rel="tag"># Kafka</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2017-10-29-redis-share-in-group/" rel="next" title="给团队成员的Redis分享总结">
                  <i class="fa fa-chevron-left"></i> 给团队成员的Redis分享总结
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2017-11-02-distribute-database-share-in-group/" rel="prev" title="分布式服务组内分享">
                  分布式服务组内分享 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="comments"></div>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#kafka分享"><span class="nav-number">1.</span> <span class="nav-text">kafka分享</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#消息传递在现代业务中的地位"><span class="nav-number">1.1.</span> <span class="nav-text">消息传递在现代业务中的地位</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kafka基础介绍"><span class="nav-number">1.2.</span> <span class="nav-text">Kafka基础介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#broker"><span class="nav-number">1.2.1.</span> <span class="nav-text">broker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#topic"><span class="nav-number">1.2.2.</span> <span class="nav-text">topic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#partition"><span class="nav-number">1.2.3.</span> <span class="nav-text">partition</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#consumer"><span class="nav-number">1.2.4.</span> <span class="nav-text">consumer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#consumer-group"><span class="nav-number">1.2.5.</span> <span class="nav-text">consumer group</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#producer"><span class="nav-number">1.2.6.</span> <span class="nav-text">producer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kafka的主要应用"><span class="nav-number">1.3.</span> <span class="nav-text">kafka的主要应用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka的特性"><span class="nav-number">1.3.1.</span> <span class="nav-text">kafka的特性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#优点"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kafka作为消息队列的缺点"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">kafka作为消息队列的缺点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kafka大概工作流程示意图"><span class="nav-number">1.4.</span> <span class="nav-text">kafka大概工作流程示意图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kafka为什么这么快"><span class="nav-number">1.5.</span> <span class="nav-text">kafka为什么这么快</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka和ZooKeeper"><span class="nav-number">1.5.1.</span> <span class="nav-text">kafka和ZooKeeper</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kafka数据存储"><span class="nav-number">1.6.</span> <span class="nav-text">kafka数据存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#segment内的存储细节"><span class="nav-number">1.6.1.</span> <span class="nav-text">segment内的存储细节</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kafka遇到的问题"><span class="nav-number">1.7.</span> <span class="nav-text">kafka遇到的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka的topic不消费"><span class="nav-number">1.7.1.</span> <span class="nav-text">kafka的topic不消费</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#kafka的topic不能删除"><span class="nav-number">1.7.1.1.</span> <span class="nav-text">kafka的topic不能删除</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kafka的分片数据分布不均匀"><span class="nav-number">1.7.1.2.</span> <span class="nav-text">kafka的分片数据分布不均匀</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kafka的消费者分组的使用"><span class="nav-number">1.7.1.3.</span> <span class="nav-text">kafka的消费者分组的使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#我们kafka的使用"><span class="nav-number">1.7.1.4.</span> <span class="nav-text">我们kafka的使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kafka的其他特性"><span class="nav-number">1.8.</span> <span class="nav-text">Kafka的其他特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka事务"><span class="nav-number">1.8.1.</span> <span class="nav-text">kafka事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka事务流程"><span class="nav-number">1.8.2.</span> <span class="nav-text">kafka事务流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka多版本混布"><span class="nav-number">1.8.3.</span> <span class="nav-text">kafka多版本混布</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高级应用-kafka-streams-kafka的流处理"><span class="nav-number">1.9.</span> <span class="nav-text">高级应用(kafka streams):kafka的流处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#流处理"><span class="nav-number">1.9.1.</span> <span class="nav-text">流处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#常用方法"><span class="nav-number">1.9.1.1.</span> <span class="nav-text">常用方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用kafka-streaming的一个场景"><span class="nav-number">1.9.2.</span> <span class="nav-text">使用kafka streaming的一个场景</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Kstream和Ktable"><span class="nav-number">1.9.2.1.</span> <span class="nav-text">Kstream和Ktable</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="哎呀是太阳嘛"
    src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">哎呀是太阳嘛</p>
  <div class="site-description" itemprop="description">君子生非异也, 善假于物也</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/leriou" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;leriou" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/yange1876" title="Twitter &amp;rarr; https:&#x2F;&#x2F;twitter.com&#x2F;yange1876" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/1985364641" title="Weibo &amp;rarr; https:&#x2F;&#x2F;weibo.com&#x2F;1985364641" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-no-wifi"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">connect to Leriou</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.4.1
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.1"></script><script src="/js/motion.js?v=7.4.1"></script>
<script src="/js/schemes/pisces.js?v=7.4.1"></script>
<script src="/js/next-boot.js?v=7.4.1"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.getAttribute('pjax') !== null) {
      element.setAttribute('pjax', '');
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  






  <script src="/js/local-search.js?v=7.4.1"></script>










<script pjax>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'forest',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


    <div id="pjax">

  

  

  


<script>
NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'd3Ferur4FUri7vERAylGpome-gzGzoHsz',
    appKey: 'uRGeMnmfAq6h88QavSUfpS3q',
    placeholder: "你不想说点什么吗 ???",
    avatar: 'monsterid',
    meta: guest,
    pageSize: '10' || 10,
    visitor: true,
    lang: '' || 'zh-cn',
    path: location.pathname,
    recordIP: true,
    serverURLs: ''
  });
}, window.Valine);
</script>

    </div>
</body>
</html>
