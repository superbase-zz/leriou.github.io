<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">





  

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"leriou.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":3,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="君子生非异也, 善假于物也">
<meta property="og:type" content="website">
<meta property="og:title" content="Leriou's Tavern">
<meta property="og:url" content="https://leriou.github.io/page/2/index.html">
<meta property="og:site_name" content="Leriou's Tavern">
<meta property="og:description" content="君子生非异也, 善假于物也">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="哎呀是太阳嘛">
<meta property="article:tag" content="富强民主文明和谐，自由平等公正法治，爱国敬业诚信友善">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://leriou.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Leriou's Tavern</title>
  






  <style>:root {
  --body-bg-color: #f5f7f9;
  --content-bg-color: #fff;
  --card-bg-color: #f5f5f5;
  --text-color: #555;
  --blockquote-color: #666;
  --link-color: #555;
  --link-hover-color: #222;
  --brand-color: #fff;
  --brand-hover-color: #fff;
  --table-row-odd-bg-color: #f9f9f9;
  --table-row-hover-bg-color: #f5f5f5;
  --menu-item-bg-color: #f5f5f5;
  --btn-default-bg: #fff;
  --btn-default-color: #555;
  --btn-default-border-color: #555;
  --btn-default-hover-bg: #222;
  --btn-default-hover-color: #fff;
  --btn-default-hover-border-color: #222;
}
html {
  line-height: 1.15; /* 1 */
  -webkit-text-size-adjust: 100%; /* 2 */
}
body {
  margin: 0;
}
main {
  display: block;
}
h1 {
  font-size: 2em;
  margin: 0.67em 0;
}
hr {
  box-sizing: content-box; /* 1 */
  height: 0; /* 1 */
  overflow: visible; /* 2 */
}
pre {
  font-family: monospace, monospace; /* 1 */
  font-size: 1em; /* 2 */
}
a {
  background: transparent;
}
abbr[title] {
  border-bottom: none; /* 1 */
  text-decoration: underline; /* 2 */
  text-decoration: underline dotted; /* 2 */
}
b,
strong {
  font-weight: bolder;
}
code,
kbd,
samp {
  font-family: monospace, monospace; /* 1 */
  font-size: 1em; /* 2 */
}
small {
  font-size: 80%;
}
sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
sub {
  bottom: -0.25em;
}
sup {
  top: -0.5em;
}
img {
  border-style: none;
}
button,
input,
optgroup,
select,
textarea {
  font-family: inherit; /* 1 */
  font-size: 100%; /* 1 */
  line-height: 1.15; /* 1 */
  margin: 0; /* 2 */
}
button,
input {
/* 1 */
  overflow: visible;
}
button,
select {
/* 1 */
  text-transform: none;
}
button,
[type='button'],
[type='reset'],
[type='submit'] {
  -webkit-appearance: button;
}
button::-moz-focus-inner,
[type='button']::-moz-focus-inner,
[type='reset']::-moz-focus-inner,
[type='submit']::-moz-focus-inner {
  border-style: none;
  padding: 0;
}
button:-moz-focusring,
[type='button']:-moz-focusring,
[type='reset']:-moz-focusring,
[type='submit']:-moz-focusring {
  outline: 1px dotted ButtonText;
}
fieldset {
  padding: 0.35em 0.75em 0.625em;
}
legend {
  box-sizing: border-box; /* 1 */
  color: inherit; /* 2 */
  display: table; /* 1 */
  max-width: 100%; /* 1 */
  padding: 0; /* 3 */
  white-space: normal; /* 1 */
}
progress {
  vertical-align: baseline;
}
textarea {
  overflow: auto;
}
[type='checkbox'],
[type='radio'] {
  box-sizing: border-box; /* 1 */
  padding: 0; /* 2 */
}
[type='number']::-webkit-inner-spin-button,
[type='number']::-webkit-outer-spin-button {
  height: auto;
}
[type='search'] {
  outline-offset: -2px; /* 2 */
  -webkit-appearance: textfield; /* 1 */
}
[type='search']::-webkit-search-decoration {
  -webkit-appearance: none;
}
::-webkit-file-upload-button {
  font: inherit; /* 2 */
  -webkit-appearance: button; /* 1 */
}
details {
  display: block;
}
summary {
  display: list-item;
}
template {
  display: none;
}
[hidden] {
  display: none;
}
::selection {
  background: #262a30;
  color: #eee;
}
html,
body {
  height: 100%;
}
body {
  background: var(--body-bg-color);
  color: var(--text-color);
  font-family: 'Lato', "PingFang SC", "Microsoft YaHei", sans-serif;
  font-size: 0.8em;
  line-height: 2;
}
@media (max-width: 991px) {
  body {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
}
h1,
h2,
h3,
h4,
h5,
h6 {
  font-family: 'Lato', "PingFang SC", "Microsoft YaHei", sans-serif;
  font-weight: bold;
  line-height: 1.5;
  margin: 20px 0 15px;
}
h1 {
  font-size: 1.5em;
}
h2 {
  font-size: 1.375em;
}
h3 {
  font-size: 1.25em;
}
h4 {
  font-size: 1.125em;
}
h5 {
  font-size: 1em;
}
h6 {
  font-size: 0.875em;
}
p {
  margin: 0 0 20px 0;
}
a,
span.exturl {
  border-bottom: 1px solid #999;
  color: var(--link-color);
  outline: 0;
  text-decoration: none;
  overflow-wrap: break-word;
  word-wrap: break-word;
  cursor: pointer;
}
a:hover,
span.exturl:hover {
  border-bottom-color: var(--link-hover-color);
  color: var(--link-hover-color);
}
iframe,
img,
video {
  display: block;
  margin-left: auto;
  margin-right: auto;
  max-width: 100%;
}
hr {
  background-image: repeating-linear-gradient(-45deg, #ddd, #ddd 4px, transparent 4px, transparent 8px);
  border: 0;
  height: 3px;
  margin: 40px 0;
}
blockquote {
  border-left: 4px solid #ddd;
  color: var(--blockquote-color);
  margin: 0;
  padding: 0 15px;
}
blockquote cite::before {
  content: '-';
  padding: 0 5px;
}
dt {
  font-weight: bold;
}
dd {
  margin: 0;
  padding: 0;
}
kbd {
  background-color: #f5f5f5;
  background-image: linear-gradient(#eee, #fff, #eee);
  border: 1px solid #ccc;
  border-radius: 0.2em;
  box-shadow: 0.1em 0.1em 0.2em rgba(0,0,0,0.1);
  color: #555;
  font-family: inherit;
  padding: 0.1em 0.3em;
  white-space: nowrap;
}
.table-container {
  overflow: auto;
}
table {
  border-collapse: collapse;
  border-spacing: 0;
  font-size: 0.875em;
  margin: 0 0 20px 0;
  width: 100%;
}
tbody tr:nth-of-type(odd) {
  background: var(--table-row-odd-bg-color);
}
tbody tr:hover {
  background: var(--table-row-hover-bg-color);
}
caption,
th,
td {
  font-weight: normal;
  padding: 8px;
  text-align: left;
  vertical-align: middle;
}
th,
td {
  border: 1px solid #ddd;
  border-bottom: 3px solid #ddd;
}
th {
  font-weight: 700;
  padding-bottom: 10px;
}
td {
  border-bottom-width: 1px;
}
.btn {
  background: var(--btn-default-bg);
  border: 2px solid var(--btn-default-border-color);
  border-radius: 2px;
  color: var(--btn-default-color);
  display: inline-block;
  font-size: 0.875em;
  line-height: 2;
  padding: 0 20px;
  text-decoration: none;
  transition-property: background-color;
  transition-delay: 0s;
  transition-duration: 0.2s;
  transition-timing-function: ease-in-out;
}
.btn:hover {
  background: var(--btn-default-hover-bg);
  border-color: var(--btn-default-hover-border-color);
  color: var(--btn-default-hover-color);
}
.btn + .btn {
  margin: 0 0 8px 8px;
}
.btn .fa-fw {
  text-align: left;
  width: 1.285714285714286em;
}
.toggle {
  line-height: 0;
}
.toggle .toggle-line {
  background: #fff;
  display: inline-block;
  height: 2px;
  left: 0;
  position: relative;
  top: 0;
  transition: all 0.4s;
  vertical-align: top;
  width: 100%;
}
.toggle .toggle-line:not(:first-child) {
  margin-top: 3px;
}
.toggle.toggle-arrow .toggle-line-first {
  left: 50%;
  top: 2px;
  transform: rotate(45deg);
  width: 50%;
}
.toggle.toggle-arrow .toggle-line-middle {
  left: 2px;
  width: 90%;
}
.toggle.toggle-arrow .toggle-line-last {
  left: 50%;
  top: -2px;
  transform: rotate(-45deg);
  width: 50%;
}
.toggle.toggle-close .toggle-line-first {
  transform: rotate(-45deg);
  top: 5px;
}
.toggle.toggle-close .toggle-line-middle {
  opacity: 0;
}
.toggle.toggle-close .toggle-line-last {
  transform: rotate(45deg);
  top: -5px;
}
.highlight-container {
  position: relative;
}
.highlight-container:hover .copy-btn,
.highlight-container .copy-btn:focus {
  opacity: 1;
}
.copy-btn {
  color: #333;
  cursor: pointer;
  line-height: 1.6;
  opacity: 0;
  padding: 2px 6px;
  position: absolute;
  transition-delay: 0s;
  transition-duration: 0.2s;
  transition-timing-function: ease-in-out;
  color: #fff;
  font-size: 14px;
  right: 0;
  top: 2px;
}
.highlight-container {
  background: #21252b;
  border-radius: 5px;
  box-shadow: 0 10px 30px 0 rgba(0,0,0,0.4);
  padding-top: 30px;
}
.highlight-container::before {
  background: #fc625d;
  border-radius: 50%;
  box-shadow: 20px 0 #fdbc40, 40px 0 #35cd4b;
  content: ' ';
  height: 12px;
  left: 12px;
  margin-top: -20px;
  position: absolute;
  width: 12px;
}
.highlight-container .highlight {
  border-radius: 0 0 5px 5px;
}
.highlight-container .highlight .table-container {
  border-radius: 0 0 5px 5px;
}
.highlight,
pre {
  background: #f7f7f7;
  color: #4d4d4c;
  line-height: 1.6;
  margin: 0 auto 20px;
}
pre,
code {
  font-family: consolas, Menlo, monospace, "PingFang SC", "Microsoft YaHei";
}
code {
  background: #eee;
  border-radius: 3px;
  color: #555;
  padding: 2px 4px;
  overflow-wrap: break-word;
  word-wrap: break-word;
}
.highlight *::selection {
  background: #d6d6d6;
}
.highlight pre {
  border: 0;
  margin: 0;
  padding: 10px 0;
}
.highlight table {
  border: 0;
  margin: 0;
  width: auto;
}
.highlight td {
  border: 0;
  padding: 0;
}
.highlight figcaption {
  background: #eff2f3;
  color: #4d4d4c;
  display: flex;
  font-size: 0.875em;
  justify-content: space-between;
  line-height: 1.2;
  padding: 0.5em;
}
.highlight figcaption a {
  color: #4d4d4c;
}
.highlight figcaption a:hover {
  border-bottom-color: #4d4d4c;
}
.highlight .gutter {
  -moz-user-select: none;
  -ms-user-select: none;
  -webkit-user-select: none;
  user-select: none;
}
.highlight .gutter pre {
  background: #eff2f3;
  color: #869194;
  padding-left: 10px;
  padding-right: 10px;
  text-align: right;
}
.highlight .code pre {
  background: #f7f7f7;
  padding-left: 10px;
  width: 100%;
}
.gist table {
  width: auto;
}
.gist table td {
  border: 0;
}
pre {
  overflow: auto;
  padding: 10px;
}
pre code {
  background: none;
  color: #4d4d4c;
  font-size: 0.875em;
  padding: 0;
  text-shadow: none;
}
pre .deletion {
  background: #fdd;
}
pre .addition {
  background: #dfd;
}
pre .meta {
  color: #eab700;
  -moz-user-select: none;
  -ms-user-select: none;
  -webkit-user-select: none;
  user-select: none;
}
pre .comment {
  color: #8e908c;
}
pre .variable,
pre .attribute,
pre .tag,
pre .name,
pre .regexp,
pre .ruby .constant,
pre .xml .tag .title,
pre .xml .pi,
pre .xml .doctype,
pre .html .doctype,
pre .css .id,
pre .css .class,
pre .css .pseudo {
  color: #c82829;
}
pre .number,
pre .preprocessor,
pre .built_in,
pre .builtin-name,
pre .literal,
pre .params,
pre .constant,
pre .command {
  color: #f5871f;
}
pre .ruby .class .title,
pre .css .rules .attribute,
pre .string,
pre .symbol,
pre .value,
pre .inheritance,
pre .header,
pre .ruby .symbol,
pre .xml .cdata,
pre .special,
pre .formula {
  color: #718c00;
}
pre .title,
pre .css .hexcolor {
  color: #3e999f;
}
pre .function,
pre .python .decorator,
pre .python .title,
pre .ruby .function .title,
pre .ruby .title .keyword,
pre .perl .sub,
pre .javascript .title,
pre .coffeescript .title {
  color: #4271ae;
}
pre .keyword,
pre .javascript .function {
  color: #8959a8;
}
.blockquote-center {
  border-left: none;
  margin: 40px 0;
  padding: 0;
  position: relative;
  text-align: center;
}
.blockquote-center .fa {
  display: block;
  opacity: 0.6;
  position: absolute;
  width: 100%;
}
.blockquote-center .fa-quote-left {
  border-top: 1px solid #ccc;
  text-align: left;
  top: -20px;
}
.blockquote-center .fa-quote-right {
  border-bottom: 1px solid #ccc;
  text-align: right;
  bottom: -20px;
}
.blockquote-center p,
.blockquote-center div {
  text-align: center;
}
.post-body .group-picture img {
  margin: 0 auto;
  padding: 0 3px;
}
.group-picture-row {
  margin-bottom: 6px;
  overflow: hidden;
}
.group-picture-column {
  float: left;
  margin-bottom: 10px;
}
.post-body .label {
  color: #555;
  display: inline;
  padding: 0 2px;
}
.post-body .label.default {
  background: #f0f0f0;
}
.post-body .label.primary {
  background: #efe6f7;
}
.post-body .label.info {
  background: #e5f2f8;
}
.post-body .label.success {
  background: #e7f4e9;
}
.post-body .label.warning {
  background: #fcf6e1;
}
.post-body .label.danger {
  background: #fae8eb;
}
.post-body .tabs {
  margin-bottom: 20px;
}
.post-body .tabs,
.tabs-comment {
  display: block;
  padding-top: 10px;
  position: relative;
}
.post-body .tabs ul.nav-tabs,
.tabs-comment ul.nav-tabs {
  display: flex;
  flex-wrap: wrap;
  margin: 0;
  margin-bottom: -1px;
  padding: 0;
}
@media (max-width: 413px) {
  .post-body .tabs ul.nav-tabs,
  .tabs-comment ul.nav-tabs {
    display: block;
    margin-bottom: 5px;
  }
}
.post-body .tabs ul.nav-tabs li.tab,
.tabs-comment ul.nav-tabs li.tab {
  border-bottom: 1px solid #ddd;
  border-left: 1px solid transparent;
  border-right: 1px solid transparent;
  border-top: 3px solid transparent;
  flex-grow: 1;
  list-style-type: none;
  border-radius: 0 0 0 0;
}
@media (max-width: 413px) {
  .post-body .tabs ul.nav-tabs li.tab,
  .tabs-comment ul.nav-tabs li.tab {
    border-bottom: 1px solid transparent;
    border-left: 3px solid transparent;
    border-right: 1px solid transparent;
    border-top: 1px solid transparent;
  }
}
@media (max-width: 413px) {
  .post-body .tabs ul.nav-tabs li.tab,
  .tabs-comment ul.nav-tabs li.tab {
    border-radius: 0;
  }
}
.post-body .tabs ul.nav-tabs li.tab a,
.tabs-comment ul.nav-tabs li.tab a {
  border-bottom: initial;
  display: block;
  line-height: 1.8;
  outline: 0;
  padding: 0.25em 0.75em;
  text-align: center;
  transition-delay: 0s;
  transition-duration: 0.2s;
  transition-timing-function: ease-out;
}
.post-body .tabs ul.nav-tabs li.tab a i,
.tabs-comment ul.nav-tabs li.tab a i {
  width: 1.285714285714286em;
}
.post-body .tabs ul.nav-tabs li.tab.active,
.tabs-comment ul.nav-tabs li.tab.active {
  border-bottom: 1px solid transparent;
  border-left: 1px solid #ddd;
  border-right: 1px solid #ddd;
  border-top: 3px solid #fc6423;
}
@media (max-width: 413px) {
  .post-body .tabs ul.nav-tabs li.tab.active,
  .tabs-comment ul.nav-tabs li.tab.active {
    border-bottom: 1px solid #ddd;
    border-left: 3px solid #fc6423;
    border-right: 1px solid #ddd;
    border-top: 1px solid #ddd;
  }
}
.post-body .tabs ul.nav-tabs li.tab.active a,
.tabs-comment ul.nav-tabs li.tab.active a {
  color: var(--link-color);
  cursor: default;
}
.post-body .tabs .tab-content .tab-pane,
.tabs-comment .tab-content .tab-pane {
  border: 1px solid #ddd;
  border-top: 0;
  padding: 20px 20px 0 20px;
  border-radius: 0;
}
.post-body .tabs .tab-content .tab-pane:not(.active),
.tabs-comment .tab-content .tab-pane:not(.active) {
  display: none;
}
.post-body .tabs .tab-content .tab-pane.active,
.tabs-comment .tab-content .tab-pane.active {
  display: block;
}
.post-body .tabs .tab-content .tab-pane.active:nth-of-type(1),
.tabs-comment .tab-content .tab-pane.active:nth-of-type(1) {
  border-radius: 0 0 0 0;
}
@media (max-width: 413px) {
  .post-body .tabs .tab-content .tab-pane.active:nth-of-type(1),
  .tabs-comment .tab-content .tab-pane.active:nth-of-type(1) {
    border-radius: 0;
  }
}
.post-body .note {
  border-radius: 3px;
  margin-bottom: 20px;
  padding: 1em;
  position: relative;
  border: 1px solid #eee;
  border-left-width: 5px;
}
.post-body .note h2,
.post-body .note h3,
.post-body .note h4,
.post-body .note h5,
.post-body .note h6 {
  margin-top: 0;
  border-bottom: initial;
  margin-bottom: 0;
  padding-top: 0;
}
.post-body .note p:first-child,
.post-body .note ul:first-child,
.post-body .note ol:first-child,
.post-body .note table:first-child,
.post-body .note pre:first-child,
.post-body .note blockquote:first-child,
.post-body .note img:first-child {
  margin-top: 0;
}
.post-body .note p:last-child,
.post-body .note ul:last-child,
.post-body .note ol:last-child,
.post-body .note table:last-child,
.post-body .note pre:last-child,
.post-body .note blockquote:last-child,
.post-body .note img:last-child {
  margin-bottom: 0;
}
.post-body .note.default {
  border-left-color: #777;
}
.post-body .note.default h2,
.post-body .note.default h3,
.post-body .note.default h4,
.post-body .note.default h5,
.post-body .note.default h6 {
  color: #777;
}
.post-body .note.primary {
  border-left-color: #6f42c1;
}
.post-body .note.primary h2,
.post-body .note.primary h3,
.post-body .note.primary h4,
.post-body .note.primary h5,
.post-body .note.primary h6 {
  color: #6f42c1;
}
.post-body .note.info {
  border-left-color: #428bca;
}
.post-body .note.info h2,
.post-body .note.info h3,
.post-body .note.info h4,
.post-body .note.info h5,
.post-body .note.info h6 {
  color: #428bca;
}
.post-body .note.success {
  border-left-color: #5cb85c;
}
.post-body .note.success h2,
.post-body .note.success h3,
.post-body .note.success h4,
.post-body .note.success h5,
.post-body .note.success h6 {
  color: #5cb85c;
}
.post-body .note.warning {
  border-left-color: #f0ad4e;
}
.post-body .note.warning h2,
.post-body .note.warning h3,
.post-body .note.warning h4,
.post-body .note.warning h5,
.post-body .note.warning h6 {
  color: #f0ad4e;
}
.post-body .note.danger {
  border-left-color: #d9534f;
}
.post-body .note.danger h2,
.post-body .note.danger h3,
.post-body .note.danger h4,
.post-body .note.danger h5,
.post-body .note.danger h6 {
  color: #d9534f;
}
.pagination .prev,
.pagination .next,
.pagination .page-number,
.pagination .space {
  display: inline-block;
  margin: 0 10px;
  padding: 0 11px;
  position: relative;
  top: -1px;
}
@media (max-width: 767px) {
  .pagination .prev,
  .pagination .next,
  .pagination .page-number,
  .pagination .space {
    margin: 0 5px;
  }
}
.pagination {
  border-top: 1px solid #eee;
  margin: 120px 0 0;
  text-align: center;
}
.pagination .prev,
.pagination .next,
.pagination .page-number {
  border-bottom: 0;
  border-top: 1px solid #eee;
  transition-property: border-color;
  transition-delay: 0s;
  transition-duration: 0.2s;
  transition-timing-function: ease-in-out;
}
.pagination .prev:hover,
.pagination .next:hover,
.pagination .page-number:hover {
  border-top-color: #222;
}
.pagination .space {
  margin: 0;
  padding: 0;
}
.pagination .prev {
  margin-left: 0;
}
.pagination .next {
  margin-right: 0;
}
.pagination .page-number.current {
  background: #ccc;
  border-top-color: #ccc;
  color: #fff;
}
@media (max-width: 767px) {
  .pagination {
    border-top: none;
  }
  .pagination .prev,
  .pagination .next,
  .pagination .page-number {
    border-bottom: 1px solid #eee;
    border-top: 0;
    margin-bottom: 10px;
    padding: 0 10px;
  }
  .pagination .prev:hover,
  .pagination .next:hover,
  .pagination .page-number:hover {
    border-bottom-color: #222;
  }
}
.comments {
  margin-top: 60px;
  overflow: hidden;
}
.comment-button-group {
  display: flex;
  flex-wrap: wrap-reverse;
  justify-content: center;
  margin: 1em 0;
}
.comment-button-group .comment-button {
  margin: 0.1em 0.2em;
}
.comment-button-group .comment-button.active {
  background: var(--btn-default-hover-bg);
  border-color: var(--btn-default-hover-border-color);
  color: var(--btn-default-hover-color);
}
.comment-position {
  display: none;
}
.comment-position.active {
  display: block;
}
.tabs-comment {
  background: var(--content-bg-color);
  margin-top: 4em;
  padding-top: 0;
}
.tabs-comment .comments {
  border: 0;
  box-shadow: none;
  margin-top: 0;
  padding-top: 0;
}
.container {
  min-height: 100%;
  position: relative;
}
.main-inner {
  margin: 0 auto;
  width: calc(100% - 20px);
}
@media (min-width: 1200px) {
  .main-inner {
    width: 1160px;
  }
}
@media (min-width: 1600px) {
  .main-inner {
    width: 73%;
  }
}
@media (max-width: 767px) {
  .content-wrap {
    padding: 0 20px;
  }
}
.header {
  background: transparent;
}
.header-inner {
  margin: 0 auto;
  width: calc(100% - 20px);
}
@media (min-width: 1200px) {
  .header-inner {
    width: 1160px;
  }
}
@media (min-width: 1600px) {
  .header-inner {
    width: 73%;
  }
}
.site-brand-container {
  display: flex;
  flex-shrink: 0;
  padding: 0 10px;
}
.headband {
  background: #222;
  height: 3px;
}
.site-meta {
  flex-grow: 1;
  text-align: center;
}
@media (max-width: 767px) {
  .site-meta {
    text-align: center;
  }
}
.brand {
  border-bottom: none;
  color: var(--brand-color);
  display: inline-block;
  line-height: 1.375em;
  padding: 0 40px;
  position: relative;
}
.brand:hover {
  color: var(--brand-hover-color);
}
.site-title {
  font-family: 'Lato', "PingFang SC", "Microsoft YaHei", sans-serif;
  font-size: 1.375em;
  font-weight: normal;
  margin: 0;
}
.site-subtitle {
  color: #ddd;
  font-size: 0.8125em;
  margin: 10px 0;
}
.use-motion .brand {
  opacity: 0;
}
.use-motion .site-title,
.use-motion .site-subtitle,
.use-motion .custom-logo-image {
  opacity: 0;
  position: relative;
  top: -10px;
}
.site-nav-toggle,
.site-nav-right {
  display: none;
}
@media (max-width: 767px) {
  .site-nav-toggle,
  .site-nav-right {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
}
.site-nav-toggle .toggle,
.site-nav-right .toggle {
  color: var(--text-color);
  padding: 10px;
  width: 22px;
}
.site-nav-toggle .toggle .toggle-line,
.site-nav-right .toggle .toggle-line {
  background: var(--text-color);
  border-radius: 1px;
}
.site-nav {
  display: block;
}
@media (max-width: 767px) {
  .site-nav {
    clear: both;
    display: none;
  }
}
.site-nav.site-nav-on {
  display: block;
}
.menu {
  margin-top: 20px;
  padding-left: 0;
  text-align: center;
}
.menu-item {
  display: inline-block;
  list-style: none;
  margin: 0 10px;
}
@media (max-width: 767px) {
  .menu-item {
    display: block;
    margin-top: 10px;
  }
  .menu-item.menu-item-search {
    display: none;
  }
}
.menu-item a,
.menu-item span.exturl {
  border-bottom: 0;
  display: block;
  font-size: 0.8125em;
  transition-property: border-color;
  transition-delay: 0s;
  transition-duration: 0.2s;
  transition-timing-function: ease-in-out;
}
@media (hover: none) {
  .menu-item a:hover,
  .menu-item span.exturl:hover {
    border-bottom-color: transparent !important;
  }
}
.menu-item .fa,
.menu-item .fab,
.menu-item .far,
.menu-item .fas {
  margin-right: 8px;
}
.menu-item .badge {
  display: inline-block;
  font-weight: bold;
  line-height: 1;
  margin-left: 0.35em;
  margin-top: 0.35em;
  text-align: center;
  white-space: nowrap;
}
@media (max-width: 767px) {
  .menu-item .badge {
    float: right;
    margin-left: 0;
  }
}
.menu-item-active a,
.menu .menu-item a:hover,
.menu .menu-item span.exturl:hover {
  background: var(--menu-item-bg-color);
}
.use-motion .menu-item {
  opacity: 0;
}
.sidebar {
  background: #222;
  bottom: 0;
  box-shadow: inset 0 2px 6px #000;
  position: fixed;
  top: 0;
}
@media (max-width: 991px) {
  .sidebar {
    display: none;
  }
}
.sidebar-inner {
  color: #999;
  padding: 18px 10px;
  text-align: center;
}
.cc-license {
  margin-top: 10px;
  text-align: center;
}
.cc-license .cc-opacity {
  border-bottom: none;
  opacity: 0.7;
}
.cc-license .cc-opacity:hover {
  opacity: 0.9;
}
.cc-license img {
  display: inline-block;
}
.site-author-image {
  border: 1px solid #eee;
  display: block;
  margin: 0 auto;
  max-width: 120px;
  padding: 2px;
}
.site-author-name {
  color: var(--text-color);
  font-weight: 600;
  margin: 0;
  text-align: center;
}
.site-description {
  color: #999;
  font-size: 0.8125em;
  margin-top: 0;
  text-align: center;
}
.links-of-author {
  margin-top: 15px;
}
.links-of-author a,
.links-of-author span.exturl {
  border-bottom-color: #555;
  display: inline-block;
  font-size: 0.8125em;
  margin-bottom: 10px;
  margin-right: 10px;
  vertical-align: middle;
}
.links-of-author a::before,
.links-of-author span.exturl::before {
  background: #419605;
  border-radius: 50%;
  content: ' ';
  display: inline-block;
  height: 4px;
  margin-right: 3px;
  vertical-align: middle;
  width: 4px;
}
.sidebar-button {
  margin-top: 15px;
}
.sidebar-button a {
  border: 1px solid #fc6423;
  border-radius: 4px;
  color: #fc6423;
  display: inline-block;
  padding: 0 15px;
}
.sidebar-button a .fa,
.sidebar-button a .fab,
.sidebar-button a .far,
.sidebar-button a .fas {
  margin-right: 5px;
}
.sidebar-button a:hover {
  background: #fc6423;
  border: 1px solid #fc6423;
  color: #fff;
}
.sidebar-button a:hover .fa,
.sidebar-button a:hover .fab,
.sidebar-button a:hover .far,
.sidebar-button a:hover .fas {
  color: #fff;
}
.links-of-blogroll {
  font-size: 0.8125em;
  margin-top: 10px;
}
.links-of-blogroll-title {
  font-size: 0.875em;
  font-weight: 600;
  margin-top: 0;
}
.links-of-blogroll-list {
  list-style: none;
  margin: 0;
  padding: 0;
}
#sidebar-dimmer {
  display: none;
}
@media (max-width: 767px) {
  #sidebar-dimmer {
    background: #000;
    display: block;
    height: 100%;
    left: 100%;
    opacity: 0;
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 1100;
  }
  .sidebar-active + #sidebar-dimmer {
    opacity: 0.7;
    transform: translateX(-100%);
    transition: opacity 0.5s;
  }
}
.sidebar-nav {
  margin: 0;
  padding-bottom: 20px;
  padding-left: 0;
}
.sidebar-nav li {
  border-bottom: 1px solid transparent;
  color: var(--text-color);
  cursor: pointer;
  display: inline-block;
  font-size: 0.875em;
}
.sidebar-nav li.sidebar-nav-overview {
  margin-left: 10px;
}
.sidebar-nav li:hover {
  color: #fc6423;
}
.sidebar-nav .sidebar-nav-active {
  border-bottom-color: #fc6423;
  color: #fc6423;
}
.sidebar-nav .sidebar-nav-active:hover {
  color: #fc6423;
}
.sidebar-panel {
  display: none;
  overflow-x: hidden;
  overflow-y: auto;
}
.sidebar-panel-active {
  display: block;
}
.sidebar-toggle {
  background: #222;
  bottom: 45px;
  cursor: pointer;
  height: 14px;
  left: 30px;
  padding: 5px;
  position: fixed;
  width: 14px;
  z-index: 1300;
}
@media (max-width: 991px) {
  .sidebar-toggle {
    left: 20px;
    opacity: 0.8;
    display: none;
  }
}
.sidebar-toggle:hover .toggle-line {
  background: #fc6423;
}
.post-toc {
  font-size: 0.875em;
}
.post-toc ol {
  list-style: none;
  margin: 0;
  padding: 0 2px 5px 10px;
  text-align: left;
}
.post-toc ol > ol {
  padding-left: 0;
}
.post-toc ol a {
  transition-property: all;
  transition-delay: 0s;
  transition-duration: 0.2s;
  transition-timing-function: ease-in-out;
}
.post-toc .nav-item {
  line-height: 1.8;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.post-toc .nav .nav-child {
  display: none;
}
.post-toc .nav .active > .nav-child {
  display: block;
}
.post-toc .nav .active-current > .nav-child {
  display: block;
}
.post-toc .nav .active-current > .nav-child > .nav-item {
  display: block;
}
.post-toc .nav .active > a {
  border-bottom-color: #fc6423;
  color: #fc6423;
}
.post-toc .nav .active-current > a {
  color: #fc6423;
}
.post-toc .nav .active-current > a:hover {
  color: #fc6423;
}
.site-state {
  display: flex;
  justify-content: center;
  line-height: 1.4;
  margin-top: 10px;
  overflow: hidden;
  text-align: center;
  white-space: nowrap;
}
.site-state-item {
  padding: 0 15px;
}
.site-state-item:not(:first-child) {
  border-left: 1px solid #eee;
}
.site-state-item a {
  border-bottom: none;
}
.site-state-item-count {
  display: block;
  font-size: 1em;
  font-weight: 600;
  text-align: center;
}
.site-state-item-name {
  color: #999;
  font-size: 0.8125em;
}
.footer {
  color: #999;
  font-size: 0.875em;
  padding: 20px 0;
}
.footer.footer-fixed {
  bottom: 0;
  left: 0;
  position: absolute;
  right: 0;
}
.footer-inner {
  box-sizing: border-box;
  margin: 0 auto;
  text-align: center;
  width: calc(100% - 20px);
}
@media (min-width: 1200px) {
  .footer-inner {
    width: 1160px;
  }
}
@media (min-width: 1600px) {
  .footer-inner {
    width: 73%;
  }
}
.languages {
  display: inline-block;
  font-size: 1.125em;
  position: relative;
}
.languages .lang-select-label span {
  margin: 0 0.5em;
}
.languages .lang-select {
  height: 100%;
  left: 0;
  opacity: 0;
  position: absolute;
  top: 0;
  width: 100%;
}
.with-love {
  color: #ff0000;
  display: inline-block;
  margin: 0 5px;
}
.powered-by,
.theme-info {
  display: inline-block;
}
@-moz-keyframes iconAnimate {
  0%, 100% {
    transform: scale(1);
  }
  10%, 30% {
    transform: scale(0.9);
  }
  20%, 40%, 60%, 80% {
    transform: scale(1.1);
  }
  50%, 70% {
    transform: scale(1.1);
  }
}
@-webkit-keyframes iconAnimate {
  0%, 100% {
    transform: scale(1);
  }
  10%, 30% {
    transform: scale(0.9);
  }
  20%, 40%, 60%, 80% {
    transform: scale(1.1);
  }
  50%, 70% {
    transform: scale(1.1);
  }
}
@-o-keyframes iconAnimate {
  0%, 100% {
    transform: scale(1);
  }
  10%, 30% {
    transform: scale(0.9);
  }
  20%, 40%, 60%, 80% {
    transform: scale(1.1);
  }
  50%, 70% {
    transform: scale(1.1);
  }
}
@keyframes iconAnimate {
  0%, 100% {
    transform: scale(1);
  }
  10%, 30% {
    transform: scale(0.9);
  }
  20%, 40%, 60%, 80% {
    transform: scale(1.1);
  }
  50%, 70% {
    transform: scale(1.1);
  }
}
.back-to-top {
  font-size: 12px;
  text-align: center;
  transition-delay: 0s;
  transition-duration: 0.2s;
  transition-timing-function: ease-in-out;
}
.back-to-top {
  background: #222;
  bottom: -100px;
  box-sizing: border-box;
  color: #fff;
  cursor: pointer;
  left: 30px;
  opacity: 0.6;
  padding: 0 6px;
  position: fixed;
  transition-property: bottom;
  z-index: 1300;
  width: 24px;
}
.back-to-top span {
  display: none;
}
.back-to-top:hover {
  color: #fc6423;
}
.back-to-top.back-to-top-on {
  bottom: 30px;
}
@media (max-width: 991px) {
  .back-to-top {
    left: 20px;
    opacity: 0.8;
  }
}
.post-body {
  font-family: 'Lato', 'Lato', "PingFang SC", "Microsoft YaHei", sans-serif;
  overflow-wrap: break-word;
  word-wrap: break-word;
}
@media (min-width: 1200px) {
  .post-body {
    font-size: 1.125em;
  }
}
.post-body .exturl .fa {
  font-size: 0.875em;
  margin-left: 4px;
}
.post-body .image-caption,
.post-body .figure .caption {
  color: #999;
  font-size: 0.875em;
  font-weight: bold;
  line-height: 1;
  margin: -20px auto 15px;
  text-align: center;
}
.post-sticky-flag {
  display: inline-block;
  transform: rotate(30deg);
}
.post-button {
  margin-top: 40px;
  text-align: center;
}
.use-motion .post-block,
.use-motion .pagination,
.use-motion .comments {
  opacity: 0;
}
.use-motion .post-header {
  opacity: 0;
}
.use-motion .post-body {
  opacity: 0;
}
.use-motion .collection-header {
  opacity: 0;
}
.posts-collapse {
  margin-left: 35px;
  position: relative;
}
@media (max-width: 767px) {
  .posts-collapse {
    margin-left: 0px;
    margin-right: 0px;
  }
}
.posts-collapse .collection-title {
  font-size: 1.125em;
  position: relative;
}
.posts-collapse .collection-title::before {
  background: #999;
  border: 1px solid #fff;
  border-radius: 50%;
  content: ' ';
  height: 10px;
  left: 0;
  margin-left: -6px;
  margin-top: -4px;
  position: absolute;
  top: 50%;
  width: 10px;
}
.posts-collapse .collection-year {
  font-size: 1.5em;
  font-weight: bold;
  margin: 60px 0;
  position: relative;
}
.posts-collapse .collection-year::before {
  background: #bbb;
  border-radius: 50%;
  content: ' ';
  height: 8px;
  left: 0;
  margin-left: -4px;
  margin-top: -4px;
  position: absolute;
  top: 50%;
  width: 8px;
}
.posts-collapse .collection-header {
  display: block;
  margin: 0 0 0 20px;
}
.posts-collapse .collection-header small {
  color: #bbb;
  margin-left: 5px;
}
.posts-collapse .post-header {
  border-bottom: 1px dashed #ccc;
  margin: 30px 0;
  padding-left: 15px;
  position: relative;
  transition-property: border;
  transition-delay: 0s;
  transition-duration: 0.2s;
  transition-timing-function: ease-in-out;
}
.posts-collapse .post-header::before {
  background: #bbb;
  border: 1px solid #fff;
  border-radius: 50%;
  content: ' ';
  height: 6px;
  left: 0;
  margin-left: -4px;
  position: absolute;
  top: 0.75em;
  transition-property: background;
  width: 6px;
  transition-delay: 0s;
  transition-duration: 0.2s;
  transition-timing-function: ease-in-out;
}
.posts-collapse .post-header:hover {
  border-bottom-color: #666;
}
.posts-collapse .post-header:hover::before {
  background: #222;
}
.posts-collapse .post-meta {
  display: inline;
  font-size: 0.75em;
  margin-right: 10px;
}
.posts-collapse .post-title {
  display: inline;
}
.posts-collapse .post-title a,
.posts-collapse .post-title span.exturl {
  border-bottom: none;
  color: var(--link-color);
}
.posts-collapse .post-title .fa-external-link-alt {
  font-size: 0.875em;
  margin-left: 5px;
}
.posts-collapse::before {
  background: #f5f5f5;
  content: ' ';
  height: 100%;
  left: 0;
  margin-left: -2px;
  position: absolute;
  top: 1.25em;
  width: 4px;
}
.post-eof {
  background: #ccc;
  height: 1px;
  margin: 80px auto 60px;
  text-align: center;
  width: 8%;
}
.post-block:last-of-type .post-eof {
  display: none;
}
.content {
  padding-top: 40px;
}
@media (min-width: 992px) {
  .post-body {
    text-align: justify;
  }
}
@media (max-width: 991px) {
  .post-body {
    text-align: justify;
  }
}
.post-body h1,
.post-body h2,
.post-body h3,
.post-body h4,
.post-body h5,
.post-body h6 {
  padding-top: 10px;
}
.post-body h1 .header-anchor,
.post-body h2 .header-anchor,
.post-body h3 .header-anchor,
.post-body h4 .header-anchor,
.post-body h5 .header-anchor,
.post-body h6 .header-anchor {
  border-bottom-style: none;
  color: #ccc;
  float: right;
  margin-left: 10px;
  visibility: hidden;
}
.post-body h1 .header-anchor:hover,
.post-body h2 .header-anchor:hover,
.post-body h3 .header-anchor:hover,
.post-body h4 .header-anchor:hover,
.post-body h5 .header-anchor:hover,
.post-body h6 .header-anchor:hover {
  color: inherit;
}
.post-body h1:hover .header-anchor,
.post-body h2:hover .header-anchor,
.post-body h3:hover .header-anchor,
.post-body h4:hover .header-anchor,
.post-body h5:hover .header-anchor,
.post-body h6:hover .header-anchor {
  visibility: visible;
}
.post-body iframe,
.post-body img,
.post-body video {
  margin-bottom: 20px;
}
.post-body .video-container {
  height: 0;
  margin-bottom: 20px;
  overflow: hidden;
  padding-top: 75%;
  position: relative;
  width: 100%;
}
.post-body .video-container iframe,
.post-body .video-container object,
.post-body .video-container embed {
  height: 100%;
  left: 0;
  margin: 0;
  position: absolute;
  top: 0;
  width: 100%;
}
.post-gallery {
  align-items: center;
  display: grid;
  grid-gap: 10px;
  grid-template-columns: 1fr 1fr 1fr;
  margin-bottom: 20px;
}
@media (max-width: 767px) {
  .post-gallery {
    grid-template-columns: 1fr 1fr;
  }
}
.post-gallery a {
  border: 0;
}
.post-gallery img {
  margin: 0;
}
.posts-expand .post-header {
  font-size: 1.125em;
}
.posts-expand .post-title {
  font-size: 1.5em;
  font-weight: normal;
  margin: initial;
  text-align: center;
  overflow-wrap: break-word;
  word-wrap: break-word;
}
.posts-expand .post-title-link {
  border-bottom: none;
  color: var(--link-color);
  display: inline-block;
  position: relative;
  vertical-align: top;
}
.posts-expand .post-title-link::before {
  background: var(--link-color);
  bottom: 0;
  content: '';
  height: 2px;
  left: 0;
  position: absolute;
  transform: scaleX(0);
  visibility: hidden;
  width: 100%;
  transition-delay: 0s;
  transition-duration: 0.2s;
  transition-timing-function: ease-in-out;
}
.posts-expand .post-title-link:hover::before {
  transform: scaleX(1);
  visibility: visible;
}
.posts-expand .post-title-link .fa-external-link-alt {
  font-size: 0.875em;
  margin-left: 5px;
}
.posts-expand .post-meta {
  color: #999;
  font-family: 'Lato', 'Lato', "PingFang SC", "Microsoft YaHei", sans-serif;
  font-size: 0.75em;
  margin: 3px 0 60px 0;
  text-align: center;
}
.posts-expand .post-meta .post-description {
  font-size: 0.875em;
  margin-top: 2px;
}
.posts-expand .post-meta time {
  border-bottom: 1px dashed #999;
  cursor: pointer;
}
.post-meta .post-meta-item + .post-meta-item::before {
  content: '|';
  margin: 0 0.5em;
}
.post-meta-divider {
  margin: 0 0.5em;
}
.post-meta-item-icon {
  margin-right: 3px;
}
@media (max-width: 991px) {
  .post-meta-item-icon {
    display: inline-block;
  }
}
@media (max-width: 991px) {
  .post-meta-item-text {
    display: none;
  }
}
.post-nav {
  border-top: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  margin-top: 15px;
  padding: 10px 5px 0;
}
.post-nav-item {
  flex: 1;
}
.post-nav-item a {
  border-bottom: none;
  display: block;
  font-size: 0.875em;
  line-height: 1.6;
  position: relative;
}
.post-nav-item a:active {
  top: 2px;
}
.post-nav-item .fa {
  font-size: 0.75em;
}
.post-nav-item:first-child {
  margin-right: 15px;
}
.post-nav-item:first-child .fa {
  margin-right: 5px;
}
.post-nav-item:last-child {
  margin-left: 15px;
  text-align: right;
}
.post-nav-item:last-child .fa {
  margin-left: 5px;
}
.rtl.post-body p,
.rtl.post-body a,
.rtl.post-body h1,
.rtl.post-body h2,
.rtl.post-body h3,
.rtl.post-body h4,
.rtl.post-body h5,
.rtl.post-body h6,
.rtl.post-body li,
.rtl.post-body ul,
.rtl.post-body ol {
  direction: rtl;
  font-family: UKIJ Ekran;
}
.rtl.post-title {
  font-family: UKIJ Ekran;
}
.post-tags {
  margin-top: 40px;
  text-align: center;
}
.post-tags a {
  display: inline-block;
  font-size: 0.8125em;
}
.post-tags a:not(:last-child) {
  margin-right: 10px;
}
.post-widgets {
  border-top: 1px solid #eee;
  margin-top: 15px;
  text-align: center;
}
.wp_rating {
  height: 20px;
  line-height: 20px;
  margin-top: 10px;
  padding-top: 6px;
  text-align: center;
}
.social-like {
  display: flex;
  font-size: 0.875em;
  justify-content: center;
  text-align: center;
}
.reward-container {
  margin: 20px auto;
  padding: 10px 0;
  text-align: center;
  width: 90%;
}
.reward-container button {
  background: #ff2a2a;
  border: 0;
  border-radius: 5px;
  color: #fff;
  cursor: pointer;
  line-height: 2;
  outline: 0;
  padding: 0 15px;
  vertical-align: text-top;
}
.reward-container button:hover {
  background: #f55;
}
#qr {
  padding-top: 20px;
}
#qr a {
  border: 0;
}
#qr img {
  display: inline-block;
  margin: 0.8em 2em 0 2em;
  max-width: 100%;
  width: 180px;
}
#qr p {
  text-align: center;
}
.category-all-page .category-all-title {
  text-align: center;
}
.category-all-page .category-all {
  margin-top: 20px;
}
.category-all-page .category-list {
  list-style: none;
  margin: 0;
  padding: 0;
}
.category-all-page .category-list-item {
  margin: 5px 10px;
}
.category-all-page .category-list-count {
  color: #bbb;
}
.category-all-page .category-list-count::before {
  content: ' (';
  display: inline;
}
.category-all-page .category-list-count::after {
  content: ') ';
  display: inline;
}
.category-all-page .category-list-child {
  padding-left: 10px;
}
.event-list {
  padding: 0;
}
.event-list hr {
  background: #222;
  margin: 20px 0 45px 0;
}
.event-list hr::after {
  background: #222;
  color: #fff;
  content: 'NOW';
  display: inline-block;
  font-weight: bold;
  padding: 0 5px;
  text-align: right;
}
.event-list .event {
  background: #222;
  margin: 20px 0;
  min-height: 40px;
  padding: 15px 0 15px 10px;
}
.event-list .event .event-summary {
  color: #fff;
  margin: 0;
  padding-bottom: 3px;
}
.event-list .event .event-summary::before {
  animation: dot-flash 1s alternate infinite ease-in-out;
  color: #fff;
  content: '\f111';
  display: inline-block;
  font-size: 10px;
  margin-right: 25px;
  vertical-align: middle;
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
}
.event-list .event .event-relative-time {
  color: #bbb;
  display: inline-block;
  font-size: 12px;
  font-weight: normal;
  padding-left: 12px;
}
.event-list .event .event-details {
  color: #fff;
  display: block;
  line-height: 18px;
  margin-left: 56px;
  padding-bottom: 6px;
  padding-top: 3px;
  text-indent: -24px;
}
.event-list .event .event-details::before {
  color: #fff;
  display: inline-block;
  margin-right: 9px;
  text-align: center;
  text-indent: 0;
  width: 14px;
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
}
.event-list .event .event-details.event-location::before {
  content: '\f041';
}
.event-list .event .event-details.event-duration::before {
  content: '\f017';
}
.event-list .event-past {
  background: #f5f5f5;
}
.event-list .event-past .event-summary,
.event-list .event-past .event-details {
  color: #bbb;
  opacity: 0.9;
}
.event-list .event-past .event-summary::before,
.event-list .event-past .event-details::before {
  animation: none;
  color: #bbb;
}
@-moz-keyframes dot-flash {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.8);
  }
}
@-webkit-keyframes dot-flash {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.8);
  }
}
@-o-keyframes dot-flash {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.8);
  }
}
@keyframes dot-flash {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.8);
  }
}
ul.breadcrumb {
  font-size: 0.75em;
  list-style: none;
  margin: 1em 0;
  padding: 0 2em;
  text-align: center;
}
ul.breadcrumb li {
  display: inline;
}
ul.breadcrumb li + li::before {
  content: '/\00a0';
  font-weight: normal;
  padding: 0.5em;
}
ul.breadcrumb li + li:last-child {
  font-weight: bold;
}
.tag-cloud {
  text-align: center;
}
.tag-cloud a {
  display: inline-block;
  margin: 10px;
}
.tag-cloud a:hover {
  color: var(--link-hover-color) !important;
}
.search-pop-overlay {
  background: rgba(0,0,0,0);
  height: 100%;
  left: 0;
  position: fixed;
  top: 0;
  transition: visibility 0s linear 0.2s, background 0.2s;
  visibility: hidden;
  width: 100%;
  z-index: 1400;
}
.search-pop-overlay.search-active {
  background: rgba(0,0,0,0.3);
  transition: background 0.2s;
  visibility: visible;
}
.search-popup {
  background: var(--card-bg-color);
  border-radius: 5px;
  height: 80%;
  left: calc(50% - 350px);
  position: fixed;
  top: 10%;
  transform: scale(0);
  transition: transform 0.2s;
  width: 700px;
  z-index: 1500;
}
.search-active .search-popup {
  transform: scale(1);
}
@media (max-width: 767px) {
  .search-popup {
    border-radius: 0;
    height: 100%;
    left: 0;
    margin: 0;
    top: 0;
    width: 100%;
  }
}
.search-popup .search-icon,
.search-popup .popup-btn-close {
  color: #999;
  font-size: 18px;
  padding: 0 10px;
}
.search-popup .popup-btn-close {
  cursor: pointer;
}
.search-popup .popup-btn-close:hover .fa {
  color: #222;
}
.search-popup .search-header {
  background: #eee;
  border-top-left-radius: 5px;
  border-top-right-radius: 5px;
  display: flex;
  padding: 5px;
}
.search-popup input.search-input {
  background: transparent;
  border: 0;
  outline: 0;
  width: 100%;
}
.search-popup input.search-input::-webkit-search-cancel-button {
  display: none;
}
.search-popup .search-input-container {
  flex-grow: 1;
  padding: 2px;
}
.search-popup ul.search-result-list {
  margin: 0 5px;
  padding: 0;
  width: 100%;
}
.search-popup p.search-result {
  border-bottom: 1px dashed #ccc;
  padding: 5px 0;
}
.search-popup a.search-result-title {
  font-weight: bold;
}
.search-popup .search-keyword {
  border-bottom: 1px dashed #ff2a2a;
  color: #ff2a2a;
  font-weight: bold;
}
.search-popup #search-result {
  display: flex;
  height: calc(100% - 55px);
  overflow: auto;
  padding: 5px 25px;
}
.search-popup #no-result {
  color: #ccc;
  margin: auto;
}
.header {
  margin: 0 auto;
  position: relative;
  width: calc(100% - 20px);
}
@media (min-width: 1200px) {
  .header {
    width: 1160px;
  }
}
@media (min-width: 1600px) {
  .header {
    width: 73%;
  }
}
@media (max-width: 991px) {
  .header {
    width: auto;
  }
}
.header-inner {
  background: var(--content-bg-color);
  border-radius: initial;
  box-shadow: initial;
  overflow: hidden;
  padding: 0;
  position: absolute;
  top: 0;
  width: 240px;
}
@media (min-width: 1200px) {
  .header-inner {
    width: 240px;
  }
}
@media (max-width: 991px) {
  .header-inner {
    border-radius: initial;
    position: relative;
    width: auto;
  }
}
.main-inner {
  align-items: flex-start;
  display: flex;
  justify-content: space-between;
  flex-direction: row-reverse;
}
@media (max-width: 991px) {
  .main-inner {
    width: auto;
  }
}
.content-wrap {
  background: var(--content-bg-color);
  border-radius: initial;
  box-shadow: initial;
  box-sizing: border-box;
  padding: 40px;
  width: calc(100% - 252px);
}
@media (max-width: 991px) {
  .content-wrap {
    border-radius: initial;
    padding: 20px;
    width: 100%;
  }
}
.footer-inner {
  padding-left: 260px;
}
.back-to-top {
  left: auto;
  right: 30px;
}
@media (max-width: 991px) {
  .back-to-top {
    right: 20px;
  }
}
@media (max-width: 991px) {
  .footer-inner {
    padding-left: 0;
    padding-right: 0;
    width: auto;
  }
}
.site-brand-container {
  background: #222;
}
@media (max-width: 991px) {
  .site-brand-container {
    box-shadow: 0 0 16px rgba(0,0,0,0.5);
  }
}
.site-meta {
  padding: 20px 0;
}
.brand {
  padding: 0;
}
.site-subtitle {
  margin: 10px 10px 0;
}
.custom-logo-image {
  margin-top: 20px;
}
@media (max-width: 991px) {
  .custom-logo-image {
    display: none;
  }
}
@media (min-width: 768px) and (max-width: 991px) {
  .site-nav-toggle,
  .site-nav-right {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
}
.site-nav-toggle .toggle,
.site-nav-right .toggle {
  color: #fff;
}
.site-nav-toggle .toggle .toggle-line,
.site-nav-right .toggle .toggle-line {
  background: #fff;
}
@media (min-width: 768px) and (max-width: 991px) {
  .site-nav {
    display: none;
  }
}
.menu .menu-item {
  display: block;
  margin: 0;
}
.menu .menu-item a,
.menu .menu-item span.exturl {
  padding: 5px 20px;
  position: relative;
  text-align: left;
  transition-property: background-color;
}
@media (max-width: 991px) {
  .menu .menu-item.menu-item-search {
    display: none;
  }
}
.menu .menu-item .badge {
  background: #ccc;
  border-radius: 10px;
  color: #fff;
  float: right;
  padding: 2px 5px;
  text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
  vertical-align: middle;
}
.main-menu .menu-item-active a::after {
  background: #bbb;
  border-radius: 50%;
  content: ' ';
  height: 6px;
  margin-top: -3px;
  position: absolute;
  right: 15px;
  top: 50%;
  width: 6px;
}
.sub-menu {
  background: var(--content-bg-color);
  border-bottom: 1px solid #ddd;
  margin: 0;
  padding: 6px 0;
}
.sub-menu .menu-item {
  display: inline-block;
}
.sub-menu .menu-item a,
.sub-menu .menu-item span.exturl {
  background: transparent;
  margin: 5px 10px;
  padding: initial;
}
.sub-menu .menu-item a:hover,
.sub-menu .menu-item span.exturl:hover {
  background: transparent;
  color: #fc6423;
}
.sub-menu .menu-item-active a {
  border-bottom-color: #fc6423;
  color: #fc6423;
}
.sub-menu .menu-item-active a:hover {
  border-bottom-color: #fc6423;
}
.sidebar {
  background: var(--body-bg-color);
  box-shadow: none;
  margin-top: 100%;
  position: static;
  width: 240px;
}
@media (max-width: 991px) {
  .sidebar {
    display: none;
  }
}
.sidebar-toggle {
  display: none;
}
.sidebar-inner {
  background: var(--content-bg-color);
  border-radius: initial;
  box-shadow: initial;
  box-sizing: border-box;
  color: var(--text-color);
  width: 240px;
  opacity: 0;
}
.sidebar-inner.affix {
  position: fixed;
  top: 12px;
}
.sidebar-inner.affix-bottom {
  position: absolute;
}
.site-state-item {
  padding: 0 10px;
}
.sidebar-button {
  border-bottom: 1px dotted #ccc;
  border-top: 1px dotted #ccc;
  margin-top: 10px;
  text-align: center;
}
.sidebar-button a {
  border: 0;
  color: #fc6423;
  display: block;
}
.sidebar-button a:hover {
  background: none;
  border: 0;
  color: #e34603;
}
.sidebar-button a:hover .fa,
.sidebar-button a:hover .fab,
.sidebar-button a:hover .far,
.sidebar-button a:hover .fas {
  color: #e34603;
}
.links-of-author {
  display: flex;
  flex-wrap: wrap;
  margin-top: 10px;
  justify-content: center;
}
.links-of-author-item {
  margin: 5px 0 0;
  width: 50%;
}
.links-of-author-item a,
.links-of-author-item span.exturl {
  box-sizing: border-box;
  display: inline-block;
  margin-bottom: 0;
  margin-right: 0;
  max-width: 216px;
  overflow: hidden;
  padding: 0 5px;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.links-of-author-item a,
.links-of-author-item span.exturl {
  border-bottom: none;
  display: block;
  text-decoration: none;
}
.links-of-author-item a::before,
.links-of-author-item span.exturl::before {
  display: none;
}
.links-of-author-item a:hover,
.links-of-author-item span.exturl:hover {
  background: var(--body-bg-color);
  border-radius: 4px;
}
.links-of-author-item .fa,
.links-of-author-item .fab,
.links-of-author-item .far,
.links-of-author-item .fas {
  margin-right: 2px;
}
.links-of-blogroll-item {
  padding: 0;
}
.post-body .link-grid {
  display: grid;
  grid-gap: 1.5rem 1.5rem;
  grid-template-columns: 1fr 1fr;
  padding: 1.5rem;
  user-select: none;
}
@media (max-width: 767px) {
  .post-body .link-grid {
    grid-template-columns: 1fr;
  }
}
.post-body .link-grid div {
  border: solid #ddd;
  box-shadow: 1rem 1rem 0.5rem #808080;
  height: 5rem;
  transition: background 0.3s;
  padding: 0.5rem;
  position: relative;
}
.post-body .link-grid div:hover {
  animation: shake 0.5s;
  background: rgba(230,244,250,0.5);
}
.post-body .link-grid div:active {
  box-shadow: 0.5rem 0.5rem 0.25rem #808080;
  transform: translate(0.2rem, 0.2rem);
}
.post-body .link-grid div img {
  border: 1px solid #ddd;
  border-radius: 50%;
  box-sizing: border-box;
  height: 5rem;
  left: 0.5rem;
  padding: 3px;
  position: absolute;
  top: 0.5rem;
  width: 5rem;
}
.post-body .link-grid div p {
  margin: 0 1rem 0 6rem;
}
.post-body .link-grid div p:first-of-type {
  font-size: 1.2em;
}
.post-body .link-grid div p:last-of-type {
  font-size: 0.8em;
  line-height: 1.3rem;
  opacity: 0.7;
}
.post-body .link-grid div a {
  border: none;
  height: 100%;
  left: 0;
  position: absolute;
  top: 0;
  width: 100%;
}
@-moz-keyframes shake {
  0% {
    transform: translate(1pt, 1pt) rotate(0deg);
  }
  10% {
    transform: translate(-1pt, -2pt) rotate(-1deg);
  }
  20% {
    transform: translate(-3pt, 0pt) rotate(1deg);
  }
  30% {
    transform: translate(3pt, 2pt) rotate(0deg);
  }
  40% {
    transform: translate(1pt, -1pt) rotate(1deg);
  }
  50% {
    transform: translate(-1pt, 2pt) rotate(-1deg);
  }
  60% {
    transform: translate(-3pt, 1pt) rotate(0deg);
  }
  70% {
    transform: translate(3pt, 1pt) rotate(-1deg);
  }
  80% {
    transform: translate(-1pt, -1pt) rotate(1deg);
  }
  90% {
    transform: translate(1pt, 2pt) rotate(0deg);
  }
  100% {
    transform: translate(1pt, -2pt) rotate(-1deg);
  }
}
@-webkit-keyframes shake {
  0% {
    transform: translate(1pt, 1pt) rotate(0deg);
  }
  10% {
    transform: translate(-1pt, -2pt) rotate(-1deg);
  }
  20% {
    transform: translate(-3pt, 0pt) rotate(1deg);
  }
  30% {
    transform: translate(3pt, 2pt) rotate(0deg);
  }
  40% {
    transform: translate(1pt, -1pt) rotate(1deg);
  }
  50% {
    transform: translate(-1pt, 2pt) rotate(-1deg);
  }
  60% {
    transform: translate(-3pt, 1pt) rotate(0deg);
  }
  70% {
    transform: translate(3pt, 1pt) rotate(-1deg);
  }
  80% {
    transform: translate(-1pt, -1pt) rotate(1deg);
  }
  90% {
    transform: translate(1pt, 2pt) rotate(0deg);
  }
  100% {
    transform: translate(1pt, -2pt) rotate(-1deg);
  }
}
@-o-keyframes shake {
  0% {
    transform: translate(1pt, 1pt) rotate(0deg);
  }
  10% {
    transform: translate(-1pt, -2pt) rotate(-1deg);
  }
  20% {
    transform: translate(-3pt, 0pt) rotate(1deg);
  }
  30% {
    transform: translate(3pt, 2pt) rotate(0deg);
  }
  40% {
    transform: translate(1pt, -1pt) rotate(1deg);
  }
  50% {
    transform: translate(-1pt, 2pt) rotate(-1deg);
  }
  60% {
    transform: translate(-3pt, 1pt) rotate(0deg);
  }
  70% {
    transform: translate(3pt, 1pt) rotate(-1deg);
  }
  80% {
    transform: translate(-1pt, -1pt) rotate(1deg);
  }
  90% {
    transform: translate(1pt, 2pt) rotate(0deg);
  }
  100% {
    transform: translate(1pt, -2pt) rotate(-1deg);
  }
}
@keyframes shake {
  0% {
    transform: translate(1pt, 1pt) rotate(0deg);
  }
  10% {
    transform: translate(-1pt, -2pt) rotate(-1deg);
  }
  20% {
    transform: translate(-3pt, 0pt) rotate(1deg);
  }
  30% {
    transform: translate(3pt, 2pt) rotate(0deg);
  }
  40% {
    transform: translate(1pt, -1pt) rotate(1deg);
  }
  50% {
    transform: translate(-1pt, 2pt) rotate(-1deg);
  }
  60% {
    transform: translate(-3pt, 1pt) rotate(0deg);
  }
  70% {
    transform: translate(3pt, 1pt) rotate(-1deg);
  }
  80% {
    transform: translate(-1pt, -1pt) rotate(1deg);
  }
  90% {
    transform: translate(1pt, 2pt) rotate(0deg);
  }
  100% {
    transform: translate(1pt, -2pt) rotate(-1deg);
  }
}
</style><noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<script>function loadCss(l){var d=document,h=d.head,s=d.createElement('link');s.rel='stylesheet';s.href=l;!function e(f){if (d.body)return f();setTimeout(function(){e(f)})}(function(){h.appendChild(s);});}loadCss('/style.css');loadCss('//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext');loadCss('//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css');loadCss('//cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css');</script><noscript><link rel="stylesheet" href="/style.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css"></noscript></head>

<body itemscope="" itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Leriou's Tavern</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">我可能就是在扯淡 ^_^!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="Searching..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://leriou.github.io/2019-04-01-recommended-system-filter-module-md/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="哎呀是太阳嘛">
      <meta itemprop="description" content="君子生非异也, 善假于物也">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leriou's Tavern">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019-04-01-recommended-system-filter-module-md/" class="post-title-link" itemprop="url">如何设计一个海量数据过滤模块</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-01 00:00:00" itemprop="dateCreated datePublished" datetime="2019-04-01T00:00:00+08:00">2019-04-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">系统设计</span></a>
                </span>
            </span>

          
            <span id="/2019-04-01-recommended-system-filter-module-md/" class="post-meta-item leancloud_visitors" data-flag-title="如何设计一个海量数据过滤模块" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019-04-01-recommended-system-filter-module-md/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019-04-01-recommended-system-filter-module-md/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a class="markdownIt-Anchor" href="#背景"></a> 背景</h1>
<p>所有的推荐系统都有一个基本的要求：<code>不给用户推荐重复的信息</code></p>
<p>这里的重复的信息有两层含义</p>
<ol>
<li>
<p>这个信息是id完全相同的一条信息<br>
这个很好理解，就是一模一样的两条信息，从数据库的角度将就是信息记录的主键id都相同<br>
如果用户已经接受过一次id为10086的信息的推荐，那这个10086就不能出现在后续的同类推荐中</p>
</li>
<li>
<p>这两个个信息相似度很高，但是id不同<br>
这种情况出现于两条信息内容相似，比如有两篇文章10001，10002都在说特朗普要在美国边境造墙的事情<br>
那如果用户观看过10001，此时再给用户推荐10002，就可能会让用户觉得推荐的东西已经看到过了，毫无意义</p>
</li>
</ol>
<h1 id="处理相同id的过滤"><a class="markdownIt-Anchor" href="#处理相同id的过滤"></a> 处理相同id的过滤</h1>
<p>我们的目的是给定一个id, 和一个已推荐集合，判断id是否在给定的集合以内</p>
<h2 id="hashmap的方案"><a class="markdownIt-Anchor" href="#hashmap的方案"></a> HashMap的方案</h2>
<p>如果集合数据量比较少的情况下，我们可以使用Java中的<code>HashSet</code>存储集合， 使用contains来直接判断id是否在给定集合中，其他编程语言中也都有类似<code>HashSet</code>的数据结构</p>
<p>由于<code>HashSet</code>的底层原理是使用的<code>HashMap</code>， 所以我直接使用 <code>HashMap</code>来进行原理的说明</p>
<p>这种做法的原理其实是先将我们要查找的数据进行hash散列，映射到一个固定长度的地址空间<br>
然后使用数组存储，如果有多个id经过hash映射到相同的地址空间那就做一个链表，存储相同hashcode对应的值</p>
<p>具体结构如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|0|1009|0|1008|1998|          // hash数组槽</span><br><span class="line">    ↓           ↓     </span><br><span class="line">   107          87            // 槽内的指针对应的数据</span><br><span class="line">    ↓            </span><br><span class="line">    16</span><br></pre></td></tr></tbody></table></figure>
<p>当我们查找id时， 也是先将要查找的id进行hash, 然后去对应的hashcode位置沿着链表/红黑树寻找是否有要查找的数字</p>
<h3 id="优点"><a class="markdownIt-Anchor" href="#优点"></a> 优点</h3>
<ol>
<li>使用简单，性能好，比较通用</li>
<li>容易理解，无误判</li>
</ol>
<h3 id="缺点"><a class="markdownIt-Anchor" href="#缺点"></a> 缺点</h3>
<ol>
<li>空间利用率太低</li>
</ol>
<h2 id="bitmap"><a class="markdownIt-Anchor" href="#bitmap"></a> Bitmap</h2>
<p>考虑到<code>HashMap</code>的空间利用率太低，不适合海量数据的存储，我们可以利用计算机存储的一些特性，用另外一种方式来。</p>
<p>我们都知道计算机底层是用bit来存储信息的，每个bit能存储一个0或者1的信息，如果我们使用二进制bit的位置信息来表示数字，对应位的bit值是1来代表这个数字存在，我们就可以在极小的空间存储大量的信息，使用时只需使用位运算，查看对应位置的bit值即可。</p>
<p>Java中的bitset，redis中的bit操作都提供了这种bitmap的实现，bitmap的详情可以查看 <a href="https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/">使用bitmap构建用户标签</a></p>
<p>如下表示 【6，4，3】的集合，第6，4，3位为1，其他位为0</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bit值     0 1 0 1 1 0 0 0        // 0x01011000</span><br><span class="line">bit位     7 6 5 4 3 2 1 0</span><br></pre></td></tr></tbody></table></figure>
<h3 id="优点-2"><a class="markdownIt-Anchor" href="#优点-2"></a> 优点</h3>
<ol>
<li>空间利用率高，性能好，无误判</li>
</ol>
<h3 id="缺点-2"><a class="markdownIt-Anchor" href="#缺点-2"></a> 缺点</h3>
<ol>
<li>不够通用，要求数据的类型必须是数字且元素范围跨度不能太大</li>
</ol>
<h2 id="bloomfilter"><a class="markdownIt-Anchor" href="#bloomfilter"></a> BloomFilter</h2>
<p>bloomfilter跟bitmap具有相似的原理， 都是使用位来存储信息，区别在于</p>
<p>bitmap使用元素自身数字对应的位置信息来存储数据，如果要存储的元素是个字符串或者其他类型的数据就无法使用这种方式了，或者你要存储的数字范围特别的大，比如你要存储一个100亿的数字， 那样即使只有一个数字你也需要一个前面的位置都是0的100亿bit来表示，对空间的利用率还是不高 (现在有一些空间压缩的bitmap实现能一定程度解决数据范围分布过大和分布稀疏的问题)</p>
<p>BloomFilter就是针对这些做了优化，如果我们把要处理的数字进行hash, 映射到一个固定长度的地址空间，这样就同时解决了以上两个问题， 即缩减了映射的空间范围，又可以存储更通用的对象。但是由于hash函数本身会有冲突，就会出现两个不同元素因为同样的hashcode而产生误判的情况。</p>
<p><strong>既如果判定结果是不存在(False)，则一定不存在；但是如果判定结果是存在(True)，则实际情况其实是可能存在，而不是一定存在，即假阳性。</strong></p>
<h3 id="误判率的计算"><a class="markdownIt-Anchor" href="#误判率的计算"></a> 误判率的计算</h3>
<p>我们假设</p>
<ul>
<li>欲插入Bloom Filter中的元素数目: n</li>
<li>Bloom Filter误判率: P(true)</li>
<li>BitArray数组的大小: m</li>
<li>Hash Function的数目: k</li>
</ul>
<p>则有误判率：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>t</mi><mi>r</mi><mi>u</mi><mi>e</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><msubsup><mi>P</mi><mn>1</mn><mi>n</mi></msubsup><msup><mo stretchy="false">)</mo><mi>k</mi></msup><mo>=</mo><mo stretchy="false">[</mo><mn>1</mn><mo>−</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mfrac><mn>1</mn><mi>m</mi></mfrac><msup><mo stretchy="false">)</mo><mi>k</mi></msup><mi>n</mi><msup><mo stretchy="false">]</mo><mi>k</mi></msup></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(1)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">P(true) = (P^n_1)^k=[1-(1-\frac{1}{m})^kn]^k \tag{1}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">u</span><span class="mord mathdefault">e</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.149108em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">m</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span><span class="mord mathdefault">n</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">1</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>即：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>t</mi><mi>r</mi><mi>u</mi><mi>e</mi><mo stretchy="false">)</mo><mo>≈</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msup><mi>e</mi><mrow><mo>−</mo><mfrac><mrow><mi>n</mi><mi>k</mi></mrow><mi>m</mi></mfrac></mrow></msup><msup><mo stretchy="false">)</mo><mi>k</mi></msup></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(2)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">P(true)\approx(1-e^{-\frac{nk}{m}})^k \tag{2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">u</span><span class="mord mathdefault">e</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.27902em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.02902em;"><span style="top:-3.4130000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8800285714285714em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:1.27902em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">2</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>也就是说当BitArray数组的大小m增大 或 欲插入Bloom Filter中的元素数目n 减小时，均可以使得误判率P(true)下降</p>
<h3 id="至于hash-function的数目k"><a class="markdownIt-Anchor" href="#至于hash-function的数目k"></a> 至于hash function的数目k</h3>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msup><mi>e</mi><mrow><mo>−</mo><mfrac><mrow><mi>n</mi><mi>k</mi></mrow><mi>m</mi></mfrac></mrow></msup><msup><mo stretchy="false">)</mo><mi>k</mi></msup></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(3)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">f(k)=(1-e^{-\frac{nk}{m}})^k \tag{3}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.27902em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.02902em;"><span style="top:-3.4130000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8800285714285714em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:1.27902em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">3</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>令  <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi><mo>=</mo><msup><mi>e</mi><mfrac><mrow><mi>n</mi><mi>k</mi></mrow><mi>m</mi></mfrac></msup></mrow><annotation encoding="application/x-tex">a=e^{\frac{nk}{m}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.97902em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.97902em;"><span style="top:-3.363em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8800285714285714em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span></span></span></span> ，则有：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><msup><mo stretchy="false">)</mo><mi>k</mi></msup></mrow><annotation encoding="application/x-tex">f(k)=(1-e^{-1})^k
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.149108em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>分别对上式两边，先取对数，再对k求一次导，可有：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mn>1</mn><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></mfrac><mi>f</mi><mo stretchy="false">(</mo><msup><mi>k</mi><mo mathvariant="normal">′</mo></msup><mo stretchy="false">)</mo><mo>=</mo><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msup><mi>a</mi><mrow><mo>−</mo><mi>k</mi></mrow></msup><mo stretchy="false">)</mo><mo>+</mo><mfrac><mrow><mi>k</mi><msup><mi>a</mi><mrow><mo>−</mo><mi>k</mi></mrow></msup><mi>ln</mi><mo>⁡</mo><mi>a</mi></mrow><mrow><mn>1</mn><mo>−</mo><msup><mi>a</mi><mrow><mo>−</mo><mi>k</mi></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{f(k)}f(k')=\ln(1-a^{-k})+\frac{ka^{-k} \ln a}{1-a^{-k}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.25744em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.149108em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.295438em;vertical-align:-0.7693300000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5261079999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7751079999999999em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">ln</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>易知，当k取极值点时，有 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>k</mi><msup><mo stretchy="false">)</mo><mo mathvariant="normal">′</mo></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">f(k)'=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.001892em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> ，故将其带入上式即可求出k</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msup><mi>a</mi><mrow><mo>−</mo><mi>k</mi></mrow></msup><mo stretchy="false">)</mo><mo>+</mo><mfrac><mrow><mi>k</mi><msup><mi>a</mi><mrow><mo>−</mo><mi>k</mi></mrow></msup><mi>ln</mi><mo>⁡</mo><mi>a</mi></mrow><mrow><mn>1</mn><mo>−</mo><msup><mi>a</mi><mrow><mo>−</mo><mi>k</mi></mrow></msup></mrow></mfrac><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\ln(1-a^{-k})+\frac{ka^{-k} \ln a}{1-a^{-k}}=0
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.149108em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.295438em;vertical-align:-0.7693300000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5261079999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7751079999999999em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">ln</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>=</mo><mo>&gt;</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msup><mi>a</mi><mrow><mo>−</mo><mi>k</mi></mrow></msup><mo stretchy="false">)</mo><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msup><mi>a</mi><mrow><mo>−</mo><mi>k</mi></mrow></msup><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><mi>k</mi><msup><mi>a</mi><mrow><mo>−</mo><mi>k</mi></mrow></msup><mi>ln</mi><mo>⁡</mo><mi>a</mi></mrow><annotation encoding="application/x-tex">=&gt;  (1-a^{-k}) \ln(1-a^{-k})=-ka^{-k} \ln a
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.149108em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.149108em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.9824379999999999em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">ln</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">a</span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>=</mo><mo>&gt;</mo><msup><mi>e</mi><mrow><mo>−</mo><mfrac><mrow><mi>k</mi><mi>n</mi></mrow><mi>m</mi></mfrac></mrow></msup><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">=&gt;  e^{-\frac{kn}{m}}=\frac{1}{2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.02902em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.02902em;"><span style="top:-3.4130000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8800285714285714em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>=</mo><mo>&gt;</mo><mi>k</mi><mo>=</mo><mfrac><mi>m</mi><mi>n</mi></mfrac><mi>ln</mi><mo>⁡</mo><mn>2</mn><mo>≈</mo><mn>0.7</mn><mfrac><mi>m</mi><mi>n</mi></mfrac></mrow><annotation encoding="application/x-tex">=&gt;  k=\frac{m}{n}\ln2\approx0.7\frac{m}{n}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.7935600000000003em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">ln</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.7935600000000003em;vertical-align:-0.686em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">7</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>所以我们通过调整k的值也能一定程度上降低误判率， 但是基于概率的问题，误判率依然存在。所以这种方法适合于允许一定误判率，并拥有海量数据要过滤的场景</p>
<h3 id="优点-3"><a class="markdownIt-Anchor" href="#优点-3"></a> 优点</h3>
<ol>
<li>通用，空间效率高，灵活，可以在性能和误判率之间做取舍</li>
</ol>
<h3 id="缺点-3"><a class="markdownIt-Anchor" href="#缺点-3"></a> 缺点</h3>
<ol>
<li>有误判，性能不如bitmap</li>
</ol>
<h1 id="处理相似文本的重复"><a class="markdownIt-Anchor" href="#处理相似文本的重复"></a> 处理相似文本的重复</h1>
<p>能处理相同的id造成的重复之后，如果我们可以找出一个文章的相似内容， 只要把相似的内容id也添加到需要过滤的集合， 就可以完成对相似内容的过滤</p>
<h2 id="simhash"><a class="markdownIt-Anchor" href="#simhash"></a> simhash</h2>
<p>如果只是检测一模一样的两个字符串，那我们完全可以采用md5之类的摘要算法， 但是这种方法对文章内容又哪怕一个字的差别，就不再适用</p>
<p>所以我们使用<code>simhash</code>来处理内容相似度的问题</p>
<p>simhash的核心思想是先提取文章的最重要核心特征， 如果两篇文章的核心特征重复度较高，那就有可能是相似文章，具体步骤如下</p>
<ol>
<li>我们先对文本进行分词，并计算每个词的权重</li>
<li>对每个词进行hash，并把hash结果的对应二进制位的 0 变为 -1</li>
<li>把每个文章的每个词的处理过的 hash值 x 权重，得到加权向量，并把每个加权向量相加得到最终向量</li>
<li>把这个最终向量中的负数变为0，正数变为1</li>
</ol>
<p>然后通过汉明距离比较二进制位不同的个数，其实就是计算两个指纹的异或结果，结果中如果包含较少的1， 比如小于3个， 那就说明内容相同</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://leriou.github.io/2019-01-09-mongodb-compareto-elasticsearch/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="哎呀是太阳嘛">
      <meta itemprop="description" content="君子生非异也, 善假于物也">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leriou's Tavern">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019-01-09-mongodb-compareto-elasticsearch/" class="post-title-link" itemprop="url">MongoDB和Elasticsearch的对比</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-01-09 00:00:00" itemprop="dateCreated datePublished" datetime="2019-01-09T00:00:00+08:00">2019-01-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">编程工具</span></a>
                </span>
            </span>

          
            <span id="/2019-01-09-mongodb-compareto-elasticsearch/" class="post-meta-item leancloud_visitors" data-flag-title="MongoDB和Elasticsearch的对比" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019-01-09-mongodb-compareto-elasticsearch/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019-01-09-mongodb-compareto-elasticsearch/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mongodb-vs-elasticsearch"><a class="markdownIt-Anchor" href="#mongodb-vs-elasticsearch"></a> MongoDB  vs Elasticsearch</h1>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">MongoDB</th>
<th style="text-align:center">ElasticSearch</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">定位</td>
<td style="text-align:center">(文档型)数据库</td>
<td style="text-align:center">(文档型)搜索引擎</td>
<td>一个管理数据,一个检索数据</td>
</tr>
<tr>
<td style="text-align:center">资源占用</td>
<td style="text-align:center">一般</td>
<td style="text-align:center">高</td>
<td>mongo使用c++, es使用Java开发</td>
</tr>
<tr>
<td style="text-align:center">写入延迟</td>
<td style="text-align:center">低</td>
<td style="text-align:center">高</td>
<td>es的写入延迟默认1s, 可配置, 但是要牺牲一些东西</td>
</tr>
<tr>
<td style="text-align:center">全文索引支持度</td>
<td style="text-align:center">一般</td>
<td style="text-align:center">非常好</td>
<td>es本来就是搜索引擎, 这个没啥可比性</td>
</tr>
<tr>
<td style="text-align:center">有无Schema</td>
<td style="text-align:center">无</td>
<td style="text-align:center">无</td>
<td>两者都是无Schema</td>
</tr>
<tr>
<td style="text-align:center">支持的数据量</td>
<td style="text-align:center">PB+</td>
<td style="text-align:center">TB+  ~ PB</td>
<td>两者支持的量并不好说的太死, 都支持分片和横向扩展, 但是相对来说MongoDB的数据量支持要更大一点</td>
</tr>
<tr>
<td style="text-align:center">性能</td>
<td style="text-align:center">非常好</td>
<td style="text-align:center">好</td>
<td>MongoDB在大部分场景性能比es强的多得多</td>
</tr>
<tr>
<td style="text-align:center">索引结构</td>
<td style="text-align:center">B树</td>
<td style="text-align:center">LSM树</td>
<td>es追求写入吞吐量, MongoDB读写比较均衡</td>
</tr>
<tr>
<td style="text-align:center">操作接口</td>
<td style="text-align:center">TCP</td>
<td style="text-align:center">Restful(Http)</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">是否支持分片</td>
<td style="text-align:center">是</td>
<td style="text-align:center">是</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">是否支持副本</td>
<td style="text-align:center">是</td>
<td style="text-align:center">是</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">选主算法</td>
<td style="text-align:center">Bully(霸凌)</td>
<td style="text-align:center">Bully(霸凌)</td>
<td>相比于Paxos和Raft算法实现更简单并有一定可靠性上的妥协，但是选举速度比较快</td>
</tr>
<tr>
<td style="text-align:center">扩展难度</td>
<td style="text-align:center">容易</td>
<td style="text-align:center">非常容易</td>
<td>es真的是我用过的扩展最方便的存储系统之一</td>
</tr>
<tr>
<td style="text-align:center">配置难度</td>
<td style="text-align:center">难</td>
<td style="text-align:center">非常容易</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">地理位置</td>
<td style="text-align:center">支持</td>
<td style="text-align:center">支持</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">运维工具</td>
<td style="text-align:center">丰富</td>
<td style="text-align:center">一般</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">插件和引擎</td>
<td style="text-align:center">有多个存储引擎供选择</td>
<td style="text-align:center">有大量插件可以使用</td>
<td>-</td>
</tr>
</tbody>
</table>
<h1 id="两者的定位"><a class="markdownIt-Anchor" href="#两者的定位"></a> 两者的定位</h1>
<p><code>MongoDB</code>和<code>Elasticsearch</code>都属于NoSQL大家族, 且都属于文档型数据存储</p>
<p>所以这两者的很多功能和特性高度重合, 但其实两者定位完全不同</p>
<p>MongoDB 是 <strong>文档型数据库</strong>,  提供 <strong>数据存储和管理服务</strong><br>
Elasticsearch 是<strong>搜索服务</strong>, 提供 <strong>数据检索服务</strong></p>
<p>两者的很大区别在于源数据的存储和管理</p>
<ul>
<li>MongoDB作为一个数据库产品, 是拥有源数据管理能力的</li>
<li>Elasticsearch作为一个搜索引擎, 定位是<strong>提供数据检索服务</strong>, 也就是说我只管查, 不管写 <sup>_</sup>, Elasticsearch的Mapping不可变也是为此服务的, 带来的代价就是<code>es不适合作为数据管理者</code>, es可以从其他数据源同步数据过来提供查询, 但是不适合自己对数据进行存储和管理</li>
</ul>
<p>es更侧重数据的查询, 各种复杂的花式查询支持的很好, 相比来说 MongoDB的查询能力就显得比较平庸了</p>
<p>由此可见, 对于个人, 如果你有一批数据要看, 但是不经常进行修改, 这个时候毫无疑问可以用es, 但是如果你还打算继续修改数据, 最好就是使用MongoDB，但其实对大多数人公司来讲，这两者的数据管理能力并没有多大的影响</p>
<blockquote>
<p>ps: es修改Mapping的代价非常高, 所以我们一般都是把新数据重新写入一份新索引，然后直接切换读取的别名到新的索引</p>
</blockquote>
<h1 id="两者读写数据的异同"><a class="markdownIt-Anchor" href="#两者读写数据的异同"></a> 两者读写数据的异同</h1>
<p><code>MongoDB</code>和<code>ElasticSearch</code>都支持全文索引, 虽然MongoDB的全文索引效果完全无法跟es相比(es毕竟是专业的搜索引擎产品, 着重提供数据的检所支持, 这方面吊打MongoDB也是可以理解的)</p>
<p>MongoDB虽然在支持的部分查询功能上稍微弱于es, 但是在大部分场景下性能方面完爆es, 不管是读性能, 还是写性能</p>
<p>es的写入延迟默认为1s, 这个虽然是写入延迟的范畴, 但是毫无疑问是一大缺点, 虽然可以配置为更短的时间, 但是这样就要牺牲一定的数据吞吐量, 会造成更频繁的磁盘刷新操作</p>
<p>es底层使用<code>Lucene</code>作为核心引擎, 很多es的设计就是为了匹配Lucene中的概念, 其实es可以看成一个lucene的proxy层包装,将lucene的原生接口封装的更好用, 同时还实现了很多管理和监控等辅助功能, 但是整体来说es上层的模块和lucene的隔阂还是挺明显的, 耦合度上有一定的欠缺</p>
<p>MongoDB则是完整的一个单体数据库产品, 虽然内部的存储引擎也是可插拔式的, 整体而言还是更加的浑然一体</p>
<blockquote>
<p>MongoDB支持多种存储引擎, 本文所有涉及mongo存储引擎的只谈默认的WiredTiger引擎, 其实还有某些方面更优秀的其他引擎,例如: MongoRocks等</p>
</blockquote>
<h1 id="部署和资源占用"><a class="markdownIt-Anchor" href="#部署和资源占用"></a> 部署和资源占用</h1>
<p>单机部署的话其实MongoDB和Elasticsearch都十分的方便, 不过es相对来说资源占用更多一点, 性能也比MongoDB要弱一点</p>
<p>集群化的部署, 我们一般都会选择分片+副本的部署方式, 这种方式下, es部署起来比MongoDB方便太多, MongoDB要部署一套完整的分片 + 副本模式还是比较麻烦的, 没有经验的人部署起来需要一定的学习成本</p>
<p>资源占用方面, MongoDB可以支持存储文件类型的数据, 作为数据库也有数据压缩能力, es则因为大量的索引存在需要占用大量的磁盘和内存空间</p>
<h1 id="可用性和容错"><a class="markdownIt-Anchor" href="#可用性和容错"></a> 可用性和容错</h1>
<p>MongoDB和ElasticSearch作为天生分布式的代表产品都支持数据分片和副本</p>
<p>两者都通过分片支持水平扩展, 同时都通过副本来支持高可用(HA)</p>
<p>分片就是一个数据集的数据分为多份, 同时分布在多个节点上存储和管理, 主流分片方式有两种: hash分片和range分片, 两种分片方式各有优势, 适合不同的场景</p>
<p>副本就是一份数据集同时有一个或者多个复制品(有些地方叫主从), 每份复制品都一模一样, 但是为了保证数据的一致性, 往往多个副本中只有一个作为Primary副本(通过选主算法从多个副本中选出Primary), 提供写服务, 其他副本只提供读, 或者只提供备份服务</p>
<blockquote>
<p>ps:es和MongoDB都可以通过副本增强读能力, 这与kafka很不一样(kafka的副本只有备份功能)</p>
</blockquote>
<h2 id="两者分布式方案的一些不同"><a class="markdownIt-Anchor" href="#两者分布式方案的一些不同"></a> 两者分布式方案的一些不同</h2>
<p>MongoDB和Elasticsearch虽然都是分布式服务, 但是还是有一些不同方案的选择的</p>
<ul>
<li>分片和副本单位的划分</li>
</ul>
<p>MongoDB是以节点为单位划分角色, 一旦一个节点被指定为副本, 其上面的数据都是副本</p>
<p>Elasticsearch是以分片为单位划分角色, 一个节点上即可以拥有某分片的主分片和可以同时拥有另一个分片的副本分片, 同时es还支持自动的副本负载均衡, 如果一个新节点上面什么数据都没有, 系统会自动分配分片数据过来</p>
<ul>
<li>架构模式</li>
</ul>
<p>MongoDB的副本和分片是两种不同的模式, 虽然可以同时使用但是依然有各自的架构设计, 用户可以任意选择选型进行搭配, 每个节点的职责更加专一, 方便据此调整机器配置和进行优化</p>
<p>Elasticsearch中的分片 + 副本是一套统一的架构设计, 每个节点具有接近同等的地位, 配置使用起来更加简单, 但是如果要针对节点所负责的功能对机器进一步做定制就不如MongoDB灵活</p>
<h1 id="文档型数据库的特点和问题"><a class="markdownIt-Anchor" href="#文档型数据库的特点和问题"></a> 文档型数据库的特点和问题</h1>
<h2 id="无schema"><a class="markdownIt-Anchor" href="#无schema"></a> 无schema</h2>
<p>文档型数据存储既能享受无schema限制带来的灵活, 又能享受索引查询的快速和类SQL查询的便捷</p>
<p>使他们用起来不像传统的RDBMS那么麻烦, 又不像 Redis,Hbase这种数据库查询功能不够强大, 处在一个传统RDBMS和经典K-V存储之间的比较均衡的位置</p>
<p>我个人很喜欢这个特性, 没有schema的限制, 存储数据更方便也更灵活了, 但是有得有失, 很多固定schema的好处就无法享受到了, 比如: 对数据的高效压缩</p>
<h2 id="鸡肋的collection-和-type"><a class="markdownIt-Anchor" href="#鸡肋的collection-和-type"></a> 鸡肋的Collection 和 Type</h2>
<p>早期为了跟传统rdbms数据库保持概念一致 ，mongodb和elasticsearch都设计了跟传统数据库里面的<code>库-&gt;表-&gt;记录行</code>对应的概念，具体如下</p>
<table>
<thead>
<tr>
<th>RDBMS</th>
<th>MongoDB</th>
<th>Elasticsearch</th>
</tr>
</thead>
<tbody>
<tr>
<td>库</td>
<td>库</td>
<td>索引</td>
</tr>
<tr>
<td>表</td>
<td>集合</td>
<td>类型</td>
</tr>
<tr>
<td>记录</td>
<td>文档</td>
<td>文档</td>
</tr>
</tbody>
</table>
<p>其实对于nosql数据库来讲, 集合/类型的意义其实不大, Nosql数据库几乎都是k-v类型的存储结构，完全可以通过key进行业务隔离和区分，真的没有必要为了跟传统数据库对应强行搞出来一个中间概念 <sup>_</sup></p>
<p>Elasticsearch从<code>6.x</code>版本开始强制只允许一个索引使用一个type, 其实就是意识到这个这个设计的失误, 不想让你用这个type类型, 因为type和传统数据库里面的表概念其实是不一样的，这种概念类比给人造成了误解，到了es的7.x版本会默认取消type类型, 就说明这个type字段真的是鸡肋的不行</p>
<h2 id="弱事务"><a class="markdownIt-Anchor" href="#弱事务"></a> 弱事务</h2>
<p>MongoDB以前只是支持同一文档内的原子更新, 以此来实现伪事务功能, 不过Mongo4.0支持Replica Set事务, 大大加强了事务方面的能力</p>
<p>es在这方面倒没有什么进展，因为从应用场景上es对事务的需求不高，不过用户其实也可以使用同文档更新或者通过程序自己来实现事务机制</p>
<h2 id="无join支持"><a class="markdownIt-Anchor" href="#无join支持"></a> 无join支持</h2>
<p>文档型数据库大多数都不支持join(也有少量支持的), 但是我一般也用不上多表join的功能, 即便真的需要使用join也可以通过应用层或者通过耦合数据来实现（不过据说未来Mongo4.2版本会带来对join的支持）</p>
<p>不支持join带来的问题就是我们需要自己对数据进行连接, 但是这在擅长使用分布式计算的大数据领域不算什么问题, 相应的缺少join功能可能对善于使用SQL的数据分析师就不大友好</p>
<h2 id="bully的选主算法的缺陷"><a class="markdownIt-Anchor" href="#bully的选主算法的缺陷"></a> Bully的选主算法的缺陷</h2>
<p>elasticsearch和MongoDB选择的选主算法实现很简单, 但是代价就是有几率出现脑裂的情况, 当然, 具体情况跟配置也有关系(比如:你有三个es节点但是设置的最小主节点数为1, 将最小主节点数设置为2可以避免脑裂情况)</p>
<p>不过脑裂问题一方面发生概率较低，另一方面即使出现了脑裂的情况, 使用<code>重启大法</code>一般就能解决 <sup>_</sup></p>
<p>总体来说, 这方面不如使用Paxos和Raft算法或者使用zk做协调器的其他分布式系统靠谱</p>
<h1 id="其他"><a class="markdownIt-Anchor" href="#其他"></a> 其他</h1>
<ul>
<li>运维工具</li>
</ul>
<p>两者背后都有商业公司的支持</p>
<p>MongoDB的很多客户端和运维工具更丰富, 但是MongoDB作为一个数据库产品, 相对应的对运维人员的要求也要更高一点</p>
<p>Elasticsearch则有整套的数据分析和收集工具提供, 配套的kibana就是一个很不错的管控es的工具</p>
<ul>
<li>操作接口</li>
</ul>
<p>es使用Restful来提供统一的操作接口, 屏蔽了各种语言之间的障碍, 但是同样带来了表达能力和性能的损失</p>
<p>MongoDB则使用TCP, 降低了序列化和网络这一层的性能损耗, 并最大程度保留了接口的内容表达能力, 但是相对的使用起来就不如http那么的方便</p>
<h1 id="适用场景"><a class="markdownIt-Anchor" href="#适用场景"></a> 适用场景</h1>
<p>两者其实在很多使用场景上有重合之处, 是可以互相替代, 比如日志收集</p>
<p>但是某些方面两者又各有特色，比如： 如果打算使用一个文档型的业务数据库， 那最好还是选mongodb, 如果你有要求复杂查询又并发性能要求高的场景，类似搜索服务，那最好的选择是elasticsearch</p>
<p>除此之外：</p>
<p>MongoDB有多个存储引擎可以选择, 而且MongoDB不仅看重数据的分析, 对数据的管理同样看重, 总的来说MongoDB更倾向于数据的存储和管理, 可以作为数据源对外提供， 未来说不定还会有支持join和支持倒排索引的mongo引擎出现</p>
<p>Elasticsearch则有很多插件可以使用, 相对来讲Elasticsearch更倾向于数据的查询, 一般情况下elasticsearch仅作为数据检索服务和数据分析平台, 不直接作为源数据管理者</p>
<ul>
<li>MongoDB适合</li>
</ul>
<ol>
<li>对服务可用性和一致性有高要求</li>
<li>无schema的数据存储 + 需要索引数据</li>
<li>高读写性能要求, 数据使用场景简单的海量数据场景</li>
<li>有热点数据, 有数据分片需求的数据存储</li>
<li>日志, html, 爬虫数据等半结构化或图片，视频等非结构化数据的存储</li>
<li>有js使用经验的人员(MongoDB内置操作语言为js)</li>
</ol>
<ul>
<li>Elasticsearch适合</li>
</ul>
<ol>
<li>已经有其他系统负责数据管理</li>
<li>对复杂场景下的查询需求，对查询性能有要求, 对写入及时性要求不高的场景</li>
<li>监控信息/日志信息检索</li>
<li>小团队但是有多语言服务，es拥有restful接口，用起来最方便</li>
</ol>
<h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1>
<p>MongoDB和Elasticsearch都是我比较喜欢的存储产品</p>
<p>两者的功能特性也存在很多重合的地方, 其实现在很多数据库产品都在互相借(chao)鉴(xi), 功能和特性都在逐渐变得相似, 这也是未来很多存储产品的发展趋势, 大家都希望自己能覆盖尽量多的场景和用户群体</p>
<p>很多产品总是在不断的从<code>没有</code>-&gt;<code>有</code>-&gt;<code>功能丰富</code>,但是功能丰富一定是做了很多的妥协, 于是又有了 <code>功能众多的单体服务</code>-&gt;<code>多个功能单一的子服务</code> 方向的转变,就像三国里面说的 “天下大势, 分久必合合久必分”.</p>
<p>现在NoSQL数据库产品就在这个路上, NoSQL归根到底都是 RDBMS的某个方面的妥协, 现在各种NoSQL 也都在加入对经典SQL和传统RDBMS的 join, 事务的支持, 但是我相信等到两者区别足够小的时候, 一定会有放弃了大而全, 而专注于某一场景的新的存储产品出现，到时候搞不好又是一波新的Nosql潮流</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://leriou.github.io/2019-01-01-summary-md/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="哎呀是太阳嘛">
      <meta itemprop="description" content="君子生非异也, 善假于物也">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leriou's Tavern">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019-01-01-summary-md/" class="post-title-link" itemprop="url">2019年记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-01-01 09:16:10" itemprop="dateCreated datePublished" datetime="2019-01-01T09:16:10+08:00">2019-01-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%9F%E6%B4%BB%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">生活记录</span></a>
                </span>
            </span>

          
            <span id="/2019-01-01-summary-md/" class="post-meta-item leancloud_visitors" data-flag-title="2019年记录" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="2019"><a class="markdownIt-Anchor" href="#2019"></a> 2019</h1>
<h1 id="1月"><a class="markdownIt-Anchor" href="#1月"></a> 1月</h1>
<p>看书:</p>
<ul>
<li>[ ] 神经网络与深度学习</li>
<li>[ ] 深入理解Java虚拟机</li>
</ul>
<h1 id="2月"><a class="markdownIt-Anchor" href="#2月"></a> 2月</h1>
<p>看书:</p>
<ul>
<li>[ ] 设计数据密集型应用</li>
</ul>
<h1 id="3月"><a class="markdownIt-Anchor" href="#3月"></a> 3月</h1>
<p>看书:</p>
<ul>
<li>[x] 富爸爸穷爸爸</li>
</ul>
<h1 id="4月"><a class="markdownIt-Anchor" href="#4月"></a> 4月</h1>
<p>看书:</p>
<ul>
<li>[ ] 一本书看懂经济学</li>
<li>[x] 从零开始学炒股</li>
<li>[ ] 设计数据密集型应用</li>
<li>[ ] 剑指offer</li>
</ul>
<h1 id="5月"><a class="markdownIt-Anchor" href="#5月"></a> 5月</h1>
<p>看书:</p>
<ul>
<li>[x] 设计数据密集型应用</li>
<li>[ ] 股市真规则</li>
<li>[x] hbase权威指南</li>
</ul>
<h1 id="6月"><a class="markdownIt-Anchor" href="#6月"></a> 6月</h1>
<ul>
<li>[ ] 剑指offer</li>
<li>[ ] 深入理解Java虚拟机</li>
<li>[ ] 推荐系统三十六式(在线课程)</li>
<li>[x] 数据结构与算法之美(在线课程)</li>
<li>[x] 大规模数据处理实战(在线课程)</li>
<li>[ ] Mysql实战45讲(在线课程)</li>
<li>[ ] Java核心技术36讲(在线课程)</li>
</ul>
<h1 id="7月"><a class="markdownIt-Anchor" href="#7月"></a> 7月</h1>
<ul>
<li>[x] 推荐系统三十六式(在线课程)</li>
<li>[ ] 从一到无穷大</li>
<li>[ ] 海龟交易法则</li>
</ul>
<h1 id="8月"><a class="markdownIt-Anchor" href="#8月"></a> 8月</h1>
<ul>
<li>[x] Java核心技术36讲(在线课程)</li>
<li>[x] rust程序设计语言</li>
</ul>
<h1 id="9月"><a class="markdownIt-Anchor" href="#9月"></a> 9月</h1>
<ul>
<li>[x] 数学之美</li>
<li>[ ] 剑指offer</li>
<li>[x] 深入理解Java虚拟机</li>
<li>[x] 从0开始学大数据(在线课程)</li>
</ul>
<h1 id="10月"><a class="markdownIt-Anchor" href="#10月"></a> 10月</h1>
<ul>
<li>[ ] Mysql实战45讲(在线课程)</li>
<li>[ ] 从一到无穷大</li>
<li>[x] 阶层越迁</li>
<li>[x] kafka核心技术与实战(在线课程)</li>
<li>[x] 小岛经济学</li>
<li>[ ] Java编程的逻辑</li>
<li>[x] 走进搜索引擎（第二遍）</li>
</ul>
<h1 id="11月"><a class="markdownIt-Anchor" href="#11月"></a> 11月</h1>
<ul>
<li>[ ] 思考，快与慢</li>
<li>[ ] Java编程的逻辑</li>
<li>[x] 用户行为网络画像</li>
<li>[ ] 这就是搜索引擎</li>
<li>[x] 分布式技术原理与算法解析(在线课程)</li>
<li>[ ] 推荐系统与深度学习</li>
</ul>
<h1 id="12月"><a class="markdownIt-Anchor" href="#12月"></a> 12月</h1>
<ul>
<li>[ ] Java编程的逻辑</li>
<li>[ ] 这就是搜索引擎</li>
<li>[ ] 推荐系统与深度学习</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://leriou.github.io/2018-09-30-real-time-proccess/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="哎呀是太阳嘛">
      <meta itemprop="description" content="君子生非异也, 善假于物也">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leriou's Tavern">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-09-30-real-time-proccess/" class="post-title-link" itemprop="url">初步探索实时数据处理系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-19 15:31:44" itemprop="dateCreated datePublished" datetime="2018-10-19T15:31:44+08:00">2018-10-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">系统设计</span></a>
                </span>
            </span>

          
            <span id="/2018-09-30-real-time-proccess/" class="post-meta-item leancloud_visitors" data-flag-title="初步探索实时数据处理系统" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2018-09-30-real-time-proccess/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018-09-30-real-time-proccess/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a class="markdownIt-Anchor" href="#背景"></a> 背景</h1>
<p>因为业务需要, 公司现在需要一个实时的计算平台来支撑上层的各种业务</p>
<p>借这个机会, 对我们用到的相关技术部分进行了整理</p>
<h1 id="业务场景分析"><a class="markdownIt-Anchor" href="#业务场景分析"></a> 业务场景分析</h1>
<p>下面拿我自己经历的两个项目来探讨一下实时计算平台的构建，以及其中遇到的一些坑</p>
<h1 id="业务1-统一的产品池服务"><a class="markdownIt-Anchor" href="#业务1-统一的产品池服务"></a> 业务1. 统一的产品池服务</h1>
<h2 id="需求"><a class="markdownIt-Anchor" href="#需求"></a> 需求</h2>
<h3 id="统一产品数据池"><a class="markdownIt-Anchor" href="#统一产品数据池"></a> 统一产品数据池</h3>
<p>由于公司部门比较分散,公司的不同品类的产品(在线旅游公司)分属不同的BU(Business Unit),不同部门之间不仅数据不互通, 而且使用的数据库,产品数据结构和使用的存储技术也都不相同, 数据库存储主要使用Oracle和MySQL</p>
<p>我们组的业务由于含有统一的列表页和内容服务, 所有分类产品的相关信息都需要进行聚合展示, 所以原来我们使用产品都需要根据产品品类调用不同部门提供的接口进行数据查询</p>
<p>考虑到接口性能和未来业务的增长，我们需要一个统一的产品池功能来帮助汇总所有的产品信息，向上层业务提供一个统一的最基本的产品信息查询, 之后所有组内的产品信息统统通过产品池进行获取, 这样把数据和业务进行充分解耦</p>
<p>上层业务不需要了解各种分类的产品信息的存储位置和处理逻辑,只需要从统一的产品池获取产品信息即可，同时作为基础的数据服务还需要保证服务的性能和高可用性，于是有了产品池这个项目</p>
<h2 id="组件"><a class="markdownIt-Anchor" href="#组件"></a> 组件</h2>
<p>主要涉及的中间件和服务<code>redis</code>,<code>kafka</code>,<code>storm</code>,<code>elasticsearch</code>,<code>mysql</code></p>
<h2 id="项目详情"><a class="markdownIt-Anchor" href="#项目详情"></a> 项目详情</h2>
<ol>
<li>对接各BU, 整合各BU的产品信息到统一的产品容器内(选择redis/es作为主要的对外存储容器)</li>
<li>提供统一的产品信息获取接口</li>
</ol>
<h2 id="整体结构"><a class="markdownIt-Anchor" href="#整体结构"></a> 整体结构</h2>
<p><img data-src="https://i.loli.net/2020/05/09/DOkCVIlZ7BKz16r.png" alt="productpool.jpg"></p>
<p>其中各组件的主要功能:</p>
<p><code>Redis</code>: 存储k-v结构的产品信息, 提供前台api接口的产品基础信息查询数据</p>
<p><code>Elasticsearch</code>: 提供后台和部分前台对产品的搜索功能</p>
<p><code>kafka</code>: 数据总线, 后台数据流转的核心</p>
<p><code>mysql/oracle</code>: 提供最初始的数据源</p>
<p><code>storm</code>: 产品信息计算平台</p>
<h2 id="流程图"><a class="markdownIt-Anchor" href="#流程图"></a> 流程图</h2>
<h3 id="前台api获取产品的流程"><a class="markdownIt-Anchor" href="#前台api获取产品的流程"></a> 前台api获取产品的流程</h3>
<p><img data-src="https://i.loli.net/2020/05/09/YlEnJMbQuqDXBNh.png" alt="flow1.png"></p>
<h3 id="后台构建产品的流程"><a class="markdownIt-Anchor" href="#后台构建产品的流程"></a> 后台构建产品的流程</h3>
<p><img data-src="https://i.loli.net/2020/05/09/iVF5gAlwafOmSXv.png" alt="flow2.png"></p>
<h2 id="详细步骤描述"><a class="markdownIt-Anchor" href="#详细步骤描述"></a> 详细步骤描述</h2>
<ul>
<li>
<p>定时的产品id添加: 定期进行全量的产品数据重建, 为了方便控制重建过程, 将要处理的产品id分批存入kafka中的<code>全量重建topic</code>, 也就是把批处理转化为流处理</p>
</li>
<li>
<p>失效的产品id: 当某个产品不存在于redis中时, 也会重新放入kafka的另外的<code>miss产品topic</code>中进行重建</p>
</li>
<li>
<p>当产品信息变更时候也会有对应的变更产品id入kafka的<code>变更产品topic</code>中进行重建</p>
</li>
<li>
<p>处理产品时会从以上三个产品源topic中读取需要重建的产品, 根据分类发放到<code>不同的分类topic</code>, 然后交给storm进行产品信息计算, 这部分信息只有简单的产品ID和更新类型标识</p>
</li>
<li>
<p>storm中构建失败的产品(数据库中不存在等原因), 会在redis中进行标记暂时不可用(有效期1天), 不可用的产品不会继续进行重建</p>
</li>
<li>
<p>kafka多个topic中的消息含有需要构建的 产品id和产品需要构建的内容, 也就是说可以通过消息内容格式控制构建产品的某个部分的信息(例如: 只更新产品的基本信息, 只更新价格信息, 只更新评论数,好评数等信息)</p>
</li>
<li>
<p>storm从kafka中获取消息, 进行产品的信息计算, 计算完成的信息会重新返回kafka, 同样根据产品分类发放到不同的<code>分类topic</code>, 这部分信息含有全量的产品信息数据</p>
</li>
<li>
<p>整合各个分类topic的产品计算结果, 写入redis 和 es, 并回写部分mysql表</p>
</li>
</ul>
<h2 id="产品数据更新"><a class="markdownIt-Anchor" href="#产品数据更新"></a> 产品数据更新</h2>
<p>通过<code>canal</code>监听mysql数据库的产品表数据变更, 将变更数据发给kafka中的<code>产品表日志topic</code>, 后续从kafka的<code>产品日志topic</code> ,根据数据内容解析出来产品更新事件, 封装对应的事件消息, 存入<code>产品事件topic</code></p>
<p>通过读取<code>产品事件topic</code>中的数据, 根据品类和变更内容, 向产品池<code>变更产品topic中发送</code>发送产品池信息重构需求</p>
<h2 id="经验和总结"><a class="markdownIt-Anchor" href="#经验和总结"></a> 经验和总结</h2>
<ul>
<li>为什么要分多个产品数据源topic</li>
</ul>
<ol>
<li>
<p>为了优先级考虑, 不同来源的产品对时效性要求是不同的, 但是kafka本身又做不了带有优先级的消息处理</p>
</li>
<li>
<p>不同的分类的产品的处理逻辑不同, 更新频率和数据量也不同, 提前进行分流</p>
</li>
</ol>
<ul>
<li>为什么不同分类的产品要用不同的写入topic</li>
</ul>
<ol>
<li>如果有其他业务需要使用其中某个分类的产品数据只需订阅对应的产品topic流就可以了, 免去了从全量产品流中过滤的步骤</li>
</ol>
<ul>
<li>为什么最后还要把产品信息吐会回kafka</li>
</ul>
<ol>
<li>
<p>为了统一控制写入源并做优化, 使用统一的topic存储数据可以让整个程序只有一个数据写入的源, 所有写入操作统统使用写总线来处理, 解耦了功能, 提高了可靠性, 扩展性和可维护性</p>
</li>
<li>
<p>可以对数据写入做优化, 比如:幂等处理, 批压缩写入处理, ABA问题的重写</p>
</li>
<li>
<p>为了数据重用, 因为其他部分业务组也可能需要使用产品信息, 到时候直接订阅最终的产品信息表就可以了</p>
</li>
<li>
<p>为了方便扩展, 如果将来数据量大, 出现了写入瓶颈, 只要对这一部分承担写总线功能的写入程序进行扩展就可以了</p>
</li>
</ol>
<h1 id="业务2-用户画像之用户信息完善系统"><a class="markdownIt-Anchor" href="#业务2-用户画像之用户信息完善系统"></a> 业务2. 用户画像之用户信息完善系统</h1>
<h2 id="需求-2"><a class="markdownIt-Anchor" href="#需求-2"></a> 需求</h2>
<p>这个项目是用户画像的子项目, 目的是将用户分布在不同BU的信息进行整合, 提供一份统一最完整的用户信息出来</p>
<p>同时进行一些数据清洗和数据统计</p>
<ul>
<li>对分散在各个表中的会员信息进行梳理, 整合一份相对比较完善的用户信息</li>
</ul>
<p>例如: 用户1在基本信息中填写了一份信息</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{ </span><br><span class="line">    "username":"zhang",</span><br><span class="line">    "birthday":"1990-01-01",</span><br><span class="line">    "gender":"M"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>同时用户上传了一张个人身份证, 通过解析, 身份证含有的信息是</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    "birthday":"1990-12-07",</span><br><span class="line">    "gender":"F"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>也就是说用户自己填写的信息和身份证中的信息不一致, 相同的情况可能出现在多个业务部门, 因为业务拆分各部门相互独立, 同一个用户在多个业务部门可能拥有多份不太一致的用户信息</p>
<ul>
<li>对进行过清洗的用户数据进行完善度的计算</li>
</ul>
<p>根据不同用户信息字段占有的不同分值权重, 使用完善后的用户信息, 对用户的完善度进行实时统计</p>
<ul>
<li>定期统计用户的完善度报表</li>
</ul>
<p>根据用户会员等级/地区/性别 等基本属性和 对应的销售vip客服人员进行用户信息的报表统计</p>
<h2 id="组件-2"><a class="markdownIt-Anchor" href="#组件-2"></a> 组件</h2>
<p>主要相关的组件有 <code>mysql</code>,<code>kafka</code>,<code>storm</code>,<code>hbase</code>, <code>es</code></p>
<h2 id="项目详情-2"><a class="markdownIt-Anchor" href="#项目详情-2"></a> 项目详情</h2>
<ol>
<li>对接各数据源, 根据用户身份表示整合统一的用户信息</li>
<li>统一存储用户信息</li>
</ol>
<blockquote>
<p>ps:由于部分原因, 项目的实际开发时间很短, 只有200左右的工时, 也就是一个人工作一个月, 而且大部分时间都花在内部数据问题的处理上面, 所以项目未能做到最终非常完善的程度</p>
</blockquote>
<h2 id="流程"><a class="markdownIt-Anchor" href="#流程"></a> 流程</h2>
<ol>
<li>定期的全量用户信息补全</li>
<li>用户信息变更以后触发的补全</li>
<li>用户资料补全以后进行完善度的计算</li>
<li>定期根据用户属性对用户完善度进行报表统计</li>
</ol>
<p>具体的细节跟上面产品池相似, 都是利用<code>kafka</code>的数据流转, 将需要计算的消息流到<code>storm</code>, 经过计算以后再通过<code>kafka</code> 回馈给数据库和存储</p>
<h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1>
<p>其实回顾这两个项目</p>
<p>在其中主要起作用的中间件主要是<code>kafka</code>和<code>storm</code></p>
<p><code>kafka</code> 承担了系统几乎所有的数据流转需求, 做了一个数据总线的角色, 提供了<code>事件驱动</code>,<code>ETL</code>,<code>解耦</code>等功能</p>
<p><code>storm</code> 则承担了主要的计算任务和部分数据转发功能</p>
<p>其他 <code>mysql</code>, <code>redis</code>,<code>elasticsearch</code>则一直充当数据提供方和数据使用方(业务)之间的数据桥接作用</p>
<p>这一套消息处理流程目前来看还没遇到太大的问题, 但是因为我们部门业务相对比较单一, 尚不能完全发挥这套架构的潜力</p>
<p>希望以后可以多尝试, 并进行改进</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://leriou.github.io/2018-06-06-balance/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="哎呀是太阳嘛">
      <meta itemprop="description" content="君子生非异也, 善假于物也">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leriou's Tavern">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-06-06-balance/" class="post-title-link" itemprop="url">平衡和度</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-23 09:21:00" itemprop="dateCreated datePublished" datetime="2018-08-23T09:21:00+08:00">2018-08-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%9F%E6%B4%BB%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">生活记录</span></a>
                </span>
            </span>

          
            <span id="/2018-06-06-balance/" class="post-meta-item leancloud_visitors" data-flag-title="平衡和度" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2018-06-06-balance/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018-06-06-balance/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="什么是智慧"><a class="markdownIt-Anchor" href="#什么是智慧"></a> 什么是智慧</h1>
<p>一直以来我都很认同<code>大道至简</code>的看法</p>
<p>所以我天真的认为处理世界上的所有事情肯定有一个通用的框架, 该框架应该适用于所有麻烦的事情<br>
而我们庸庸众人只需要学习这一种处事方式就能轻松应付生活,即所谓的The One Truth &nbsp;<br>
后来的我渐渐意识到,<code>世界本来就是混乱无序的</code>, 那个万能法则肯定是不存在的</p>
<blockquote>
<p>从物理学上来讲, 一个封闭的系统中, 熵(代表混乱程度)处在不断增加的状态,一味地想维持低熵状态往往需要额外的付出更多能量.同样的,如果我强行要求这个系统是有序的并且规则的,那对这个系统来说,必然需要极大的能量来维持这种状态</p>
</blockquote>
<p><strong>智慧的本质, 就是对空间和时间的理解</strong></p>
<p><img data-src="https://i.loli.net/2020/05/09/b2at6W9HpIVl4rJ.png" alt="wisdom_mindnode1.png"></p>
<p>所谓智慧, 就是能很好地平衡时间和空间, 而怎么平衡, 就涉及到度的把握</p>
<h2 id="度"><a class="markdownIt-Anchor" href="#度"></a> 度</h2>
<p><strong>度</strong>或者叫<strong>分寸</strong>, 一种抉择中的取舍<br>
我们无时无刻不在面临许多的抉择<br>
大部分的抉择都存在我们可以感知的正面和反面效果,即便看起来非常正面的行为背后也隐藏着隐忧<br>
例如:</p>
<ul>
<li>培养好的习惯是应该的, 但是好的习惯不可能一直增加. 我们的精力是有限的,我们所处的的环境也在不断改变, 根据环境调整自己习惯才是我们要做的,否则随着时间增加我们的习惯也越来越多,如果不及时调整, 你的所有时间会被积累下来的习惯完全占据</li>
</ul>
<p>一个人在待人接物方面能很好地把握分寸, 我们会说他情商高<br>
一个人在自己和外界的联系方面能很好地把握分寸, 我们会说他有品位<br>
一个人在处理冲突方面能很好地把握分寸, 我们会说他有智慧</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://leriou.github.io/2018-05-20-meizi-qingguya/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="哎呀是太阳嘛">
      <meta itemprop="description" content="君子生非异也, 善假于物也">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leriou's Tavern">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-05-20-meizi-qingguya/" class="post-title-link" itemprop="url">终于找到了魅族flow耳机的模特啦</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-05-20 00:00:00" itemprop="dateCreated datePublished" datetime="2018-05-20T00:00:00+08:00">2018-05-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%9F%E6%B4%BB%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">生活记录</span></a>
                </span>
            </span>

          
            <span id="/2018-05-20-meizi-qingguya/" class="post-meta-item leancloud_visitors" data-flag-title="终于找到了魅族flow耳机的模特啦" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2018-05-20-meizi-qingguya/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018-05-20-meizi-qingguya/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>前几天找到了我一直寻找的给魅族耳机代言的小姐姐, 微博: @青谷娅</p>
<p>我从第一眼看到这个小姐姐就觉得气质好好啊</p>
<p>从网上搜了好久都找不到个人信息</p>
<p>后来偶然间从某个摄影师处了解到这个小姐姐的微博</p>
<p>开心了好多天</p>
<h1 id="以下是美图欣赏"><a class="markdownIt-Anchor" href="#以下是美图欣赏"></a> 以下是美图欣赏</h1>
<p>魅族耳机照</p>
<p><img data-src="https://i.loli.net/2020/05/09/MHXrfROKTq7JNgS.png" alt="WX20180528-200414.png"></p>
<p><img data-src="https://i.loli.net/2020/05/09/6jiXNxMYbq8UuOe.png" alt="WX20180529-095529.png"></p>
<p>以下图片来自微博</p>
<p><img data-src="https://i.loli.net/2020/05/09/9w3e671KApZhjOk.jpg" alt="IMG_1104.JPG"></p>
<p><img data-src="https://i.loli.net/2020/05/09/MRLX5p3rikS2W74.jpg" alt="IMG_1107.JPG"></p>
<p><img data-src="https://i.loli.net/2020/05/09/sdLI9fo5q8P4miS.jpg" alt="IMG_1106.JPG"></p>
<p><img data-src="https://i.loli.net/2020/05/09/oiAJGuB9EVlxpcN.jpg" alt="IMG_1103.JPG"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://leriou.github.io/2018-03-09-woolgather-social-problem/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="哎呀是太阳嘛">
      <meta itemprop="description" content="君子生非异也, 善假于物也">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leriou's Tavern">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-03-09-woolgather-social-problem/" class="post-title-link" itemprop="url">胡思乱想-有关当前社会的一些隐忧</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-03-09 17:47:00" itemprop="dateCreated datePublished" datetime="2018-03-09T17:47:00+08:00">2018-03-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%9F%E6%B4%BB%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">生活记录</span></a>
                </span>
            </span>

          
            <span id="/2018-03-09-woolgather-social-problem/" class="post-meta-item leancloud_visitors" data-flag-title="胡思乱想-有关当前社会的一些隐忧" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2018-03-09-woolgather-social-problem/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018-03-09-woolgather-social-problem/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>我想说说我自己对当前社会的一些担忧</p>
<p>我总觉得未来的3年(2018-2020)会是我国社会的重大转折点</p>
<h1 id="人口结构的隐忧"><a class="markdownIt-Anchor" href="#人口结构的隐忧"></a> 人口结构的隐忧</h1>
<p>中国的人口老龄化加剧已经是一个无法避免的事情了</p>
<p>即便国家最近几年放开了二胎政策, 但是从数据上面看效果并不是很好</p>
<p>下面是一份部分年份的出生和死亡人数的图(单位:万人)</p>
<p><img data-src="https://i.loli.net/2020/05/09/KFjRLxNfbq9cUd5.png" alt="people-1.png"></p>
<h2 id="出生与死亡人口"><a class="markdownIt-Anchor" href="#出生与死亡人口"></a> 出生与死亡人口</h2>
<p>目前我国的人均寿命男性在74岁, 女性在77岁, 综合平均值大概在75.5岁上下</p>
<p>也就是说去年2017年, 按照平均寿命来算, 去年的大量正常死亡人口都是出生于1941年的, 假设我们预计平均寿命每5年增长一岁的话, 1946年出生的人口正常死亡时间在2023年左右,再加上一些非正常因素, 也就是说2023年左右死亡人数至少在1200万+</p>
<p>从上面的图推论, 我们有理由相信在未来10年, 中国每年的死亡人口将迅速由每年970万左右上升到每年1600万+( 深绿色曲线将沿着浅绿色曲线旧轨迹上升)</p>
<p>到2020年,1955年出生的人将步入65岁, 人到了这个阶段, 已经进入疾病高发期, 也就是说未来几年我国将新增至少5200万65岁以上的老人,这批人对养老和医疗造成的压力会很大, 我非常担忧之后医疗资源和社会资源的消耗情况</p>
<h1 id="社会影响和政策"><a class="markdownIt-Anchor" href="#社会影响和政策"></a> 社会影响和政策</h1>
<ul>
<li>对出生人口的预测</li>
</ul>
<p>回过头来看我们的出生人口, 最近几年国内出生人口持续下降, 2016-17年由于二胎政策有小幅回升, 17年1700万出生人口中,二胎占800万(这其实是一个很不好的信号)</p>
<p>当前国内的生育主力,还是1980-90年这一批人, 等到他们这一代人的生育意愿消耗完毕, 国内出生人口必然大幅下降, 因为91-96年出生人口本来就少了许多, 适龄生育人数更是大减</p>
<p>我国人口出生的第一个高峰在60年代,第二个高峰在1985-1990年,第二个人口高峰出生的人的父母就是第一次人口高峰中出生的人,理论上来说85-90这一代人的孩子将会形成第三次人口高峰,预计在2015-2022年, 但是, 我们看一下出生数据表:</p>
<p><img data-src="https://i.loli.net/2020/05/09/uHxwt5FIsrqBfGA.png" alt="people-2.png"></p>
<p>我们来看1985-1990年的出生人口分别为<code>2042,2319,2528,2457,2513,2621</code>,平均 2413万人/年</p>
<p>这一代人到了最佳生育期(24-30岁)之后对应的实际出生人口为 <code>1615,1574,1604,1635,1640,1687</code>(2009-2014),平均每年1625万人</p>
<p><strong>也就是说正常情况下, 每年2400万人的适龄生育人口对应的生育婴儿人数大概是1600万,比例大概是 3:2</strong></p>
<p>过去5年提供生育力量的主力人口就是这一批人,我们根据他们这一代人的出生人口数和生育情况可以预估未来5年的出生人口情况</p>
<p>未来5年提供生育力量的的主力人口也就是 1991-1996这几年的出生人口分别为 <code>2008,1875,1791,1647,1693,1522</code> 平均1756万人/年</p>
<p>根据3:2的比例,我们可以预测未来5年的生育人数是平均 1200万人/年</p>
<p>我们根据以上信息, 来做一个有关中国人口的预测:</p>
<p><img data-src="https://i.loli.net/2020/05/09/kP43NK5jmI8UZYJ.png" alt="people-3.png"></p>
<p><strong>预计最迟中国将在2022年迎来人口负增长!!!</strong></p>
<p><strong>最迟中国将在2022年迎来人口负增长!!!</strong></p>
<p><strong>2022年人口负增长!!!</strong></p>
<p>中国人口一旦减少, 将是一个革命性的时刻, 到时候很有可能中国将会走上一条没有人能预想到的道路</p>
<h2 id="人口老龄化的影响"><a class="markdownIt-Anchor" href="#人口老龄化的影响"></a> 人口老龄化的影响</h2>
<p><strong>人是社会的基础</strong></p>
<p>人口结构和数量的变化将会带来社会的巨大改变</p>
<p>而目前我国逐步严重的人口老龄化将会为我们的社会带来难以想象的巨大的压力</p>
<ul>
<li>公众人物的离世</li>
</ul>
<p>在2018年有很多人感叹今年是怎么了</p>
<p>一个接一个知名公众人物离世, 大家纷纷都说不喜欢2018年, 因为失去了太多喜爱的老前辈</p>
<p>其实这个现象是正常的</p>
<ol>
<li>80, 90后是新媒体的第一代受众, 这一代人开始认识比父辈更多的公众人物, 我们认识的公众人物更多</li>
<li>电视, 广播时代的前几代先驱者到现在都逐步步入老年时代, 他们普遍比我们年纪大很多, 他们在变老</li>
</ol>
<p>以后这个情况恐怕会越来越严重</p>
<p>我算一笔账, 现代网络时代每个人听说过的的公众人物进入老年人行列的少说也有 1000人</p>
<p>假设他们都在30年内相继离世, 每年是30人, 平均下来, 差不多每10天就有一个你熟知的公众人物离世</p>
<p>但是真实情况是我们每个人熟知的人远超 1000人, 他们也不一定都能长寿到100岁, 所以现实情况未来只会更糟糕</p>
<ul>
<li>未来还会有的影响</li>
</ul>
<ol>
<li>殡葬行业的需求量未来会爆增, 加上我国传统思想的影响, 行业将会迎来前所未有的机遇</li>
<li>医疗资源紧张, 成人纸尿裤一定会大卖 <sup>_</sup></li>
<li>健康保健行业的机遇, 以后大家会越来越重视健康生活, 保健品行业可能会迎来爆发期</li>
<li>旅游行业和保险行业未来也会进入一段时间的黄金时期</li>
<li>同时由于国内文化的特殊性, 老龄化还会造成教育行业的快速发展</li>
</ol>
<p>诸位注意投资</p>
<h2 id="平均寿命和养老金"><a class="markdownIt-Anchor" href="#平均寿命和养老金"></a> 平均寿命和养老金</h2>
<p>我国早期制定的养老金计划是依照平均寿命60岁制定的, 可当时的人们没有想到人类的平均寿命增长的如此之快</p>
<p>以至于旧有的养老金制度无法满足当前社会的需要, 我国养老金亏空已经是人尽皆知的事情了</p>
<p>现在年轻人生育欲望低, 未来的养老更是没有保障, 这样我估计将来怕是连这个养老金制度都会崩溃</p>
<p>养老金问题已经成为了我国一个十分重大的社会问题, 不知道未来国家会采用怎么样的方式来解决</p>
<h2 id="房价"><a class="markdownIt-Anchor" href="#房价"></a> 房价</h2>
<p>在我们的邻国日本有研究表明, 日本的房价和年轻人的生育意愿呈负相关.</p>
<p>国内现在房价如此之高,导致养孩子的成本极高, 没有一定的物质积累,年轻人怕是不敢妄谈生育</p>
<p>高房价会进一步降低年轻人的生育意愿</p>
<p>我上面对我国出生人口的预测还是太过乐观了</p>
<p>不过我同时也觉得现在房价泡沫有点偏大了, 预计未来3年(2018-2020)就会破灭, 房价就会崩盘</p>
<p>即便很多人说国家不会允许房价崩盘, 但是我想说, 房价不崩盘, 其他所有实体行业统统要崩盘, 两害相权取其轻, 相信国家会这么选择的</p>
<p>所以打算买房的朋友可以稍微等上几年</p>
<h2 id="国家未来几年可能会采取鼓励生育政策"><a class="markdownIt-Anchor" href="#国家未来几年可能会采取鼓励生育政策"></a> 国家未来几年可能会采取鼓励生育政策</h2>
<p>由于人口压力,国家未来几年一定会出台各种鼓励生育的政策</p>
<p>我在这里做一下预测, 未来几年可能会采取的政策</p>
<ol>
<li>取消多胎生育限制</li>
</ol>
<p>现在仅仅是取消了二胎的限制, 多胎依然是违法的, 未来很有可能会彻底取消生育限制, 以刺激农村乡镇人民的生育意愿</p>
<blockquote>
<p>ps: 据彭博社消息, 中国将来2018年年底取消多胎限制,消息未经官方证实</p>
</blockquote>
<ol start="2">
<li>延长退休年龄</li>
</ol>
<p>国家已经在进行这方面的政策调整了, 未来说不定会跟新加坡一样, 彻底取消退休年龄, 永不退休</p>
<ol start="3">
<li>增加女性生产福利</li>
</ol>
<p>增加女性生产福利(比如: 强制半年产假,男方陪产3个月). 不过如此一来很可能会起到其他意想不到的效果</p>
<p>比如:增加产假时长等于变相增加企业雇佣女性的成本, 没有企业愿意在同等条件下雇用女性, 导致女性工作难找, 不得不在家生孩子, 现在的欧洲已经在这么做了</p>
<ol start="4">
<li>利用媒体鼓动年轻人谈恋爱</li>
</ol>
<p>鼓励年轻人谈恋爱同事灌输多子多福的思想才是理论上的可持续发展战略</p>
<p>其他的政策都只能治标不能治本</p>
<h1 id="教育和阶级固化"><a class="markdownIt-Anchor" href="#教育和阶级固化"></a> 教育和阶级固化</h1>
<h2 id="教育周期的延长"><a class="markdownIt-Anchor" href="#教育周期的延长"></a> 教育周期的延长</h2>
<p>随着现在社会的发展, 人类掌握的知识总量呈指数发展</p>
<p>同样, 一个人从出生到达科研领域最前沿的时间也在不断增长</p>
<p>牛顿时代,一个25岁的数学系高材生就能接触到最前沿的数学理论研究, 此时的物理更是连基本的框架都没有, 这个时期人学习某种技术的周期相对较短, 一般能在25岁完成对所需基本知识的积累</p>
<p>到了现代, 哪怕你专研一个领域并且博士毕业, 都未必能接触到最前沿的研究</p>
<p>科研要突破必须先走到研究的最前沿, 但是要走到最前沿又必须有足够的知识积累, 这就导致现代人接触前沿科学的时间被大大拉长</p>
<p>以前 25-30岁的科研人员就能接触到最前沿的技术, 现在得等到40-50岁才有可能完成早起必要的知识积累, 但是4,50岁的人了, 哪还有那么多精力来搞研究, 前沿研究的迟滞会导致整个科学学科的发展变慢</p>
<p>人类的科技进步已经不可避免要出现瓶颈了</p>
<p>这种矛盾产生的原因是因为人类社会的发展太过迅速, 人类的进化速度赶不上社会的发展速度, 彼此之间不能很好的匹配</p>
<p>可能有效的解决方案</p>
<ol>
<li>领域继续细分，降低研究人员积累必要知识的负担</li>
<li>借助电脑帮助加快研究速度</li>
</ol>
<h2 id="阶级固化"><a class="markdownIt-Anchor" href="#阶级固化"></a> 阶级固化</h2>
<p><strong>社会阶层的固化是历史上每一段和平时期的主旋律</strong></p>
<p>我只说一个现象,我当年上学时候, 同学里面还有县长的孩子,教育局长的孩子.公安局副局长的孩子<br>
但是我弟弟上学的时候, 都已经很少遇到权贵子弟了, 是当任的权贵年龄偏大吗, 不是,是因为这些人的孩子早出国去了</p>
<p>大家自己富裕了, 自然就想给孩子更好地条件<br>
富者愈富, 穷者愈穷<br>
<strong>而且这是个死循环,你还不能不给孩子投入</strong><br>
我有朋友说,“有多少钱,出多少资源, 不可能什么都给孩子准备好,只能靠他自己,我当年没钱也不过来了吗”<br>
其实这种看法我是很反对的</p>
<p>现在很多小孩子你不给他报什么钢琴班,美术班,英语班, 他会的技能就比其他孩子少,小孩子们之间攀比心很重,你孩子不懂这些,没有这些,人家别的小孩子不跟你玩…<br>
别人有Switch,你没有, 别人报了绘画班,钢琴班,你没有,别人学了英语/美术,你没有, 那别人就不跟你玩…因为孩子也有圈子,圈子是由共同语言组形成的</p>
<p>你的孩子不应该拿来跟20多年前的你来比, 他的竞争对手是他的同龄人, 应该看看他们同龄人是怎么样的条件<br>
而且现在很多老师会在入学时候收集家长信息,对孩子因家庭条件施教,甚至你不给老师送红包就不在意你孩子<br>
<strong>这都是中国特色的现象,逼着你的孩子不得不拼爹</strong><br>
这几年这种现象尤为明显, 现在大家都希望把最大的投入放到孩子的教育上面, 由于教育的投入,孩子的差距也会越来越大<br>
就像&lt;&lt;名侦探柯南&gt;&gt;里面有一集说的: 政治家的儿子依然是政治家, 企业家的孩子依然是企业家, 明星的孩子依旧是明星<br>
日本已经经历过我过正在经历的阶段和遇到的诸多问题, 日本的现状我们能从中学到很多</p>
<blockquote>
<p>秦人不暇自哀，而后人哀之；后人哀之而不鉴之，亦使后人而复哀后人也。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://leriou.github.io/2018-02-08-distribute-map-reduce/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="哎呀是太阳嘛">
      <meta itemprop="description" content="君子生非异也, 善假于物也">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leriou's Tavern">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-02-08-distribute-map-reduce/" class="post-title-link" itemprop="url">学习分布式计算框架-MapReduce</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-02-08 11:07:00" itemprop="dateCreated datePublished" datetime="2018-02-08T11:07:00+08:00">2018-02-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97/" itemprop="url" rel="index"><span itemprop="name">分布式计算</span></a>
                </span>
            </span>

          
            <span id="/2018-02-08-distribute-map-reduce/" class="post-meta-item leancloud_visitors" data-flag-title="学习分布式计算框架-MapReduce" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2018-02-08-distribute-map-reduce/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018-02-08-distribute-map-reduce/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Google搜索背后的索引计算工作是搜索引擎的核心之一, Google现有的搜索引擎是基于Caffeine的增量索引系统构建的,由于谷歌的网页索引和计算数据量巨大Google发布了一种适用于超大规模数据的分布式计算模型，就是ma p-reduce，Google后续的一系列大数据计算引擎都是基于MapReduce的思想构建出来的</p>
<h1 id="mapreduce"><a class="markdownIt-Anchor" href="#mapreduce"></a> MapReduce</h1>
<p>在2004年google发布了一篇论文, 描述了google内部针对大数据处理的一种通用模式:MapReduce(简称MR)</p>
<p>MapReduce是一种编程模型,主要用来对大量的数据进行分布式处理和计算,MR的本质是对大量通用计算过程的抽象，经过谷歌工程师长期的计算经验总结，发现很多常见的数据处理任务都可以被拆分为Map和Reduce两个计算过程。MR描述的就是如何使用这两个计算过程实现常用的数据计算工作</p>
<p>论文地址:<a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/mapreduce-osdi04.pdf" target="_blank" rel="noopener">MapReduce论文</a></p>
<h2 id="从简单例子说起"><a class="markdownIt-Anchor" href="#从简单例子说起"></a> 从简单例子说起</h2>
<p>我们用一个实际的问题来描述MapReduce的思想</p>
<p>假设我们有一个文档集合©,里面包含M个文档,我们要对文档集合中的文档进行单词次数统计,统计在所有文档中的每个单词出现的次数</p>
<p>我们自然的想法就是 先统计每个文档里面的单词和出现次数， 在统计一个集合里面的所有文档的单词和出现次数，最后统计所有文档的单词和出现次数。</p>
<p>没错，这种直觉的解决方案就可以用以下MR过程描述:</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">1. 拿到文档 -&gt; map -&gt; (文档 , [("word":1)])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">这一步需要编写一个map函数， 该函数接受一个文档名和文档内容， 返回 文档内的关键词频次序列</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. 拿到 [(文档，关键词统计)] -&gt; 通过集合内的文档名 group by -&gt;  (集合 -》 [(word, 1)])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">这一步需要编写一个reduce函数，可以对[("name",value)]类型的数据按照name进行累加</span></span><br><span class="line"><span class="string">"""</span> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">map</span><span class="params">(key: string, values: string)</span> -&gt; List[(string, int)]:</span>  </span><br><span class="line">  	<span class="string">"""</span></span><br><span class="line"><span class="string">  	key: document name</span></span><br><span class="line"><span class="string">    return 该函数返回一个[("to",1),("yours",12)]这样的列表数据</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    ans = []</span><br><span class="line">    content = get_doc(key)</span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> content:</span><br><span class="line">      ans.append((word,<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> ans</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reduce</span><span class="params">(key: string, values: List)</span> -&gt; List[(string, int)]:</span> </span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    key: a word eg: "t1"</span></span><br><span class="line"><span class="string">    values: a list of counts 示例: [1,2,3]</span></span><br><span class="line"><span class="string">    return 该函数同样返回一个[("to",1),("yours",12)]的数据</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    int result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> v <span class="keyword">in</span> values:</span><br><span class="line">      result += ParseInt(v);</span><br><span class="line">    Emit(result)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="map"><a class="markdownIt-Anchor" href="#map"></a> Map</h2>
<p>Map是一个将问题分解成多个小问题为后续的分发提供基础的技术</p>
<p>Map的过程用函数来表示就是:</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">map</span><span class="params">(k,v)</span> -&gt; (k1,List&lt;v1&gt;):</span></span><br><span class="line">  <span class="comment"># map函数接收一对k,v键值对,返回一个(k1,v1&lt;list&gt;)</span></span><br><span class="line">  <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure>
<p>map函数的目的是为了将任务分割方便后续的任务合成，之所以要传入文档名字是为了在磁盘上对返回结果进行标记，标记出调用方是谁。现代化的基于内存的MR基本不需要传文档标记参数了</p>
<h2 id="reduce"><a class="markdownIt-Anchor" href="#reduce"></a> Reduce</h2>
<p>Reduce是将多个k-v pair按照相同的k进行合并的过程</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reduce</span><span class="params">(k,list[v2])</span> -&gt; (list[v3]&gt;):</span></span><br><span class="line">  <span class="comment"># reduce函数接收一个k,v1&lt;list&gt;, 返回一个v2&lt;list&gt;</span></span><br><span class="line">  <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>ps:大多数情况下map的返回结果不能直接用于reduce函数,需要特殊处理一下</p>
</blockquote>
<h2 id="过程图"><a class="markdownIt-Anchor" href="#过程图"></a> 过程图</h2>
<p>以下是一个很详细的对MongoDB中的MapReduce过程的解读图</p>
<p><img data-src="https://i.loli.net/2020/05/09/4lu5Ek2yZDi7doF.png" alt="map-reduce.png"></p>
<p>我们可以看到map函数的输入是多个被查询过滤过的文档集合,返回值是一个map对应的值列表,我们可以认为map函数式对所有符合条件的数据进行一次简单的处理</p>
<p>reduce则是将这个值列表按照key进行处理,即对map的结果进行最终结果合并操作</p>
<h2 id="代码单机版"><a class="markdownIt-Anchor" href="#代码单机版"></a> 代码(单机版)</h2>
<p>以下是使用mapreduce进行文档词频统计的示例代码</p>
<p>其中的主要代码简单解释一下</p>
<h3 id="mapreduce类"><a class="markdownIt-Anchor" href="#mapreduce类"></a> MapReduce类</h3>
<p><code>MapReduce</code>类是一个通用的MapReduce框架,理论上任意MapReduce任务都可以套用这个框架</p>
<p>要处理不同的问题我们只需要修改对应的map和reduce函数即可</p>
<p>MapReduce类接收3个参数</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">i:       要处理的数据源,格式是一个普通的字典; </span><br><span class="line">mapper:  映射函数,该函接收一个kv键值对,根据需要对每个v值进行处理,返回一个(k,v&lt;list&gt;),此处的k值并不一定是传入的k值; </span><br><span class="line">reducer: 压缩函数,接收一个(k,v&lt;list&gt;),根据需求对数据进行压缩合并;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="map函数"><a class="markdownIt-Anchor" href="#map函数"></a> map函数</h3>
<p>其中<code>get_most_common_from_text</code>使用了结巴分词插件</p>
<p>参数:</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k:"a"</span><br><span class="line">v:"The quick brown fox jumped over the lazy grey dogs."</span><br></pre></td></tr></tbody></table></figure>
<p>返回:</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  (<span class="string">"the"</span>,<span class="number">1</span>),</span><br><span class="line">  (<span class="string">"quick"</span>,<span class="number">1</span>),</span><br><span class="line">  (<span class="string">"fox"</span>,<span class="number">1</span>)</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>
<h3 id="reduce函数"><a class="markdownIt-Anchor" href="#reduce函数"></a> reduce函数</h3>
<p>参数:</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k:<span class="string">"the"</span></span><br><span class="line">v&lt;list&gt;:[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>]</span><br></pre></td></tr></tbody></table></figure>
<p>返回:</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(<span class="string">"the"</span>,<span class="number">3</span>),(<span class="string">"quick"</span>:<span class="number">1</span>)...]</span><br></pre></td></tr></tbody></table></figure>
<p>完整代码如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MapReduce</span>:</span></span><br><span class="line">    __doc__ = <span class="string">'''提供map_reduce功能'''</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">map_reduce</span><span class="params">(i, mapper, reducer)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        map_reduce方法</span></span><br><span class="line"><span class="string">        :param i: 需要MapReduce的集合</span></span><br><span class="line"><span class="string">        :param mapper: 自定义mapper方法</span></span><br><span class="line"><span class="string">        :param reducer: 自定义reducer方法</span></span><br><span class="line"><span class="string">        :return: 以自定义reducer方法的返回值为元素的一个列表</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        intermediate = []  <span class="comment"># 存放所有的(intermediate_key, intermediate_value)</span></span><br><span class="line">        <span class="keyword">for</span> (key, value) <span class="keyword">in</span> i.items():</span><br><span class="line">            intermediate.extend(mapper(key,value))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># sorted返回一个排序好的list，因为list中的元素是一个个的tuple，key设定按照tuple中第几个元素排序</span></span><br><span class="line">        <span class="comment"># groupby把迭代器中相邻的重复元素挑出来放在一起,key设定按照tuple中第几个元素为关键字来挑选重复元素</span></span><br><span class="line">        <span class="comment"># 下面的循环中groupby返回的key是intermediate_key，而group是个list，是1个或多个</span></span><br><span class="line">        <span class="comment"># 有着相同intermediate_key的(intermediate_key, intermediate_value)</span></span><br><span class="line">        groups = {}</span><br><span class="line">        <span class="keyword">for</span> key, group <span class="keyword">in</span> itertools.groupby(sorted(intermediate, key=<span class="keyword">lambda</span> im: im[<span class="number">0</span>]), key=<span class="keyword">lambda</span> x: x[<span class="number">0</span>]):</span><br><span class="line">            groups[key] = [y <span class="keyword">for</span> x, y <span class="keyword">in</span> group]</span><br><span class="line">        <span class="comment"># groups是一个字典，其key为上面说到的intermediate_key，value为所有对应intermediate_key的intermediate_value</span></span><br><span class="line">        <span class="comment"># 组成的一个列表</span></span><br><span class="line">        <span class="comment"># print(groups)</span></span><br><span class="line">        <span class="keyword">return</span> [reducer(intermediate_key, groups[intermediate_key]) <span class="keyword">for</span> intermediate_key <span class="keyword">in</span> groups]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_most_common_from_text</span><span class="params">(self,text,n = <span class="number">100</span>)</span>:</span></span><br><span class="line">        word_list = [x <span class="keyword">for</span> x <span class="keyword">in</span> jieba.cut(text) <span class="keyword">if</span> len(x) &gt;= <span class="number">2</span>]</span><br><span class="line">        <span class="keyword">return</span> Counter(word_list).most_common(n)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">map</span><span class="params">(self,k,v)</span>:</span> <span class="comment"># k:文档名, v:文档内容</span></span><br><span class="line">        <span class="keyword">return</span> self.get_most_common_from_text(v,<span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reducer</span><span class="params">(self,k,v)</span>:</span> <span class="comment"># k:词  v:词出现的次数</span></span><br><span class="line">         <span class="keyword">return</span> k, sum(v)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        </span><br><span class="line">        i = {</span><br><span class="line">            <span class="string">"a"</span>:<span class="string">"The quick brown fox jumped over the lazy grey dogs."</span>,</span><br><span class="line">            <span class="string">"b"</span>:<span class="string">"That's one small step for a man, one giant leap for mankind."</span>,</span><br><span class="line">            <span class="string">"c"</span>:<span class="string">"　　Mary had a little lamb,Its fleece was white as snow;And everywhere that Mary went,The lamb was sure to go"</span>,</span><br><span class="line">            <span class="string">"d"</span>:<span class="string">"I pledge to honor and defend you and yours above all others"</span>,</span><br><span class="line">            <span class="string">"e"</span>:<span class="string">"To share in blessings and burdens, to be your advocate, your champion"</span></span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        t = MapReduce.map_reduce(i,self.map,self.reducer)</span><br><span class="line">        print(t)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">m = test()</span><br><span class="line">m.run()</span><br></pre></td></tr></tbody></table></figure>
<h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1>
<p>MapReduce其实就是我们常说的分而治之的思想，统一了数据模型规范, 使之能适用于更广泛的数据计算</p>
<p>不过这个过程中借助了中间存储，早起因为内存价格昂贵，所以谷歌选择采用磁盘作为中间存储，后来随着技术发展，出现了spark等利用内存做数据中转的新型MR工具，但是本质还是MR的思想</p>
<p>本文提到的MR只是一个为了学习制作的简单的单机模型，真正的用MR处理大规模数据的难点往往不在map和reduce函数的编写，而在分布式集群调度和任务执行上面</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://leriou.github.io/2018-02-02-distribute-storage-gfs/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="哎呀是太阳嘛">
      <meta itemprop="description" content="君子生非异也, 善假于物也">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leriou's Tavern">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-02-02-distribute-storage-gfs/" class="post-title-link" itemprop="url">分布式文件系统-GFS学习总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-02-02 11:07:44" itemprop="dateCreated datePublished" datetime="2018-02-02T11:07:44+08:00">2018-02-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" itemprop="url" rel="index"><span itemprop="name">分布式存储</span></a>
                </span>
            </span>

          
            <span id="/2018-02-02-distribute-storage-gfs/" class="post-meta-item leancloud_visitors" data-flag-title="分布式文件系统-GFS学习总结" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2018-02-02-distribute-storage-gfs/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018-02-02-distribute-storage-gfs/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文试图解释如下问题</p>
<ol>
<li>GFS是什么，做什么用的，要解决什么问题</li>
<li>GFS是怎么解决这些问题的</li>
<li>GFS的设计有什么优点和缺点</li>
</ol>
<h1 id="gfs简介"><a class="markdownIt-Anchor" href="#gfs简介"></a> GFS简介</h1>
<p>GFS(Google File System)是谷歌开发的一个分布式文件系统, 目的是提供一个基于众多廉价服务器工作的基础层分布式的文件存储服务。</p>
<p>GFS服务的是上层的<code>Bigtable</code>, <code>Megastore</code>等上层数据库应用，所以GFS的读写基本都是其他应用的大文件批量数据读写，Google于2003年放出了GFS的设计论文。</p>
<p>论文地址 <a href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/gfs-sosp2003.pdf" target="_blank" rel="noopener">The Google File System</a></p>
<h1 id="gfs的特点"><a class="markdownIt-Anchor" href="#gfs的特点"></a> GFS的特点</h1>
<ol>
<li>仅支持文件追加操作 (适用于谷歌的爬虫数据存储需求)，文件块大小为64M (优点很多, 减少元数据量, 减低master服务器压力)</li>
<li>采用中心化的master节点管理元数据 (可能造成单点故障和性能存储瓶颈)</li>
<li>基于廉价服务器实现高容错高可用</li>
<li>控制流和数据流分离，针对当年的网络环境进行优化</li>
</ol>
<h1 id="核心组件"><a class="markdownIt-Anchor" href="#核心组件"></a> 核心组件</h1>
<p>GFS的核心服务分为三个部分，client, master 和chunkserver。</p>
<ol>
<li>
<p>Client               -&gt;  Client就是各种应用中使用GFS的客户端,以库文件的形式提供</p>
</li>
<li>
<p>MasterServer  -&gt;   MasterServer相当于对ChunkServer数据进行管理的管理者,存储整个文件传统的目录结构和文件元信息(包括Chunk分片信息和分片位置),Client从Master获取到具体的文件所在的ChunkServer的地址,然后直接与ChunkServer通信进行数据操作</p>
</li>
<li>
<p>ChunkServer  -&gt;   存储具体文件数据的服务器</p>
</li>
</ol>
<p><img data-src="https://i.loli.net/2020/05/09/jB41UqSaMQwFWZc.jpg" alt="1334712344_6225.jpg"></p>
<p>GFS采用中心化的管理方式,Client作为应用使用方,Master作为ChunkServer的管理者,ChunkServer来负责数据的存储,client与master进行交互获取控制信息,然后与对应的ChunkServer交互获取具体的数据</p>
<h1 id="内部数据管理机制"><a class="markdownIt-Anchor" href="#内部数据管理机制"></a> 内部数据管理机制</h1>
<h2 id="master数据存储"><a class="markdownIt-Anchor" href="#master数据存储"></a> Master数据存储</h2>
<p>MasterServer中存储3类信息:</p>
<ol>
<li>文件系统的命名空间,整个文件系统的目录结构和Chunk基本信息</li>
<li>文件与Chunk的映射关系</li>
<li>Chunk副本的位置信息,默认每个Chunk使用3个副本</li>
</ol>
<p>由于MasterServer采用中心化的单节点管理，所以MasterServer的内存使用和性能都是我们要关注的点:</p>
<pre><code>假设要存储1Pb的数据 MasterServer的内存使用为 
    
(1P * 64b * 3) / 64Mb = 3Gb
    
1P  : 是总数据大小
64Mb: 是每个Chunk的容量
3   : 是Chunk备份数量,默认为3
64b : 是每个Chunk的元属性所占的空间
</code></pre>
<h2 id="chunkserver存储的数据"><a class="markdownIt-Anchor" href="#chunkserver存储的数据"></a> ChunkServer存储的数据</h2>
<p>ChunkServer中存储Chunk的具体文件内容。GFS将每个Chunk限制为64M, Chunk内部又分为众多的Block，同时ChunkServer还负责进行具体每个Chunk文件的读写操作, 接受并执行每个主Chunk(租约Chunk)的指令。ChunkServer还需要定时与master进行心跳同步，上报自己的运行状态和维护的chunk信息</p>
<p>ChunkServer启动时会向MasterServer上报存储的文件信息,也会周期性的向MasterServer上报自己的服务器状态, 以此来保证master上的ChunServer信息保持更新, 并及时发现ChunkServer的故障</p>
<h2 id="负载均衡"><a class="markdownIt-Anchor" href="#负载均衡"></a> 负载均衡</h2>
<p>由于GFS是由众多的廉价服务器组成的系统，所以系统的负载问题就是十分重要。GFS会根据每个服务器的负载和最近操作数来决定新数据的分布，以保证数据分布的均匀。一般有三个基本原则</p>
<ol>
<li>同一个Chunk的多个副本不会放在同一个机架</li>
<li>ChunkServer最近操作数有一定的限制</li>
<li>优先选择磁盘负载较低的服务器</li>
</ol>
<p>第二点十分重要但时常被忽略,如果没有第二条规则限制, 很容易出现新加的机器由于负载过低导致短时间内大量数据都往这个机器上操作, 导致新添加的机器被压垮</p>
<h2 id="垃圾回收"><a class="markdownIt-Anchor" href="#垃圾回收"></a> 垃圾回收</h2>
<p>GFS采用标记回收的方式处理,删除一个文件之后,GFS并不会立即要求归还可用的物理空间,而是在元数据中将文件表示为一个不可用的隐藏名字,标记一个删除的时间戳</p>
<p>Master定时检查,文件被删除超过一定时间,Master会删除文件的元数据信息,之后在与ChunkServer交互时通知ChunkServer删除对应的Chunk信息,ChunkServer来处理后续的存储释放</p>
<p>过期的Chunk也是通过垃圾回收机制来进行删除</p>
<h2 id="文件快照"><a class="markdownIt-Anchor" href="#文件快照"></a> 文件快照</h2>
<p>一但对一个文件采取快照, GFS会通过租约机制先停止所有Chunk的写操作, 更新所有Chunk副本的引用计数</p>
<p>然后之后的写请求在执行时会copy一个Chunk副本,后续的修改都会落到新的Chunk上面</p>
<p>例如:</p>
<p>对文件 F 执行快照生成 F’ ，F在GFS中有三个Chunk: C1,C2,C3 。Master首先会回收C1,C2,C3的写租约,从而保证此时的F状态一致,然后Master复制 F的元数据生成一个新的文件 F’。</p>
<p>此时F’的 Chunk仍然指向 C1,C2,C3. 快照之前, C1,C2,C3只被一个文件引用,引用计数为1, 快照之后引用技术更新为2</p>
<p>当客户端向C3增加数据时,Master发现c3引用计数超过1,会通知ChunkServer生成新的C3’, 新的操作也会在C3’上面进行，F的Chunk映射也会更新为 C1,C2,C3’</p>
<blockquote>
<p>ps: 这个机制叫写时复制(Copy On Write)</p>
</blockquote>
<h1 id="gfs读写数据的流程"><a class="markdownIt-Anchor" href="#gfs读写数据的流程"></a> GFS读写数据的流程</h1>
<h2 id="读取流程"><a class="markdownIt-Anchor" href="#读取流程"></a> 读取流程</h2>
<p>GFS中的文件读取流程大致如下:</p>
<pre><code>1. client发送给master需要获取的文件名和偏移量(告诉服务器我要读某文件的某段数据)
2. master根据文件名查找命名空间中的文件对应的文件块id,返回对应的ChunkServer和副本的位置
3. client根据返回的ChunkServer的位置信息去对应的Chunk上面取对应的数据
</code></pre>
<blockquote>
<p>ps: client会缓存一部分的ChunkServer元信息(某个ChunkServer在某个机器上面,副本分布情况等),但并不会缓存具体的文件内容, 以此降低Master服务器的负载, ChunkServer会对服务器的请求进行校验, 当ChunkServer信息有变动时, 客户端如果使用过期的Chunk信息, 能从ChunkServer得到反馈, 重新去Master获取最新的Chunk信息</p>
</blockquote>
<p>这种读取方式的好处是client直接与chunk服务器进行数据交互，由于chunk服务器数量较多，可以同时支持极高的并行数据传输。</p>
<h2 id="数据的写"><a class="markdownIt-Anchor" href="#数据的写"></a> 数据的写</h2>
<p>GFS中写入数据的流程如下:</p>
<p><img data-src="https://i.loli.net/2020/05/09/J5EbuqjnQHvRUIf.jpg" alt="1334931385_9113.jpg"></p>
<p>master使用租约授权一个chunk副本为primary副本,执行client的写操作</p>
<ol>
<li>client需要更新一个数据块，询问master谁拥有该数据块的租约（谁是primary）；</li>
<li>master将持有租约的primary和其它副本的位置告知client，client缓存之；</li>
<li>client向所有副本传输数据，这里副本没有先后顺序，根据网络拓扑情况找出最短路径，数据从client出发沿着路径流向各个chunkserver，这个过程采用流水线（网络和存储并行）。chunkserver将数据放到LRU缓存；</li>
<li>一旦所有的副本都确定接受数据，client向primary发送写请求，primary为这个前面接受到的数据分配序列号（primary为所有的写操作分配连续的序列号表示先后顺序），并且按照顺序执行数据更新；</li>
<li>primary将写请求发送给其它副本，每个副本都按照primary确定的顺序执行更新；</li>
<li>其它副本向primary汇报操作情况；</li>
<li>primary回复client操作情况，任何副本错误都导致此次请求失败，并且此时副本处于不一致状态（写操作完成情况不一样）。client会尝试几次3到7的步骤，实在不行就只能重头来过了</li>
</ol>
<p>也就是说GFS也是使用持有租约的primary副本来进行一致性保证， 其他所有副本均按照primary确定的写入顺序执行</p>
<h1 id="故障恢复和容错机制"><a class="markdownIt-Anchor" href="#故障恢复和容错机制"></a> 故障恢复和容错机制</h1>
<h2 id="快速恢复"><a class="markdownIt-Anchor" href="#快速恢复"></a> 快速恢复</h2>
<p>GFS能使用checkpoint 文件和日志文件快速进行故障的恢复</p>
<h2 id="副本复制"><a class="markdownIt-Anchor" href="#副本复制"></a> 副本复制</h2>
<p>GFS通过副本进行数据备份， 只要一个chunk有一个副本所在的机器存活，数据就可以恢复</p>
<h2 id="matser的容错"><a class="markdownIt-Anchor" href="#matser的容错"></a> Matser的容错</h2>
<p>Master会进行远程备份，Master存储文件的信息有</p>
<ol>
<li>文件的命名空间信息(整个文件系统的目录)</li>
<li>Chunk服务器和文件名的映射关系</li>
<li>Chunk服务器的地址和副本信息</li>
</ol>
<p>对于前两种操作GFS通过操作日志提供容错,日志会被被分到远程服务器<br>
最后一种保存在ChunkServer上, 当ChunkServer跟master注册时,或者Master启动时,使用轮询的方式去ChunkServer获取元数据</p>
<h2 id="chunkserver的容错"><a class="markdownIt-Anchor" href="#chunkserver的容错"></a> ChunkServer的容错</h2>
<ol>
<li>每个Chunk默认拥有3个副本, 分布在不同的ChunkServer上面</li>
<li>ChunkServer在发送数据之前会检查block的32的校验和,如果不一致就会上报Master,Master会从其他副本进行复制,并删除出错的副本数据</li>
</ol>
<blockquote>
<p>ps：为什么是默认3个副本呢，是因为副本的分布要同时满足性能和安全性需求，也就是同一机架放两个副本，另一副本放到另一机架，平衡安全性和速度。<br>
同时三个副本正好能覆盖chunk所有的可能存在的状态，1. 正常获得租约状态 2. 租约到期，进行转换  3. 作为其他chunk的副本</p>
</blockquote>
<h1 id="其他优化的点"><a class="markdownIt-Anchor" href="#其他优化的点"></a> 其他优化的点</h1>
<ul>
<li>文件树存储</li>
</ul>
<p>由于master需要存储所有的文件树和块的对应关系，采用了前缀树进行数据压缩，大大提高了可存储数据的容量</p>
<ul>
<li>高并发热点文件的读写</li>
</ul>
<p>GFS采用副本机制和错峰控制来处理热点文件的高并发读写，同时提出了一种长效解决方案：允许客户端读取客户端数据，形成客户端链</p>
<ul>
<li>为什么要采用中心化的服务</li>
</ul>
<p>为了简化系统设计，保持灵活性</p>
<ul>
<li>读数据时候的数据流</li>
</ul>
<p>GFS写入数据的时候客户端并不是采用星型或者树形结构，同时持有多个副本的链接并向副本发送数据，而是经过了一定的拓扑优化<br>
客户端会将数据发送给离自己最近的节点s1，同时该节点会继续将数据发送给离自己最近的节点s2，没一个节点都发送给离自己最近同时又没有接受数据的节点，以其充分利用机器的带宽</p>
<blockquote>
<p>ps: 这个问题有点像旅行商问题</p>
</blockquote>
<h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1>
<ol>
<li>GFS是一个中心化的分布式文件系统, 文件的具体信息分块存储, 同一文件可能被分为多个Chunk块, 每个Chunk块有多个副本</li>
<li>Master负责文件的元数据的管理, ChunkServer负责文件具体数据的管理</li>
<li>Client读数据需要先从Matser处获取到文件的Chunk分布信息, 然后去对应的ChunkServer上取得真正的文件数据</li>
<li>Client写数据会先跟Master交互获取Chunk文件的信息, 然后向所有Chunk副本发送文件数据流, 最后向PrimaryChunk发送写入控制流, 由PrimaryChunk通知其他Chunk副本执行真正的写操作</li>
<li>GFS可以以Chunk为单位在不同机器之间调度数据分布, 还有 CheckPoint和Redo日志来处理容错性</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://leriou.github.io/2018-01-01-comic-book-2018/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="哎呀是太阳嘛">
      <meta itemprop="description" content="君子生非异也, 善假于物也">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leriou's Tavern">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-01-01-comic-book-2018/" class="post-title-link" itemprop="url">2018-追番-看书记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-01-01 00:00:00" itemprop="dateCreated datePublished" datetime="2018-01-01T00:00:00+08:00">2018-01-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%9F%E6%B4%BB%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">生活记录</span></a>
                </span>
            </span>

          
            <span id="/2018-01-01-comic-book-2018/" class="post-meta-item leancloud_visitors" data-flag-title="2018-追番-看书记录" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2018-01-01-comic-book-2018/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018-01-01-comic-book-2018/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="2018"><a class="markdownIt-Anchor" href="#2018"></a> 2018</h2>
<p>年度目标: <em>20本书以上</em></p>
<h3 id="january"><a class="markdownIt-Anchor" href="#january"></a> January</h3>
<p>Done:</p>
<ul>
<li>Book</li>
</ul>
<ul>
<li>[x] HTML5游戏开发实战</li>
<li>[x] 刻意练习</li>
<li>[ ] PRINCIPLES(原则)</li>
</ul>
<ul>
<li>Bangumi</li>
</ul>
<ul>
<li>[ ] 鬼途奇行录</li>
<li>[ ] 紫罗兰的永恒花园</li>
<li>[x] 少年锦衣卫第二季</li>
<li>[x] 画江湖之换世门生</li>
<li>[ ] 狐妖小狐娘</li>
</ul>
<p>Plan:</p>
<ul>
<li>[ ] 机器学习相关基础知识的学习</li>
</ul>
<h3 id="february"><a class="markdownIt-Anchor" href="#february"></a> February</h3>
<ul>
<li>Book</li>
</ul>
<ul>
<li>[x] 计算机组成与操作系统</li>
<li>[ ] 分布式服务架构</li>
<li>[ ] 神经网络与深度学习</li>
<li>[x] 东方快车谋杀案</li>
</ul>
<ul>
<li>Bangumi</li>
</ul>
<ul>
<li>[x] 冰菓</li>
<li>[ ] 狐妖小红娘</li>
<li>[ ] 紫罗兰的永恒花园</li>
<li>[x] Angel Beats</li>
<li>[ ] 龙王的工作</li>
</ul>
<h3 id="march"><a class="markdownIt-Anchor" href="#march"></a> March</h3>
<ul>
<li>Book</li>
</ul>
<ul>
<li>[ ] 原则</li>
<li>[ ] 月亮与六便士</li>
</ul>
<ul>
<li>Bangumi</li>
</ul>
<ul>
<li>[ ] 紫罗兰的永恒花园</li>
<li>[ ] 鬼途奇行录</li>
<li>[x] 龙王的工作</li>
</ul>
<h3 id="april"><a class="markdownIt-Anchor" href="#april"></a> April</h3>
<ul>
<li>Book</li>
</ul>
<ul>
<li>[x] 原则</li>
<li>[ ] 神经网络与深度学习</li>
<li>[ ] 大规模分布式存储系统</li>
</ul>
<ul>
<li>Bangumi</li>
</ul>
<ul>
<li>[x] 紫罗兰永恒花园</li>
<li>[ ] 鬼途奇行录</li>
<li>[ ] 一人之下</li>
<li>[ ] 狐妖小红娘</li>
</ul>
<h3 id="may"><a class="markdownIt-Anchor" href="#may"></a> May</h3>
<ul>
<li>Book</li>
</ul>
<ul>
<li>[ ] 大规模分布式存储系统</li>
<li>[ ] 分布式实时处理系统</li>
<li>[x] 神经网络与深度学习</li>
<li>[x] 月亮与六便士</li>
</ul>
<ul>
<li>Bangumi</li>
</ul>
<ul>
<li>[ ] 鬼途奇行录</li>
<li>[ ] 一人之下</li>
<li>[ ] 没关系, 是爱情啊</li>
</ul>
<h3 id="june"><a class="markdownIt-Anchor" href="#june"></a> June</h3>
<ul>
<li>Book</li>
</ul>
<ul>
<li>[x] 大规模分布式存储系统</li>
<li>[ ] 大规模分布式系统架构与设计实战</li>
</ul>
<ul>
<li>Bangumi</li>
</ul>
<ul>
<li>[x] 鬼途奇行录</li>
</ul>
<h3 id="july"><a class="markdownIt-Anchor" href="#july"></a> July</h3>
<ul>
<li>Books</li>
</ul>
<ul>
<li>[ ] 国富论</li>
</ul>
<ul>
<li>Bangumi</li>
</ul>
<ul>
<li>[ ] 海贼王</li>
</ul>
<h3 id="august"><a class="markdownIt-Anchor" href="#august"></a> August</h3>
<ul>
<li>Books</li>
</ul>
<ul>
<li>[ ] 国富论</li>
</ul>
<ul>
<li>Bangumi</li>
</ul>
<ul>
<li>[ ] 工作细胞</li>
<li>[ ] 魔道祖师</li>
</ul>
<h3 id="sep"><a class="markdownIt-Anchor" href="#sep"></a> Sep</h3>
<ul>
<li>Books</li>
</ul>
<ul>
<li>[x] 编码</li>
</ul>
<h3 id="oct"><a class="markdownIt-Anchor" href="#oct"></a> Oct</h3>
<ul>
<li>Books</li>
</ul>
<ul>
<li>[ ] 深入理解Java虚拟机</li>
</ul>
<h3 id="nov"><a class="markdownIt-Anchor" href="#nov"></a> Nov</h3>
<ul>
<li>Books</li>
</ul>
<ul>
<li>[ ] 深入理解Java虚拟机</li>
<li>[x] 大数据技术体系详解</li>
<li>[ ] Designing Data-Intensive Application</li>
<li>[x] 走向分布式(Scalability)</li>
<li>[ ] Spark大数据处理</li>
<li>[x] Spark编程指南</li>
</ul>
<h3 id="dec"><a class="markdownIt-Anchor" href="#dec"></a> Dec</h3>
<ul>
<li>Book</li>
</ul>
<ul>
<li>[ ] 深入理解Java虚拟机</li>
<li>[ ] Designing Data-Intensive Application</li>
<li>[x] kafka权威指南</li>
<li>[ ] Scala编程实战</li>
</ul>
<h2 id="统计"><a class="markdownIt-Anchor" href="#统计"></a> 统计</h2>
<p>图书:</p>
<p>读完: 11本(技术类7本, 其他4本)<br>
未完: 6本</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="哎呀是太阳嘛">
      <meta itemprop="description" content="君子生非异也, 善假于物也">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leriou's Tavern">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017-12-29-user-tag-sys-on-bitmap/" class="post-title-link" itemprop="url">使用Bitmap来存储海量用户标签系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-12-29 17:47:00" itemprop="dateCreated datePublished" datetime="2017-12-29T17:47:00+08:00">2017-12-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">系统设计</span></a>
                </span>
            </span>

          
            <span id="/2017-12-29-user-tag-sys-on-bitmap/" class="post-meta-item leancloud_visitors" data-flag-title="使用Bitmap来存储海量用户标签系统" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2017-12-29-user-tag-sys-on-bitmap/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2017-12-29-user-tag-sys-on-bitmap/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="用户标签的存储方案"><a class="markdownIt-Anchor" href="#用户标签的存储方案"></a> 用户标签的存储方案</h1>
<h1 id="背景"><a class="markdownIt-Anchor" href="#背景"></a> 背景</h1>
<p>我们在日常的工作中经常遇到这种场景</p>
<p>对一个用户添加许多的标签信息方便对用户身份进行搜索和精细化运营</p>
<blockquote>
<p>ps:本文我们不考虑用户身上的标签是怎么来的,只讨论用户已经拥有标签的情况下怎么进行存储</p>
</blockquote>
<h1 id="需求分析"><a class="markdownIt-Anchor" href="#需求分析"></a> 需求分析</h1>
<p>我们给用户做标签的目的是为了支持更加精细化的运营,算是用户画像的一部分,用户的标签来源可能跟消费,登录,浏览等记录都有关系</p>
<p>我们要做的是可以根据用户身上已经存在的标签,筛选出来符合我们需求的用户</p>
<p>我们可以在大量的标签中查找具有某一些标签的用户,或者获取某用户身上的所有标签</p>
<p>我们如果要满足以上的需求, 需要提供以下几个基本接口来方便进行数据查找</p>
<ol>
<li>查找某标签的所有用户以及非该标签的用户</li>
<li>查找某个用户身上的所有标签</li>
<li>判断某个用户是否有某个标签</li>
</ol>
<p>一般来说对以上需求,对于用户和用户身上的标签数据,如果我们采用数据库来进行存储</p>
<p>可能会采用以下方式(为了方便我们模拟了7个用户,7个标签,以下测试都基于该假数据),例如:</p>
<ol>
<li>使用字段标识标签信息</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:left">name</th>
<th style="text-align:left">vip</th>
<th style="text-align:left">mobile</th>
<th style="text-align:left">email</th>
<th style="text-align:left">male</th>
<th style="text-align:left">mac</th>
<th style="text-align:left">supervip</th>
<th style="text-align:left">lost</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">小明</td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">小花</td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">小江</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left">小红</td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:left">小九</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td style="text-align:left">小七</td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">7</td>
<td style="text-align:left">小四</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
</tr>
</tbody>
</table>
<p>或者是这样</p>
<ol start="2">
<li>使用记录标识标签信息</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:left">tag</th>
<th style="text-align:left">uid</th>
<th style="text-align:left">result</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">vip</td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">mobile</td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">email</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">male</td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">mac</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">supervip</td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">lost</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">vip</td>
<td style="text-align:left">2</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">mobile</td>
<td style="text-align:left">2</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left">email</td>
<td style="text-align:left">2</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">male</td>
<td style="text-align:left">2</td>
<td style="text-align:left">0</td>
</tr>
</tbody>
</table>
<p>以上两种方式功能上都可以达到我们想要的效果,但第一种方式在标签数量非常多的时候明显是不合适的,我们不可能给每个标签都添加一个字段,那样性能和扩展性都损失非常大</p>
<p>在上面的两个表中第二个表相当于对第一个表进行了拆分,增强了标签的扩展性.如果我们采用第二种方式存储,对于上面的需求 1,2,3 都能很好的满足</p>
<p>但是方式2依然有两个可能遇到的问题</p>
<ol>
<li>我们要查找在某一些标签的用户需要使用如下sql</li>
</ol>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    uid </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    tag_table </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    <span class="keyword">result</span> = <span class="number">1</span> </span><br><span class="line"><span class="keyword">and</span> tag <span class="keyword">in</span> (<span class="string">'vip'</span>,<span class="string">'mobile'</span>,<span class="string">'email'</span>,<span class="string">'male'</span>,<span class="string">'supervip'</span>,<span class="string">'lost'</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>这样的语句在标签数万甚至数十万的时候对性能影响会非常大</p>
<ol start="2">
<li>存储: 因为每个行记录同时标明了用户,标签,和结果, 所以其中的重复数据非常的多,对数据库存储是个极大地浪费</li>
</ol>
<h1 id="bitmap"><a class="markdownIt-Anchor" href="#bitmap"></a> Bitmap</h1>
<h2 id="bitmap的概念"><a class="markdownIt-Anchor" href="#bitmap的概念"></a> Bitmap的概念</h2>
<p>Bitmap 翻译做中文称为"位图", 其核心里面是充分利用一部分数据本身就存在的元属性(空间/位置/容量)信息,我们这李主要是使用其中的每一位的位置信息,达到使用一个信息表达两种含义的作用</p>
<p>其实就也是一种特殊的编码(coding)过程(或者叫多工(multiplex))</p>
<h2 id="解决的问题"><a class="markdownIt-Anchor" href="#解决的问题"></a> 解决的问题</h2>
<p>bitmap可以用来有效解决两类问题</p>
<ol>
<li>存储大量值可以用布尔值标识的数据</li>
<li>部分有用到交,并,差等集合运算的数据</li>
</ol>
<p>第一个特性主要是利用位存储的节省空间的特性,第二个是利用计算机位运算比较快速的特性</p>
<p>eg:</p>
<ol>
<li>
<p>以前的搜索引擎爬虫在处理网页爬取的时候需要给已经爬取过的网页做标记,避免陷入死循环的重复爬取,当时的搜索网站的爬虫就有一些采用过bitmap来给爬取过的网页做标记,大致就是取页面的url取hash,然后处理成数字,把对应的数字位置为1</p>
</li>
<li>
<p>微博里面你关注的A也关注了B, 使用B的粉丝列表和你的关注列表进行交集运算就可以了,同样 购买这件商品的人也购买了M,也可以用 购买这件商品的用户列表里面取某个用户购买过的某个商品即可</p>
</li>
</ol>
<p>以上应用确实能有效的减少数据的存储容量和提高集合计算速度, 如果我们用这种方法来存储用户标签信息也能大量减少存储容量</p>
<p>但是怎么把用户标签的表信息数据转换成bitmap形式的数据呢?</p>
<h2 id="数据处理"><a class="markdownIt-Anchor" href="#数据处理"></a> 数据处理</h2>
<p>我们如果要记录一个用户对应的一个标签的信息,假如我们知道5号用户是小九,而她是一位超级会员用户(我们可以在上面的表中查到该信息)</p>
<p>我们要如何使用bitmap来表示这条信息呢</p>
<ul>
<li>存储用户和标签的关系</li>
</ul>
<p>我们可以这样:</p>
<ol>
<li>使用一个键<code>user:supervip</code>来记录所有用户是否是超级会员的信息,这个值最初是空的字符串值,表明没有超级会员用户</li>
<li>我们为了标明 5 号用户是超级会员 可以使用这个键中对应位置的二进制位来表明会员的身份,将这个键的第 5 位置为1, 这样这个<code>user:supervip</code>值现在是’000001’(从第0位开始计算)</li>
<li>同样,如果<code>user:supervip</code>的值现在是’01001010’ 我们就可以知道 1,4,6号用户都是超级会员用户</li>
</ol>
<p>我们根据这个数据可以做到2点:</p>
<ul>
<li>
<p>我们可以根据该标签数据键的对应位置的二进制位的值来判断以该位置为id的用户的标签结果</p>
</li>
<li>
<p>也可以查询某个标签下的所有用户</p>
</li>
</ul>
<p>这样我们存储上万个标签也只需要上万个键</p>
<ul>
<li>存储所有用户</li>
</ul>
<p>但是我们如果需要查找不属于某个标签的用户怎么办啊,如果直接对上一个例子取反肯定是不行的</p>
<p>为了解决这个问题我们需要一个存储所有用户的键</p>
<p>我们知道了所有用户,知道了拥有某标签的用户</p>
<pre><code>    不含某标签的用户 = 总用户 - 含有某标签的用户
</code></pre>
<p>用二进制的操作方法就是使用<code>异或</code>, 举例:</p>
<p>我们有7个用户(编号1-7),5号用户是超级vip,我们要查找所有不是vip的用户可以使用下面的运算</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01111111</span> ^ <span class="number">00001000</span> = <span class="number">01110111</span> <span class="comment">// 127 ^ 8 = 119</span></span><br><span class="line"><span class="comment">// 01111111:所有用户的二进制键  00001000:5号用户是超级会员的键 01110111:所有不是超级会员的用户</span></span><br></pre></td></tr></tbody></table></figure>
<p>以上操作我们就能得到所有不是超级会员的用户</p>
<ul>
<li>存储某用户的所有标签</li>
</ul>
<p>我们如果要获得用户的所有标签,也可以将用户拥有的标签id在用户标签键中所对应的位置置为1,这样每一个用户的表示所有标签的键的最大位长度就是固定的,比如:</p>
<p>我们可以用如下方式存储用户的所有标签</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">usertag:all:<span class="number">1</span> =&gt; <span class="number">01101010</span>  <span class="comment">// 1号用户的所有标签</span></span><br><span class="line">usertag:all:<span class="number">5</span> =&gt; <span class="number">00010110</span>  <span class="comment">// 5号用户的所有标签</span></span><br></pre></td></tr></tbody></table></figure>
<p>这样我们就能使用bitmap来满足以上基本查询需求</p>
<p>同样我们也可以将所有标签存储成一个<code>usertag:alltag</code>键, 再使用异或运算计算某用户不含有的标签</p>
<h2 id="实现方案"><a class="markdownIt-Anchor" href="#实现方案"></a> 实现方案</h2>
<p>我们如果自己来对位运算做管理就有点麻烦了,我们可以借助<code>redis</code></p>
<p><code>redis</code>原生提供了可以对字符串进行位操作的命令,具体如下</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> SETBIT key pos value  // 将 key 的第 pos 位设为 value(只能取1/0)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> GETBIT key pos        // 获取 key 的第 pos 位的值</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> BITOP cmd key1 key2 key3 ... // 对 key2,key3 等执行 </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> BITOP AND destkey srckey1 srckey2 srckey3 ... srckeyN</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> BITOP OR destkey srckey1 srckey2 srckey3 ... srckeyN</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> BITOP XOR destkey srckey1 srckey2 srckey3 ... srckeyN</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> BITOP NOT destkey srckey</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> BITPOS key bit start end  // 将 key 的 strat 到 end 位全部设为 bit(0/1)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> BITCOUNT mykey 1 1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> BITFIELD mystring SET i8 <span class="comment">#0 100 i8 #1 200</span></span></span><br></pre></td></tr></tbody></table></figure>
<p>我们就直接使用<code>redis</code>来存储数据了,这样方便点</p>
<h2 id="预处理"><a class="markdownIt-Anchor" href="#预处理"></a> 预处理</h2>
<p>我们这边为了方便直接使用redis提供的<code>setbit</code>,<code>getbit</code>和<code>bitop</code>来进行字符串的位操作</p>
<p>因为我们要存储用户标签,所以我们首先需要对用户和标签进行编号,这样我们需要两个表</p>
<p>用户表:</p>
<table>
<thead>
<tr>
<th style="text-align:left">uid</th>
<th style="text-align:left">name</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">小明</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">小花</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">小江</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left">小红</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:left">小九</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td style="text-align:left">小七</td>
</tr>
<tr>
<td style="text-align:left">7</td>
<td style="text-align:left">小四</td>
</tr>
</tbody>
</table>
<p>标签表:</p>
<table>
<thead>
<tr>
<th style="text-align:left">tid</th>
<th style="text-align:left">name</th>
<th style="text-align:left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">vip</td>
<td style="text-align:left">是否vip</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">mobile</td>
<td style="text-align:left">是否绑定手机</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">email</td>
<td style="text-align:left">是否绑定邮箱</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left">male</td>
<td style="text-align:left">是否男性</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:left">mac</td>
<td style="text-align:left">是否使用Mac</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td style="text-align:left">supervip</td>
<td style="text-align:left">是否年费会员</td>
</tr>
<tr>
<td style="text-align:left">7</td>
<td style="text-align:left">lost</td>
<td style="text-align:left">是否易流失用户</td>
</tr>
</tbody>
</table>
<h2 id="存储"><a class="markdownIt-Anchor" href="#存储"></a> 存储</h2>
<p>我们这里为了性能考虑使用redis来进行存储</p>
<p>我们将最上面的表格数据转换成以下键值对</p>
<figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    // 所有用户</span><br><span class="line">    "user:all":{</span><br><span class="line">        <span class="string">"01111111"</span></span><br><span class="line">    },</span><br><span class="line">    // 所有vip用户</span><br><span class="line">    "user:vip":{</span><br><span class="line">        <span class="string">"01001001"</span></span><br><span class="line">    },</span><br><span class="line">    // 所有绑定了手机的用户</span><br><span class="line">    "user:mobile":{</span><br><span class="line">        <span class="string">"01101010"</span></span><br><span class="line">    },</span><br><span class="line">    // 所有绑定了邮箱的用户</span><br><span class="line">    "user:email":{</span><br><span class="line">        <span class="string">"00001010"</span></span><br><span class="line">    },</span><br><span class="line">    // 所有男性用户</span><br><span class="line">    "user:male":{</span><br><span class="line">        <span class="string">"01010011"</span></span><br><span class="line">    },</span><br><span class="line">    // 用户1的所有标签</span><br><span class="line">    "usertag:all:1":{</span><br><span class="line">        <span class="string">"01101010"</span></span><br><span class="line">    },</span><br><span class="line">    //用户2的所有标签</span><br><span class="line">    "usertag:all:2":{</span><br><span class="line">        <span class="string">"00100001"</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="查询操作"><a class="markdownIt-Anchor" href="#查询操作"></a> 查询操作</h2>
<p>我们可以使用redis的命令<code>getbit</code>来查询某个键的某个位置的值<br>
比如,我们要查询5号用户是否具有vip标签,可以使用以下命令</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ getbit user:vip <span class="number">5</span> <span class="comment">// 返回 0</span></span><br></pre></td></tr></tbody></table></figure>
<p>要查询某用户身上的所有标签可以使用如下</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ get usertag:all:<span class="number">1</span> <span class="comment">// 获取用户1的所有标签 返回'01101010'</span></span><br></pre></td></tr></tbody></table></figure>
<p>我们如果要获取某标签下的所有用户可以使用如下命令</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> get user:vip // 返回一个二进制字符串 类似 <span class="string">'01001001'</span></span></span><br></pre></td></tr></tbody></table></figure>
<p>查询不具有某个标签的用户</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> bitop xor user:not_vip user:all user:vip // 根据所有用户和具有标签的用户进行异或运算,得到不含有某标签的用户</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> get user:not_vip // 返回二进制字符串</span></span><br></pre></td></tr></tbody></table></figure>
<p>我们现在知道如何快速的获取我们想要的数据了,但是我们发现有时候我们获取到的都是二进制的数据例如 <code>00001000</code> 这种,而群殴们想从这样的数据中获取的是 <code>[5]</code> 这样的比较易读的信息</p>
<p>我们需要有一个将二进制字符串 转化为对应位置为1的位置数组的形式</p>
<p>如: function(<code>01001010</code>) =&gt; <code>[1,4,6]</code></p>
<h2 id="结果解析"><a class="markdownIt-Anchor" href="#结果解析"></a> 结果解析</h2>
<p>这里我们提供两个函数来进行这样的操作</p>
<ol>
<li>遍历法</li>
</ol>
<p>我们遍历二进制字符串中的每一位, 每遇到一个为1的位置就将该位置放入数组</p>
<p>这种方法比较慢,不建议使用,这里贴一个示例代码</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">key2array</span><span class="params">(self, key)</span>:</span>  <span class="comment"># 将二进制('\x05'-&gt;'0b00000101')变为数组[5,7], 表示第五位和第七位为1</span></span><br><span class="line">    tmpstr = <span class="string">''</span>.join([bin(i).replace(<span class="string">'0b'</span>, <span class="string">''</span>).zfill(<span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> key])</span><br><span class="line">    arr = []</span><br><span class="line">    str_len = len(tmpstr)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, str_len):</span><br><span class="line">        <span class="keyword">if</span> int(tmpstr[i]) == <span class="number">1</span>:</span><br><span class="line">            arr.append(i)</span><br><span class="line">    <span class="keyword">return</span> (arr)</span><br></pre></td></tr></tbody></table></figure>
<ol start="2">
<li>查表</li>
</ol>
<p>我们可以观察一下redis返回的二进制数据的特点, 每8个二进制位属于一个字节,每个字节都可以表示成具体的数字(如:0,23,127)这个数字最大也只能到255,而且同一个数字有可能出现非常多次,而每个数字所对应的转换过后的位置数组都是固定的,比如: 100(二进制:1100100) =&gt; [1,2,5]</p>
<p>我们可以利用这一点,提前制作一个 <code>0-255</code>的所对应的位置表,然后每次处理8位,处理完把当前处理的位数加上新表中对应的值就可以快速的得到这个值了</p>
<blockquote>
<p>ps: 我们也可以扩大这个表的容量以提高速度</p>
</blockquote>
<p>贴下示例代码:</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_bit_table</span><span class="params">(self)</span>:</span>  <span class="comment"># 生成0-255的表</span></span><br><span class="line">    arr = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">256</span>):</span><br><span class="line">        tmp_arr = []</span><br><span class="line">        tstr = bin(i).replace(<span class="string">'0b'</span>, <span class="string">''</span>).zfill(<span class="number">8</span>)</span><br><span class="line">        n = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> tstr:</span><br><span class="line">            n = n + <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> int(k) == <span class="number">1</span>:</span><br><span class="line">                tmp_arr.append(n)</span><br><span class="line">        arr.append(tmp_arr)</span><br><span class="line">    self.bit_table = arr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">key2array</span><span class="params">(self, key)</span>:</span>  <span class="comment"># 查表法</span></span><br><span class="line">    arr = []</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">        pos = self.bit_table[i]</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> pos:</span><br><span class="line">            arr.append(n + k - <span class="number">1</span>)</span><br><span class="line">        n = n + <span class="number">8</span></span><br><span class="line">    <span class="keyword">return</span> (arr)</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>ps:jdk中的BitSet就是对bitmap的一种简单实现</p>
</blockquote>
<h1 id="如果标签过于稀疏会不会浪费空间"><a class="markdownIt-Anchor" href="#如果标签过于稀疏会不会浪费空间"></a> 如果标签过于稀疏会不会浪费空间?</h1>
<p>如果我们在一个很长的bitmap中只存除了极少量的数据是不是会对空间造成浪费呢?</p>
<p>例如: 在bitmap的第40000位置为1,那存储的数据大概就类似: 00000000000…0000000001</p>
<p>这样的数据前面的39999位都是0,不会浪费空间吗</p>
<h2 id="google的ewahcompressedbitmap"><a class="markdownIt-Anchor" href="#google的ewahcompressedbitmap"></a> Google的EWAHCompressedBitmap</h2>
<p>Google的EWAHCompressedBitmap就对这种情况做了优化</p>
<p>EWAHCompressedBitmap 将整个的二进制数据分成每64位一个的word</p>
<p>一个空的Bitmap默认拥有 4 个word 也就是 <code>4*64</code> 位</p>
<p>其中 word0 存储bitmap的头信息</p>
<p>当我们改变对应位置的比特位的值时 word 会跟着变化</p>
<p>当我们插入的值非常大的时候(例如:40000), 算法会根据当前的值 创建两个新的word</p>
<p>一个用于存储第40000个数据所在的word的信息(LW), 还有一个存储跨度信息(称为:跨度word /RLW )</p>
<p>假如说我们给一个空的bitmap,我们插入40000的话正常情况下会有6个word,前4个是头信息word+3个空word,第6个中保存40000这个数字所在的位置信息,第5个word中保存从第 4-625 word的跨度信息,第626word中存储有 40000 这个数据</p>
<blockquote>
<p>ps: 第一个word存储头信息, 625 = floor( (40000 + 1) / 64 )</p>
</blockquote>
<p>存储跨度信息的word和普通的存储数据的word虽然空间一样但是存储的内容不一样,存储跨度信息的word大概内容这样</p>
<pre><code>前32位存储 `当前跨度word(RLW)横跨了多少空word`    
后32位存储 `当前跨度word(RLW)后方有多少个连续的LW`
</code></pre>
<p>当我们存储 位置在跨度word(RLW)之中的数据(例如:20000), RLW会进行分裂</p>
<p>变成3个word,中间一个存储20000所在的LW信息,前后各有一个RLW保存新的跨度信息</p>
<p>EWAHCompressedBitmap对应的maven依赖如下：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.googlecode.javaewah<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>JavaEWAH<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://leriou.github.io/2017-12-29-programming-languages-are-not-tools/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="哎呀是太阳嘛">
      <meta itemprop="description" content="君子生非异也, 善假于物也">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leriou's Tavern">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017-12-29-programming-languages-are-not-tools/" class="post-title-link" itemprop="url">程序语言不是工具</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-12-19 10:44:00" itemprop="dateCreated datePublished" datetime="2017-12-19T10:44:00+08:00">2017-12-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">计算机编程</span></a>
                </span>
            </span>

          
            <span id="/2017-12-29-programming-languages-are-not-tools/" class="post-meta-item leancloud_visitors" data-flag-title="程序语言不是工具" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2017-12-29-programming-languages-are-not-tools/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2017-12-29-programming-languages-are-not-tools/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>原作者： 王垠<br>
原文： <a href="http://www.yinwang.org/blog-cn/2013/04/21/programming-languages-are-not-tools" target="_blank" rel="noopener">http://www.yinwang.org/blog-cn/2013/04/21/programming-languages-are-not-tools</a></p>
<h1 id="程序语言不是工具"><a class="markdownIt-Anchor" href="#程序语言不是工具"></a> 程序语言不是工具</h1>
<p>在谈论到程序语言的好坏的时候，总是有人说：程序语言只是一种工具。只要你的算法好，不管用什么语言都能写出一样好的程序。在本科第一堂编程课上，我的教授就这么对我们说。可是现在我却发现，这是一个根本错误的说法。</p>
<p>我不知道这种说法确切的来源，然而昨天在浏览网页的时候，偶然发现了 C++ 的设计者 Bjarne Stroustrup 的一些类似的说法。这些说法来自于 2007 年 MIT Technology Review 对 Stroustrup 的采访。</p>
<blockquote>
<p>问：一个好的语言是什么样的？<br>
Stroustrup：所有能帮助人们表达他们的想法的东西都会让语言更好。一个语言在一个好的工匠手里应该能胜任每天的任务。语言是否优美是次要的问题。被认为是丑陋的语言开发出来的有用的系统，比优美的语言开发出来的系统要多得多。</p>
</blockquote>
<blockquote>
<p>问：优雅难道不重要吗？<br>
Stroustrup：优雅很重要，可是你如何衡量"优雅"？可以表达问题答案的最少字数？我觉得我们应该看构造出来的应用程序的优雅程度，而不是语言自身的优雅程度。就像你不能把木工的一套复杂的工具（很多是危险的工具）叫做"优雅"一样。但是我的餐桌和椅子却真的很优雅，很美。当然，如果一个语言本身也很美，那当然最好。</p>
</blockquote>
<h2 id="一些基本的错误"><a class="markdownIt-Anchor" href="#一些基本的错误"></a> 一些基本的错误</h2>
<p>对这两个回答，我都不满意，我觉得这只是他对于 C++ 的恶劣设计的借口而已。下面我对其中几个说法进行质疑：</p>
<p>所有能帮助人们表达他们的想法的东西都会让语言更好。</p>
<p>作为一个程序语言，并不是好心想”帮助人”就可以说是好的。如果是这样的话，那么我就可以把所有国家的脏话都加到你的语言里面，因为它们可以帮助我们骂人。</p>
<p>被认为是丑陋的语言开发出来的有用的系统，比优美的语言开发出来的系统要多得多。</p>
<p>系统的数量再多也不能说明这个语言好。正好相反，众多的系统由于语言的一些设计失误，把人们的生命置于危险之中，这说明了这个语言的危害性之大。一种像炸药一样的语言，用的人越多越是危险。</p>
<h2 id="语言不是工具而是材料"><a class="markdownIt-Anchor" href="#语言不是工具而是材料"></a> 语言不是工具，而是材料</h2>
<p>我这篇文章想说的最关键的部分，其实是他所支持的”语言工具论”的错误。</p>
<p>Stroustrup 说：</p>
<p>我觉得我们应该看构造出来的应用程序的优雅程度，而不是语言自身的优雅程度。就像你不能把木工的一套复杂的工具（很多是危险的工具）叫做”优雅”一样。但是我的餐桌和椅子却很优雅，很美。</p>
<p>他的言下之意就是把程序语言比作木工的工具，而餐桌也椅子就是这些工具做出来的产品。比方的威力是很大的，很多人一见到大牛给出这么形象的比方，想都不用想就接受了。如果你不仔细分析的话，这貌似一个恰当的比方，然而经过仔细推敲，这却是错误的比方。这是因为程序语言其实不是一种”工具”，而是一种”材料”。</p>
<p>木工不会把自己的锯子，墨线等东西放进餐桌和椅子里面，而程序员却需要把语言的代码放到应用程序里面。虽然这些程序经过了编译器的转化，但是程序本身却仍然带有语言的特征。这就像一种木材经过墨线和锯子的加工，仍然是同样的木材。一个 C++ 的程序在编译之后有可能产生内存泄漏和下标越界等低级错误，而更加安全的语言却不会出现这个问题。</p>
<p>所以在这个比方里面，程序语言所对应的应该是木工所用的木料，钉子和粘胶等”材料”，而不是锯子和墨线等”工具”。这些材料其实随着应用程序一起，到了用户的手里。那么对应木工工具的是什么呢？是 Emacs, vi, Eclipse, Visual Studio 等编程环境，以及各种编译器，调试器，make，界面设计工具，等等。这些真正的”工具”丑一点，真的暂时无所谓。</p>
<p>现在你还觉得程序语言的优雅程度是次要的问题吗？一个复杂而不安全的语言就像劣质的木料和粘胶。它不但会让餐桌和椅子的美观程度大打折扣，而且会造成它们结构的不牢靠，以至于威胁到用户的生命安全。同时它还可能会造成木工的工作效率低下以及工伤的产生。</p>
<p>这也许就是为什么我的一个同事说，他看 C++ 代码的时候都会带上 OSHA（美国职业安全与健康管理局）批准的护目镜。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://leriou.github.io/2017-11-02-distribute-database-share-in-group/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="哎呀是太阳嘛">
      <meta itemprop="description" content="君子生非异也, 善假于物也">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leriou's Tavern">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017-11-02-distribute-database-share-in-group/" class="post-title-link" itemprop="url">分布式服务组内分享</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-11-02 00:00:00" itemprop="dateCreated datePublished" datetime="2017-11-02T00:00:00+08:00">2017-11-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">计算机编程</span></a>
                </span>
            </span>

          
            <span id="/2017-11-02-distribute-database-share-in-group/" class="post-meta-item leancloud_visitors" data-flag-title="分布式服务组内分享" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2017-11-02-distribute-database-share-in-group/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2017-11-02-distribute-database-share-in-group/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这个是写给组内成员的分布式知识简单分享</p>
<h1 id="什么是分布式"><a class="markdownIt-Anchor" href="#什么是分布式"></a> 什么是分布式</h1>
<p>什么是集群? 什么是分布式?<br>
集群:   一个任务多个人可以做(实际是一个人做), 集群的主要目的是高可用, 通过冗余解决单点故障问题<br>
分布式: 一个任务拆分成多个部分由多个机器来做, 解决业务解耦, 水平扩展和性能问题</p>
<p>几个典型的分布式系统:</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>类型</th>
<th>数据分布方式</th>
<th>故障转移</th>
<th>节点类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>kafka</td>
<td>消息系统</td>
<td>broker-&gt;partition</td>
<td>partition选举</td>
<td>对等节点</td>
</tr>
<tr>
<td>redis</td>
<td>缓存</td>
<td>instance-&gt;shard</td>
<td>sentinal选举</td>
<td>对等节点</td>
</tr>
<tr>
<td>es</td>
<td>搜索服务</td>
<td>node-&gt;shard</td>
<td>master选举和partition选举</td>
<td>对等节点</td>
</tr>
<tr>
<td>Tidb</td>
<td>数据库</td>
<td>TiDB+TiKV+PD</td>
<td>node选举</td>
<td>非对等节点</td>
</tr>
<tr>
<td>hdfs</td>
<td>文件系统</td>
<td>namenode+datanode</td>
<td>主从</td>
<td>非对等节点</td>
</tr>
</tbody>
</table>
<blockquote>
<p>节点类型：对等节点是说节点之间功能相似，非对等节点是说节点之间功能不同，无法互相取代</p>
</blockquote>
<h1 id="分布式要解决的常见问题"><a class="markdownIt-Anchor" href="#分布式要解决的常见问题"></a> 分布式要解决的常见问题</h1>
<p>分布式要满足三个特性之二 CAP(C:一致性, P:分区容忍性, A:可用性)</p>
<ul>
<li>一致性（C）：在分布式系统中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访问同一份最新的数据副本），换句话就是说，任何时刻，所用的应用程序都能访问得到相同的数据。</li>
<li>可用性（A）：在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。（对数据更新具备高可用性），换句话就是说，任何时候，任何应用程序都可以读写数据。</li>
<li>分区容错性（P）：以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择，换句话说，系统可以跨网络分区线性的伸缩和扩展。</li>
</ul>
<p>CAP三个特性不可能同时满足, 只能同时满足两个特性<br>
对大多数的分布式应用来说 CAP中的 P 是必不可少的<br>
所以我们一般都会从CA中选取一个, 一般会选择CP 或者 AP</p>
<p>具体处理cap协议的方法如下图</p>
<p><img data-src="https://i.loli.net/2020/05/09/bO1gZiWHtFBvKj2.jpg" alt="cap.jpg"></p>
<h1 id="如何解决分区容忍性"><a class="markdownIt-Anchor" href="#如何解决分区容忍性"></a> 如何解决分区容忍性</h1>
<p>解决分区容忍性问题首先就是对数据进行分区或者叫分片</p>
<p>分区手段有很多, 但大多分两种, hash分区和线性分区 ，系统将数据分为逻辑上的几个区块, 每个区块可以在多个机器上进行自由的部署和移动。<br>
这样就做到了将数据和机器进行隔离, 可以以分片为单位在不同机器上进行数据的移动和备份，但是这样在使用数据的时候就需要从多个分片同时获取数据进行合并。<br>
如果因为某些原因， 导致某些分片所在的节点出现故障， 此时我们就认为出现了网络分区， 分区容忍性要求在此种状况下，系统依然能对外提供有效服务 。</p>
<h2 id="gossip"><a class="markdownIt-Anchor" href="#gossip"></a> Gossip</h2>
<p>使用者: Redis<br>
Gossip协议是节点将自己的数据通知给集群内所有节点的协议, 但是不能做到数据一致性<br>
Gossip只能保证可用性和分区容忍性</p>
<p>如果对数据的分片进行备份, 同时将备份分布到多个不同的网络节点上, 这样即便部分数据分区不可用, 在可容忍的范围内只要不是该分区的所有数据分片都出问题, 还是能提供正常的数据服务</p>
<p>数据分片是分布式存储的基础, 数据分片好处很多</p>
<ol>
<li>对数据分片可以使数据不受单机存储制约</li>
<li>对数据分片可以通过多分区共同协作并行处理提高性能</li>
<li>对分区数据进行冗余可以提高系统可用性</li>
</ol>
<p>但是数据分片和副本会带来一致性问题</p>
<h1 id="如何保证数据一致性"><a class="markdownIt-Anchor" href="#如何保证数据一致性"></a> 如何保证数据一致性</h1>
<h2 id="单节点的数据一致性"><a class="markdownIt-Anchor" href="#单节点的数据一致性"></a> 单节点的数据一致性</h2>
<p>单节点如何保证数据一致性和完整性</p>
<p>比如: 数据库索引的更新, B树在分裂过程中出现问题怎么办,</p>
<p>一般处理单节点的一致性可以用 WAL(预写日志,或者叫redo日志) 或者 写时复制(copy on write)</p>
<p>WAL就是先把操作追加到一个日志文件, 然后再对内存进行操作, lsm树中的memtable就是典型的使用这种方案</p>
<p>写时复制就是先在其他地方把数据处理完毕, 最后直接修改数据引用, gfs的快照技术有使用类似的方案</p>
<p>典型的例子是 修改B+树时预先生成一个小的B+树, 然后直接替换B+树上的节点指针</p>
<h2 id="分布式的一致性"><a class="markdownIt-Anchor" href="#分布式的一致性"></a> 分布式的一致性</h2>
<h3 id="主从一致性"><a class="markdownIt-Anchor" href="#主从一致性"></a> 主从一致性</h3>
<p>目前业界的普遍做法是将分区的多个副本形成一个小组, 组内选举一个primary副本来执行写操作或确定写入顺序, 其他副本仅提供读操作或根本只提供备份功能, 这样对外部系统只有一个主副本做写入操作, 就可以保证数据写入的一致性</p>
<p>如何从多个副本集合中选举主副本就涉及到共识算法（选主算法），常见的共识算法有 <code>Paxos</code>,<code>Raft</code>,<code>Zab协议</code>,<code>Bully</code> 等</p>
<h3 id="nrw算法"><a class="markdownIt-Anchor" href="#nrw算法"></a> NRW算法</h3>
<p>NRW是一种特殊的保障一致性的算法, 通过饱和读取策略充分保证数据读取的一致性，具体详情如下:</p>
<pre><code>R(读取分片数) + W(写入分片数) &gt; N(节点总分片数)
</code></pre>
<p>只要满足以上公式, 我们必然可以拿到一个正确分片的数据<br>
举例: 我们对某个数据有5个分片, 我们只要保证 写入分片为3,读取分片为3,这样,我们必然可以保证读取的分片其中有一个含有最新的数据</p>
<h1 id="如何处理可用性"><a class="markdownIt-Anchor" href="#如何处理可用性"></a> 如何处理可用性</h1>
<p>实现高可用一般都是通过节点或数据备份来实现, 采用主从或主备节点, 主节点或主分片不可用, 就采用副本分片或备份节点替代原有的服务</p>
<h1 id="分布式事务"><a class="markdownIt-Anchor" href="#分布式事务"></a> 分布式事务</h1>
<p>解决分布式事物要处理ACID 四个问题，常用如下方式</p>
<ol>
<li>2PC, 使用者: mysql, 两阶段提交协议</li>
<li>3PC, 三阶段提交协议, 二阶段提交协议的优化</li>
<li>TCC  事务补偿</li>
</ol>
<h1 id="使用经验"><a class="markdownIt-Anchor" href="#使用经验"></a> 使用经验</h1>
<h3 id="如何设置合理的分区和副本数量"><a class="markdownIt-Anchor" href="#如何设置合理的分区和副本数量"></a> 如何设置合理的分区和副本数量</h3>
<ol>
<li>其实对于副本数量的设置一般取决于副本的用途</li>
</ol>
<p>如果你副本只做备份，不对外提供读取服务，那设置3个是比较理想的情况，因为3个副本足以覆盖副本所有的可能状态（可用，不可用，升级中），也就是说只要有3个副本， 就一定有一个副本处于可用状态</p>
<p>如果副本同时提供读功能， 那可以根据情况酌情增加副本数量</p>
<ol start="2">
<li>分片的设置</li>
</ol>
<p>其实针对不同的系统，不通的分片方式，分片设置有各自的考虑，不过一般受以下因素影响</p>
<ul>
<li>数据量</li>
<li>分布节点数量</li>
<li>使用者数量</li>
<li>数据同步和网络开销</li>
</ul>
<p>我们以一个服务于全国的500万用户的15个节点的存储容量为5TB的es集群来举例子。<br>
我们可以设置 3个副本，15-30个分片。副本数太多会增加集群同步的成本，副本数太少会导致数据不安全，读性能较差，分片太多会增加后期数据合并的成本，分片太少会导致单个分片数据量过大。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">…</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">哎呀是太阳嘛</p>
  <div class="site-description" itemprop="description">君子生非异也, 善假于物也</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">52</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/leriou" title="GitHub → https://github.com/leriou" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/1985364641" title="Weibo → https://weibo.com/1985364641" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/yange1876" title="Twitter → https://twitter.com/yange1876" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  © 2015 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">哎呀是太阳嘛</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> &amp; <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  
  














  




  














  

  
      



  






<script src="/bundle.js"></script><script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'd3Ferur4FUri7vERAylGpome-gzGzoHsz',
      appKey     : 'uRGeMnmfAq6h88QavSUfpS3q',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '11' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script></body></html>